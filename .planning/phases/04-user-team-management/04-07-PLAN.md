---
phase: 04-user-team-management
plan: 07
type: execute
wave: 3
depends_on: ["04-03", "04-04"]
files_modified:
  - apps/web/src/pages/UserProfilePage.tsx
  - apps/web/src/components/user/UserProfile.tsx
  - apps/web/src/components/user/SkillBadges.tsx
  - apps/web/src/components/user/QualityStats.tsx
  - apps/web/src/hooks/useUser.ts
  - apps/web/src/hooks/index.ts
  - apps/web/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User profile page displays all profile fields"
    - "Skills show as chips with status indicator"
    - "Quality metrics display as stats cards"
    - "Users can edit their own profile"
  artifacts:
    - path: "apps/web/src/pages/UserProfilePage.tsx"
      provides: "User profile page component"
      min_lines: 100
    - path: "apps/web/src/components/user/SkillBadges.tsx"
      provides: "Skill chips with status colors"
      exports: ["SkillBadges"]
  key_links:
    - from: "apps/web/src/pages/UserProfilePage.tsx"
      to: "/api/v1/users/{id}"
      via: "fetch user data"
      pattern: "useUser"
---

<objective>
Create user profile page with detailed information, skills display, and quality metrics.

Purpose: Allow users to view profiles with academic directory-style detail, including skills with expiration status and quality stats.
Output: User profile page and supporting components.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-user-team-management/04-CONTEXT.md
@apps/web/src/App.tsx
@packages/types/src/generated.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user data hooks</name>
  <files>apps/web/src/hooks/useUser.ts, apps/web/src/hooks/index.ts</files>
  <action>
First, run typeshare to generate updated TypeScript types from Rust domain:
```bash
cd /Users/parthpatel/Documents/projects/glyph
# Use project's typeshare command or:
cargo run -p typeshare-cli -- --lang typescript libs/domain/src packages/types/src/generated.ts
```

Create apps/web/src/hooks/useUser.ts:
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

const API_BASE = '/api/v1';

// Types (should match generated types, define inline if not available)
export interface UserDetailResponse {
  user_id: string;
  email: string;
  display_name: string;
  status: string;
  timezone: string | null;
  department: string | null;
  bio: string | null;
  avatar_url: string | null;
  contact_info: ContactInfo | null;
  global_role: string;
  quality_profile: QualityProfileResponse;
  skills: UserSkillResponse[];
  created_at: string;
  updated_at: string;
}

export interface ContactInfo {
  phone: string | null;
  slack_handle: string | null;
  office_location: string | null;
}

export interface QualityProfileResponse {
  overall_score: number | null;
  accuracy_score: number | null;
  consistency_score: number | null;
  speed_percentile: number | null;
  total_annotations: number;
  approved_annotations: number;
  rejected_annotations: number;
}

export interface UserSkillResponse {
  certification_id: string;
  skill_id: string;
  skill_name: string;
  proficiency_level: string | null;
  certified_by: string | null;
  certified_at: string;
  expires_at: string | null;
  status: string;
}

export interface UpdateUserRequest {
  display_name?: string;
  timezone?: string;
  department?: string;
  bio?: string;
  avatar_url?: string;
  contact_info?: ContactInfo;
}

export function useUser(userId: string) {
  return useQuery({
    queryKey: ['user', userId],
    queryFn: async (): Promise<UserDetailResponse> => {
      const res = await fetch(`${API_BASE}/users/${userId}`, {
        credentials: 'include',
      });
      if (!res.ok) {
        throw new Error(`Failed to fetch user: ${res.status}`);
      }
      return res.json();
    },
    enabled: !!userId,
  });
}

export function useCurrentUser() {
  return useQuery({
    queryKey: ['currentUser'],
    queryFn: async (): Promise<UserDetailResponse> => {
      const res = await fetch(`${API_BASE}/auth/me`, {
        credentials: 'include',
      });
      if (!res.ok) {
        throw new Error(`Failed to fetch current user: ${res.status}`);
      }
      return res.json();
    },
  });
}

export function useUpdateUser(userId: string) {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (data: UpdateUserRequest): Promise<UserDetailResponse> => {
      const res = await fetch(`${API_BASE}/users/${userId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.detail || 'Failed to update user');
      }
      return res.json();
    },
    onSuccess: (data) => {
      queryClient.setQueryData(['user', userId], data);
      // Also update currentUser if it's the same user
      const currentUser = queryClient.getQueryData<UserDetailResponse>(['currentUser']);
      if (currentUser?.user_id === userId) {
        queryClient.setQueryData(['currentUser'], data);
      }
    },
  });
}

export function useUserSkills(userId: string) {
  return useQuery({
    queryKey: ['user', userId, 'skills'],
    queryFn: async (): Promise<UserSkillResponse[]> => {
      const res = await fetch(`${API_BASE}/users/${userId}/skills`, {
        credentials: 'include',
      });
      if (!res.ok) {
        throw new Error(`Failed to fetch skills: ${res.status}`);
      }
      return res.json();
    },
    enabled: !!userId,
  });
}
```

Create or update apps/web/src/hooks/index.ts:
```typescript
export * from './useUser';
```
  </action>
  <verify>`pnpm typecheck` in apps/web passes. Hooks compile with correct types.</verify>
  <done>User data hooks created with TanStack Query</done>
</task>

<task type="auto">
  <name>Task 2: Create skill badges and quality stats components</name>
  <files>apps/web/src/components/user/SkillBadges.tsx, apps/web/src/components/user/QualityStats.tsx, apps/web/src/components/user/index.ts</files>
  <action>
Create directory apps/web/src/components/user/ if it doesn't exist.

Create apps/web/src/components/user/SkillBadges.tsx:
```typescript
import React, { useState } from 'react';
import type { UserSkillResponse } from '../../hooks/useUser';

interface SkillBadgesProps {
  skills: UserSkillResponse[];
}

const statusColors: Record<string, string> = {
  active: 'bg-green-100 text-green-800 border-green-200',
  soft_expired: 'bg-yellow-100 text-yellow-800 border-yellow-200',
  hard_expired: 'bg-red-100 text-red-800 border-red-200',
  never_expires: 'bg-blue-100 text-blue-800 border-blue-200',
};

const statusLabels: Record<string, string> = {
  active: 'Active',
  soft_expired: 'Expiring Soon',
  hard_expired: 'Expired',
  never_expires: 'Permanent',
};

export function SkillBadges({ skills }: SkillBadgesProps) {
  const [selectedSkill, setSelectedSkill] = useState<UserSkillResponse | null>(null);

  if (!skills.length) {
    return (
      <p className="text-gray-500 text-sm">No skills certified yet.</p>
    );
  }

  return (
    <>
      <div className="flex flex-wrap gap-2">
        {skills.map((skill) => (
          <button
            key={skill.certification_id}
            onClick={() => setSelectedSkill(skill)}
            className={`
              inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
              border transition-colors hover:opacity-80 cursor-pointer
              ${statusColors[skill.status] || statusColors.active}
            `}
            title={`${skill.skill_name} - ${statusLabels[skill.status] || skill.status}`}
          >
            <span>{skill.skill_name}</span>
            {skill.proficiency_level && (
              <span className="ml-1 text-xs opacity-75">
                ({skill.proficiency_level})
              </span>
            )}
          </button>
        ))}
      </div>

      {/* Skill Detail Modal */}
      {selectedSkill && (
        <div 
          className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
          onClick={() => setSelectedSkill(null)}
        >
          <div 
            className="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-xl"
            onClick={(e) => e.stopPropagation()}
          >
            <h3 className="text-lg font-semibold mb-4">{selectedSkill.skill_name}</h3>
            
            <dl className="space-y-3 text-sm">
              <div className="flex justify-between">
                <dt className="text-gray-500">Status</dt>
                <dd className={`px-2 py-0.5 rounded ${statusColors[selectedSkill.status]}`}>
                  {statusLabels[selectedSkill.status] || selectedSkill.status}
                </dd>
              </div>
              
              {selectedSkill.proficiency_level && (
                <div className="flex justify-between">
                  <dt className="text-gray-500">Proficiency</dt>
                  <dd className="font-medium">{selectedSkill.proficiency_level}</dd>
                </div>
              )}
              
              <div className="flex justify-between">
                <dt className="text-gray-500">Certified</dt>
                <dd>{new Date(selectedSkill.certified_at).toLocaleDateString()}</dd>
              </div>
              
              {selectedSkill.expires_at && (
                <div className="flex justify-between">
                  <dt className="text-gray-500">Expires</dt>
                  <dd>{new Date(selectedSkill.expires_at).toLocaleDateString()}</dd>
                </div>
              )}
            </dl>
            
            <button
              onClick={() => setSelectedSkill(null)}
              className="mt-6 w-full py-2 bg-gray-100 hover:bg-gray-200 rounded transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      )}
    </>
  );
}
```

Create apps/web/src/components/user/QualityStats.tsx:
```typescript
import React from 'react';
import type { QualityProfileResponse } from '../../hooks/useUser';

interface QualityStatsProps {
  profile: QualityProfileResponse;
}

export function QualityStats({ profile }: QualityStatsProps) {
  const approvalRate = profile.total_annotations > 0
    ? Math.round((profile.approved_annotations / profile.total_annotations) * 100)
    : null;

  const stats = [
    {
      label: 'Total Annotations',
      value: profile.total_annotations.toLocaleString(),
      color: 'text-blue-600',
    },
    {
      label: 'Approved',
      value: profile.approved_annotations.toLocaleString(),
      color: 'text-green-600',
    },
    {
      label: 'Rejected',
      value: profile.rejected_annotations.toLocaleString(),
      color: 'text-red-600',
    },
    {
      label: 'Approval Rate',
      value: approvalRate !== null ? `${approvalRate}%` : 'N/A',
      color: 'text-purple-600',
    },
  ];

  return (
    <div className="space-y-4">
      {/* Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        {stats.map((stat) => (
          <div
            key={stat.label}
            className="bg-gray-50 rounded-lg p-4 text-center"
          >
            <p className={`text-2xl font-bold ${stat.color}`}>
              {stat.value}
            </p>
            <p className="text-sm text-gray-500 mt-1">{stat.label}</p>
          </div>
        ))}
      </div>
      
      {/* Overall Score Bar */}
      {profile.overall_score !== null && (
        <div className="bg-gray-50 rounded-lg p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm text-gray-500">Quality Score</span>
            <span className="text-lg font-semibold">
              {(profile.overall_score * 100).toFixed(1)}%
            </span>
          </div>
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="bg-green-500 h-2 rounded-full transition-all duration-300"
              style={{ width: `${profile.overall_score * 100}%` }}
            />
          </div>
        </div>
      )}

      {/* Additional scores if available */}
      {(profile.accuracy_score !== null || profile.consistency_score !== null) && (
        <div className="grid grid-cols-2 gap-4">
          {profile.accuracy_score !== null && (
            <div className="bg-gray-50 rounded-lg p-3">
              <p className="text-sm text-gray-500">Accuracy</p>
              <p className="text-xl font-semibold">{(profile.accuracy_score * 100).toFixed(1)}%</p>
            </div>
          )}
          {profile.consistency_score !== null && (
            <div className="bg-gray-50 rounded-lg p-3">
              <p className="text-sm text-gray-500">Consistency</p>
              <p className="text-xl font-semibold">{(profile.consistency_score * 100).toFixed(1)}%</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

Create apps/web/src/components/user/index.ts:
```typescript
export { SkillBadges } from './SkillBadges';
export { QualityStats } from './QualityStats';
```
  </action>
  <verify>Components compile without TypeScript errors.</verify>
  <done>Skill badges and quality stats components created</done>
</task>

<task type="auto">
  <name>Task 3: Create user profile page with edit capability</name>
  <files>apps/web/src/pages/UserProfilePage.tsx, apps/web/src/App.tsx</files>
  <action>
Create apps/web/src/pages/UserProfilePage.tsx:
```typescript
import React, { useState } from 'react';
import { useParams } from 'react-router-dom';
import { useUser, useUpdateUser, useCurrentUser, type UpdateUserRequest } from '../hooks/useUser';
import { SkillBadges, QualityStats } from '../components/user';

export function UserProfilePage() {
  const { userId } = useParams<{ userId: string }>();
  const { data: user, isLoading, error } = useUser(userId!);
  const { data: currentUser } = useCurrentUser();
  const updateUser = useUpdateUser(userId!);
  
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState<UpdateUserRequest>({});
  
  const canEdit = currentUser?.user_id === userId || currentUser?.global_role === 'admin';
  
  if (isLoading) {
    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="animate-pulse">
          <div className="flex gap-6 mb-8">
            <div className="w-24 h-24 bg-gray-200 rounded-full" />
            <div className="flex-1 space-y-3">
              <div className="h-8 bg-gray-200 rounded w-1/3" />
              <div className="h-4 bg-gray-200 rounded w-1/4" />
            </div>
          </div>
        </div>
      </div>
    );
  }
  
  if (error || !user) {
    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
          Failed to load user profile. Please try again.
        </div>
      </div>
    );
  }
  
  const handleSave = async () => {
    try {
      await updateUser.mutateAsync(editForm);
      setIsEditing(false);
      setEditForm({});
    } catch (err) {
      console.error('Failed to save:', err);
    }
  };
  
  const handleCancel = () => {
    setIsEditing(false);
    setEditForm({});
  };
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      {/* Header with avatar and name */}
      <div className="flex items-start gap-6 mb-8">
        <div className="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-3xl font-bold text-gray-500 flex-shrink-0">
          {user.avatar_url ? (
            <img 
              src={user.avatar_url} 
              alt={user.display_name} 
              className="w-full h-full rounded-full object-cover" 
            />
          ) : (
            user.display_name.charAt(0).toUpperCase()
          )}
        </div>
        
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-3 flex-wrap">
            <h1 className="text-2xl font-bold truncate">{user.display_name}</h1>
            <span className={`px-2 py-1 text-xs rounded ${
              user.global_role === 'admin' 
                ? 'bg-purple-100 text-purple-800' 
                : 'bg-gray-100 text-gray-600'
            }`}>
              {user.global_role}
            </span>
            <span className={`px-2 py-1 text-xs rounded ${
              user.status === 'active'
                ? 'bg-green-100 text-green-800'
                : 'bg-gray-100 text-gray-600'
            }`}>
              {user.status}
            </span>
          </div>
          <p className="text-gray-600 mt-1">{user.email}</p>
          {user.department && (
            <p className="text-gray-500 text-sm mt-1">{user.department}</p>
          )}
          {user.timezone && (
            <p className="text-gray-400 text-sm mt-1">Timezone: {user.timezone}</p>
          )}
          
          {canEdit && !isEditing && (
            <button
              onClick={() => setIsEditing(true)}
              className="mt-3 text-sm text-blue-600 hover:underline"
            >
              Edit Profile
            </button>
          )}
        </div>
      </div>
      
      {/* Edit form */}
      {isEditing && (
        <div className="bg-gray-50 rounded-lg p-6 mb-8">
          <h2 className="text-lg font-semibold mb-4">Edit Profile</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Display Name
              </label>
              <input
                type="text"
                defaultValue={user.display_name}
                onChange={(e) => setEditForm(f => ({ ...f, display_name: e.target.value }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Department
              </label>
              <input
                type="text"
                defaultValue={user.department || ''}
                onChange={(e) => setEditForm(f => ({ ...f, department: e.target.value || undefined }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Timezone
              </label>
              <input
                type="text"
                defaultValue={user.timezone || ''}
                onChange={(e) => setEditForm(f => ({ ...f, timezone: e.target.value || undefined }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="e.g., America/New_York"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Avatar URL
              </label>
              <input
                type="url"
                defaultValue={user.avatar_url || ''}
                onChange={(e) => setEditForm(f => ({ ...f, avatar_url: e.target.value || undefined }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                placeholder="https://..."
              />
            </div>
            
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Bio
              </label>
              <textarea
                defaultValue={user.bio || ''}
                onChange={(e) => setEditForm(f => ({ ...f, bio: e.target.value || undefined }))}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                rows={3}
                placeholder="Tell us about yourself..."
              />
            </div>
          </div>
          
          {updateUser.error && (
            <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">
              {updateUser.error.message}
            </div>
          )}
          
          <div className="flex gap-3 mt-4">
            <button
              onClick={handleSave}
              disabled={updateUser.isPending}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {updateUser.isPending ? 'Saving...' : 'Save Changes'}
            </button>
            <button
              onClick={handleCancel}
              disabled={updateUser.isPending}
              className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50"
            >
              Cancel
            </button>
          </div>
        </div>
      )}
      
      {/* Bio section */}
      {user.bio && !isEditing && (
        <section className="mb-8">
          <h2 className="text-lg font-semibold mb-3">About</h2>
          <p className="text-gray-700 whitespace-pre-wrap">{user.bio}</p>
        </section>
      )}
      
      {/* Contact info */}
      {user.contact_info && (user.contact_info.phone || user.contact_info.slack_handle || user.contact_info.office_location) && (
        <section className="mb-8">
          <h2 className="text-lg font-semibold mb-3">Contact</h2>
          <dl className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {user.contact_info.phone && (
              <div>
                <dt className="text-sm text-gray-500">Phone</dt>
                <dd className="font-medium">{user.contact_info.phone}</dd>
              </div>
            )}
            {user.contact_info.slack_handle && (
              <div>
                <dt className="text-sm text-gray-500">Slack</dt>
                <dd className="font-medium">{user.contact_info.slack_handle}</dd>
              </div>
            )}
            {user.contact_info.office_location && (
              <div>
                <dt className="text-sm text-gray-500">Office</dt>
                <dd className="font-medium">{user.contact_info.office_location}</dd>
              </div>
            )}
          </dl>
        </section>
      )}
      
      {/* Skills section */}
      <section className="mb-8">
        <h2 className="text-lg font-semibold mb-3">Skills & Certifications</h2>
        <SkillBadges skills={user.skills} />
      </section>
      
      {/* Quality metrics section */}
      <section className="mb-8">
        <h2 className="text-lg font-semibold mb-3">Quality Metrics</h2>
        <QualityStats profile={user.quality_profile} />
      </section>
      
      {/* Metadata footer */}
      <footer className="text-sm text-gray-400 border-t pt-4">
        <p>Member since {new Date(user.created_at).toLocaleDateString()}</p>
        <p>Last updated {new Date(user.updated_at).toLocaleDateString()}</p>
      </footer>
    </div>
  );
}
```

Update apps/web/src/App.tsx to add route:
```typescript
import React from 'react';
import { Routes, Route } from 'react-router-dom';

// Pages
import { HomePage } from './pages/HomePage';
import { ProjectsPage } from './pages/ProjectsPage';
import { TasksPage } from './pages/TasksPage';
import { AnnotatePage } from './pages/AnnotatePage';
import { UserProfilePage } from './pages/UserProfilePage';

export function App(): React.ReactElement {
  return (
    <div className="app">
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/projects" element={<ProjectsPage />} />
        <Route path="/projects/:projectId/tasks" element={<TasksPage />} />
        <Route path="/annotate/:taskId" element={<AnnotatePage />} />
        <Route path="/users/:userId" element={<UserProfilePage />} />
      </Routes>
    </div>
  );
}
```
  </action>
  <verify>`pnpm build` in apps/web succeeds. Navigate to /users/{id} shows profile page.</verify>
  <done>User profile page with edit capability complete</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds in apps/web
- `pnpm typecheck` passes
- /users/{userId} route shows user profile
- Skills display as colored chips based on status (green=active, yellow=expiring, red=expired, blue=permanent)
- Clicking skill shows detail modal with dates
- Quality stats display as cards with counts and percentages
- Edit button appears for own profile or admin
- Profile updates save successfully and UI reflects changes
- Loading and error states display appropriately
</verification>

<success_criteria>
- User profile displays all fields (name, email, department, bio, timezone, contact info)
- Skills show as chips with status-based colors
- Quality metrics show annotation stats and scores
- Users can edit their own profiles
- Admins can edit any profile
- Changes persist via API and update UI optimistically
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-team-management/04-07-SUMMARY.md`
</output>
