---
phase: 04-user-team-management
plan: 08
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - apps/web/src/pages/admin/UsersPage.tsx
  - apps/web/src/components/admin/UserTable.tsx
  - apps/web/src/components/admin/BulkActions.tsx
  - apps/web/src/hooks/useUsers.ts
  - apps/web/src/App.tsx
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "Admin can view paginated user list"
    - "Admin can select multiple users for bulk operations"
    - "Admin can create new users"
    - "Admin can change user status (activate/deactivate)"
  artifacts:
    - path: "apps/web/src/pages/admin/UsersPage.tsx"
      provides: "Admin user management page"
      min_lines: 80
    - path: "apps/web/src/components/admin/UserTable.tsx"
      provides: "Data table with selection and sorting"
      exports: ["UserTable"]
  key_links:
    - from: "apps/web/src/pages/admin/UsersPage.tsx"
      to: "/api/v1/users"
      via: "fetch and mutate users"
      pattern: "useUsers"
---

<objective>
Create admin user management interface with data table and bulk operations.

Purpose: Enable administrators to manage users efficiently with multi-select, bulk status changes, and user creation.
Output: Admin users page with TanStack Table integration.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-user-team-management/04-CONTEXT.md
@.planning/phases/04-user-team-management/04-RESEARCH.md
@apps/web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TanStack Table and create users list hook</name>
  <files>apps/web/package.json, apps/web/src/hooks/useUsers.ts</files>
  <action>
Install TanStack Table:
```bash
cd apps/web && pnpm add @tanstack/react-table
```

Create apps/web/src/hooks/useUsers.ts:
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

const API_BASE = '/api/v1';

// Types
export interface UserSummary {
  user_id: string;
  email: string;
  display_name: string;
  status: string;
  global_role: string;
  department: string | null;
}

export interface UserListResponse {
  items: UserSummary[];
  total: number;
  limit: number;
  offset: number;
}

export interface CreateUserRequest {
  email: string;
  display_name: string;
  department?: string;
  timezone?: string;
  global_role?: string;
}

interface UseUsersParams {
  limit?: number;
  offset?: number;
}

export function useUsers(params: UseUsersParams = {}) {
  const { limit = 20, offset = 0 } = params;
  
  return useQuery({
    queryKey: ['users', { limit, offset }],
    queryFn: async (): Promise<UserListResponse> => {
      const res = await fetch(`${API_BASE}/users?limit=${limit}&offset=${offset}`, {
        credentials: 'include',
      });
      if (!res.ok) {
        throw new Error('Failed to fetch users');
      }
      return res.json();
    },
  });
}

export function useCreateUser() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (data: CreateUserRequest) => {
      const res = await fetch(`${API_BASE}/users`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(data),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.detail || 'Failed to create user');
      }
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
  });
}

export function useUpdateUserStatus(userId: string) {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (status: string) => {
      const res = await fetch(`${API_BASE}/users/${userId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status }),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.detail || 'Failed to update user');
      }
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
      queryClient.invalidateQueries({ queryKey: ['user', userId] });
    },
  });
}

export function useBulkUpdateUsers() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ userIds, update }: { userIds: string[]; update: { status?: string } }) => {
      // Execute updates in parallel
      const results = await Promise.allSettled(
        userIds.map(id =>
          fetch(`${API_BASE}/users/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(update),
          }).then(res => {
            if (!res.ok) throw new Error(`Failed to update ${id}`);
            return res.json();
          })
        )
      );
      
      const succeeded = results.filter(r => r.status === 'fulfilled').length;
      const failed = results.filter(r => r.status === 'rejected').length;
      
      if (failed > 0) {
        throw new Error(`${failed} of ${userIds.length} updates failed`);
      }
      
      return { succeeded, failed };
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
  });
}

export function useDeleteUser() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (userId: string) => {
      const res = await fetch(`${API_BASE}/users/${userId}`, {
        method: 'DELETE',
        credentials: 'include',
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.detail || 'Failed to delete user');
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
  });
}
```

Update apps/web/src/hooks/index.ts:
```typescript
export * from './useUser';
export * from './useUsers';
```
  </action>
  <verify>`pnpm typecheck` passes. Hooks compile correctly.</verify>
  <done>TanStack Table installed, user list hooks created</done>
</task>

<task type="auto">
  <name>Task 2: Create UserTable and BulkActions components</name>
  <files>apps/web/src/components/admin/UserTable.tsx, apps/web/src/components/admin/BulkActions.tsx, apps/web/src/components/admin/index.ts</files>
  <action>
Create directory apps/web/src/components/admin/ if it doesn't exist.

Create apps/web/src/components/admin/UserTable.tsx:
```typescript
import React from 'react';
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  type ColumnDef,
  type SortingState,
  type RowSelectionState,
} from '@tanstack/react-table';
import type { UserSummary } from '../../hooks/useUsers';

interface UserTableProps {
  users: UserSummary[];
  rowSelection: RowSelectionState;
  onRowSelectionChange: (selection: RowSelectionState) => void;
  onUserClick: (user: UserSummary) => void;
}

const columns: ColumnDef<UserSummary>[] = [
  {
    id: 'select',
    header: ({ table }) => (
      <input
        type="checkbox"
        checked={table.getIsAllRowsSelected()}
        indeterminate={table.getIsSomeRowsSelected()}
        onChange={table.getToggleAllRowsSelectedHandler()}
        className="rounded border-gray-300"
      />
    ),
    cell: ({ row }) => (
      <input
        type="checkbox"
        checked={row.getIsSelected()}
        onChange={row.getToggleSelectedHandler()}
        className="rounded border-gray-300"
        onClick={(e) => e.stopPropagation()}
      />
    ),
    enableSorting: false,
  },
  {
    accessorKey: 'display_name',
    header: 'Name',
    cell: ({ row }) => (
      <div>
        <span className="font-medium">{row.original.display_name}</span>
        {row.original.department && (
          <span className="text-gray-500 text-sm ml-2">({row.original.department})</span>
        )}
      </div>
    ),
  },
  {
    accessorKey: 'email',
    header: 'Email',
    cell: ({ getValue }) => (
      <span className="text-gray-600">{getValue() as string}</span>
    ),
  },
  {
    accessorKey: 'global_role',
    header: 'Role',
    cell: ({ getValue }) => {
      const role = getValue() as string;
      return (
        <span className={`px-2 py-1 text-xs rounded ${
          role === 'admin' 
            ? 'bg-purple-100 text-purple-800' 
            : 'bg-gray-100 text-gray-600'
        }`}>
          {role}
        </span>
      );
    },
  },
  {
    accessorKey: 'status',
    header: 'Status',
    cell: ({ getValue }) => {
      const status = getValue() as string;
      const colors: Record<string, string> = {
        active: 'bg-green-100 text-green-800',
        inactive: 'bg-gray-100 text-gray-600',
        suspended: 'bg-red-100 text-red-800',
      };
      return (
        <span className={`px-2 py-1 text-xs rounded ${colors[status] || 'bg-gray-100'}`}>
          {status}
        </span>
      );
    },
  },
];

export function UserTable({ users, rowSelection, onRowSelectionChange, onUserClick }: UserTableProps) {
  const [sorting, setSorting] = React.useState<SortingState>([]);
  
  const table = useReactTable({
    data: users,
    columns,
    state: { sorting, rowSelection },
    onSortingChange: setSorting,
    onRowSelectionChange: (updater) => {
      const newSelection = typeof updater === 'function' ? updater(rowSelection) : updater;
      onRowSelectionChange(newSelection);
    },
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getRowId: (row) => row.user_id,
    enableRowSelection: true,
  });

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-gray-50">
          {table.getHeaderGroups().map(headerGroup => (
            <tr key={headerGroup.id}>
              {headerGroup.headers.map(header => (
                <th
                  key={header.id}
                  className={`px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider ${
                    header.column.getCanSort() ? 'cursor-pointer hover:bg-gray-100' : ''
                  }`}
                  onClick={header.column.getToggleSortingHandler()}
                >
                  <div className="flex items-center gap-1">
                    {flexRender(header.column.columnDef.header, header.getContext())}
                    {header.column.getIsSorted() && (
                      <span>{header.column.getIsSorted() === 'asc' ? ' ↑' : ' ↓'}</span>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody className="bg-white divide-y divide-gray-200">
          {table.getRowModel().rows.length === 0 ? (
            <tr>
              <td colSpan={columns.length} className="px-4 py-8 text-center text-gray-500">
                No users found
              </td>
            </tr>
          ) : (
            table.getRowModel().rows.map(row => (
              <tr
                key={row.id}
                className="hover:bg-gray-50 cursor-pointer transition-colors"
                onClick={() => onUserClick(row.original)}
              >
                {row.getVisibleCells().map(cell => (
                  <td key={cell.id} className="px-4 py-3 text-sm">
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </td>
                ))}
              </tr>
            ))
          )}
        </tbody>
      </table>
    </div>
  );
}
```

Create apps/web/src/components/admin/BulkActions.tsx:
```typescript
import React from 'react';

interface BulkActionsProps {
  selectedCount: number;
  onActivate: () => void;
  onDeactivate: () => void;
  isLoading: boolean;
}

export function BulkActions({ selectedCount, onActivate, onDeactivate, isLoading }: BulkActionsProps) {
  if (selectedCount === 0) return null;
  
  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between mb-4">
      <span className="text-sm text-blue-800 font-medium">
        {selectedCount} user{selectedCount > 1 ? 's' : ''} selected
      </span>
      <div className="flex gap-2">
        <button
          onClick={onActivate}
          disabled={isLoading}
          className="px-3 py-1.5 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {isLoading ? 'Updating...' : 'Activate'}
        </button>
        <button
          onClick={onDeactivate}
          disabled={isLoading}
          className="px-3 py-1.5 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {isLoading ? 'Updating...' : 'Deactivate'}
        </button>
      </div>
    </div>
  );
}
```

Create apps/web/src/components/admin/index.ts:
```typescript
export { UserTable } from './UserTable';
export { BulkActions } from './BulkActions';
```
  </action>
  <verify>Components compile without errors.</verify>
  <done>UserTable with selection and BulkActions components created</done>
</task>

<task type="auto">
  <name>Task 3: Create admin users page</name>
  <files>apps/web/src/pages/admin/UsersPage.tsx, apps/web/src/App.tsx</files>
  <action>
Create directory apps/web/src/pages/admin/ if it doesn't exist.

Create apps/web/src/pages/admin/UsersPage.tsx:
```typescript
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import type { RowSelectionState } from '@tanstack/react-table';
import { useUsers, useCreateUser, useBulkUpdateUsers, type CreateUserRequest } from '../../hooks/useUsers';
import { UserTable, BulkActions } from '../../components/admin';

export function AdminUsersPage() {
  const navigate = useNavigate();
  const [page, setPage] = useState(0);
  const [rowSelection, setRowSelection] = useState<RowSelectionState>({});
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [createError, setCreateError] = useState<string | null>(null);
  
  const pageSize = 20;
  const { data, isLoading, error } = useUsers({ limit: pageSize, offset: page * pageSize });
  const createUser = useCreateUser();
  const bulkUpdate = useBulkUpdateUsers();
  
  const selectedIds = Object.keys(rowSelection).filter(id => rowSelection[id]);
  
  const handleBulkActivate = () => {
    bulkUpdate.mutate(
      { userIds: selectedIds, update: { status: 'active' } },
      { onSuccess: () => setRowSelection({}) }
    );
  };
  
  const handleBulkDeactivate = () => {
    bulkUpdate.mutate(
      { userIds: selectedIds, update: { status: 'inactive' } },
      { onSuccess: () => setRowSelection({}) }
    );
  };
  
  const handleCreateUser = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setCreateError(null);
    
    const formData = new FormData(e.currentTarget);
    const userData: CreateUserRequest = {
      email: formData.get('email') as string,
      display_name: formData.get('display_name') as string,
    };
    
    const department = formData.get('department') as string;
    if (department) userData.department = department;
    
    const role = formData.get('global_role') as string;
    if (role) userData.global_role = role;
    
    try {
      await createUser.mutateAsync(userData);
      setShowCreateModal(false);
      (e.target as HTMLFormElement).reset();
    } catch (err) {
      setCreateError(err instanceof Error ? err.message : 'Failed to create user');
    }
  };
  
  const totalPages = data ? Math.ceil(data.total / pageSize) : 0;
  
  return (
    <div className="max-w-6xl mx-auto p-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold">User Management</h1>
          <p className="text-gray-600 text-sm mt-1">
            {data ? `${data.total} total users` : 'Loading...'}
          </p>
        </div>
        <button
          onClick={() => setShowCreateModal(true)}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Create User
        </button>
      </div>
      
      {/* Bulk Actions */}
      <BulkActions
        selectedCount={selectedIds.length}
        onActivate={handleBulkActivate}
        onDeactivate={handleBulkDeactivate}
        isLoading={bulkUpdate.isPending}
      />
      
      {/* Error State */}
      {error && (
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 text-red-700">
          Failed to load users. Please try again.
        </div>
      )}
      
      {/* Loading State */}
      {isLoading && (
        <div className="bg-white rounded-lg shadow p-8 text-center text-gray-500">
          Loading users...
        </div>
      )}
      
      {/* User Table */}
      {data && !isLoading && (
        <div className="bg-white rounded-lg shadow overflow-hidden">
          <UserTable
            users={data.items}
            rowSelection={rowSelection}
            onRowSelectionChange={setRowSelection}
            onUserClick={(user) => navigate(`/users/${user.user_id}`)}
          />
        </div>
      )}
      
      {/* Pagination */}
      {data && data.total > pageSize && (
        <div className="flex justify-between items-center mt-4">
          <span className="text-sm text-gray-600">
            Showing {data.offset + 1} - {Math.min(data.offset + data.limit, data.total)} of {data.total}
          </span>
          <div className="flex gap-2">
            <button
              onClick={() => setPage(p => Math.max(0, p - 1))}
              disabled={page === 0}
              className="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <span className="px-3 py-1.5 text-sm text-gray-600">
              Page {page + 1} of {totalPages}
            </span>
            <button
              onClick={() => setPage(p => p + 1)}
              disabled={page + 1 >= totalPages}
              className="px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      )}
      
      {/* Create User Modal */}
      {showCreateModal && (
        <div 
          className="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
          onClick={() => setShowCreateModal(false)}
        >
          <div 
            className="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-xl"
            onClick={(e) => e.stopPropagation()}
          >
            <h2 className="text-lg font-semibold mb-4">Create User</h2>
            
            <form onSubmit={handleCreateUser}>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email *
                  </label>
                  <input
                    name="email"
                    type="email"
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="user@example.com"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Display Name *
                  </label>
                  <input
                    name="display_name"
                    type="text"
                    required
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="John Doe"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Department
                  </label>
                  <input
                    name="department"
                    type="text"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Engineering"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Role
                  </label>
                  <select
                    name="global_role"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
              </div>
              
              {createError && (
                <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">
                  {createError}
                </div>
              )}
              
              <div className="flex gap-3 mt-6">
                <button
                  type="submit"
                  disabled={createUser.isPending}
                  className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {createUser.isPending ? 'Creating...' : 'Create User'}
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setShowCreateModal(false);
                    setCreateError(null);
                  }}
                  className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
```

Update apps/web/src/App.tsx to add route:
```typescript
import React from 'react';
import { Routes, Route } from 'react-router-dom';

// Pages
import { HomePage } from './pages/HomePage';
import { ProjectsPage } from './pages/ProjectsPage';
import { TasksPage } from './pages/TasksPage';
import { AnnotatePage } from './pages/AnnotatePage';
import { UserProfilePage } from './pages/UserProfilePage';
import { AdminUsersPage } from './pages/admin/UsersPage';

export function App(): React.ReactElement {
  return (
    <div className="app">
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/projects" element={<ProjectsPage />} />
        <Route path="/projects/:projectId/tasks" element={<TasksPage />} />
        <Route path="/annotate/:taskId" element={<AnnotatePage />} />
        <Route path="/users/:userId" element={<UserProfilePage />} />
        <Route path="/admin/users" element={<AdminUsersPage />} />
      </Routes>
    </div>
  );
}
```
  </action>
  <verify>`pnpm build` succeeds. /admin/users page loads with user table.</verify>
  <done>Admin users page with bulk operations complete</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds in apps/web
- /admin/users shows paginated user list
- Clicking user row navigates to /users/{id} profile
- Checkboxes allow multi-select (individual and "select all")
- Bulk Activate/Deactivate updates selected users
- "Create User" button opens modal form
- Form validates required fields
- User creation works and list refreshes
- Pagination works (Previous/Next buttons)
- Sorting by column headers works
</verification>

<success_criteria>
- Admin can view all users with pagination
- Multi-select works with TanStack Table
- Bulk status changes update all selected users
- User creation modal creates new users
- Navigation to user profile works
- Table supports sorting by name, email
</success_criteria>

<output>
After completion, create `.planning/phases/04-user-team-management/04-08-SUMMARY.md`
</output>
