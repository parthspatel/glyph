---
phase: 03-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - libs/auth/Cargo.toml
  - libs/auth/src/lib.rs
  - libs/auth/src/config.rs
  - libs/auth/src/error.rs
  - apps/api/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Auth0 configuration can be loaded from environment variables"
    - "Auth errors have comprehensive variants for all failure cases"
    - "All required dependencies are available in workspace"
  artifacts:
    - path: "libs/auth/src/config.rs"
      provides: "Auth0Config with domain, client_id, client_secret, audience, callback_url"
      exports: ["Auth0Config", "ConfigError"]
    - path: "libs/auth/src/error.rs"
      provides: "AuthError enum covering token, JWKS, OIDC, authorization failures"
      exports: ["AuthError", "AuthResult"]
  key_links:
    - from: "libs/auth/src/config.rs"
      to: "environment variables"
      via: "std::env"
      pattern: "AUTH0_DOMAIN|AUTH0_CLIENT_ID"
---

<objective>
Set up authentication foundation with Auth0 configuration, expanded error types, and required dependencies.

Purpose: Establish the base infrastructure for JWT/OIDC authentication before implementing core auth logic.
Output: Auth0Config struct, expanded AuthError enum, workspace dependencies configured.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication/03-CONTEXT.md
@.planning/phases/03-authentication/03-RESEARCH.md
@libs/auth/src/lib.rs
@libs/auth/Cargo.toml
@apps/api/Cargo.toml
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add authentication dependencies to workspace</name>
  <files>
    Cargo.toml
    libs/auth/Cargo.toml
    apps/api/Cargo.toml
  </files>
  <action>
Add required dependencies to workspace Cargo.toml under [workspace.dependencies]:
- jsonwebtoken = "9"
- openidconnect = "4"
- reqwest = { version = "0.12", features = ["json", "rustls-tls"] }

Update libs/auth/Cargo.toml [dependencies] to add:
- jsonwebtoken.workspace = true
- openidconnect.workspace = true
- reqwest.workspace = true

Update apps/api/Cargo.toml [dependencies] to add:
- axum-extra = { version = "0.10", features = ["cookie-private"] }
- reqwest.workspace = true

Run `cargo check -p glyph-auth -p glyph-api` to verify dependencies resolve.
  </action>
  <verify>`cargo check -p glyph-auth -p glyph-api` compiles without dependency errors</verify>
  <done>All auth dependencies (jsonwebtoken, openidconnect, reqwest, axum-extra) available</done>
</task>

<task type="auto">
  <name>Task 2: Create Auth0Config and error modules</name>
  <files>
    libs/auth/src/config.rs
    libs/auth/src/error.rs
  </files>
  <action>
Create libs/auth/src/config.rs with Auth0Config struct containing:
- domain: String (Auth0 tenant domain)
- client_id: String
- client_secret: String
- api_identifier: String (audience for access tokens)
- callback_url: String (OAuth callback)
- logout_redirect_url: String

Implement from_env() method that reads AUTH0_DOMAIN, AUTH0_CLIENT_ID, AUTH0_CLIENT_SECRET, AUTH0_API_IDENTIFIER, AUTH0_CALLBACK_URL, AUTH0_LOGOUT_REDIRECT_URL from environment, returning ConfigError::MissingEnvVar for missing vars.

Add helper methods: issuer() -> "https://{domain}/", jwks_url() -> "https://{domain}/.well-known/jwks.json"

Create libs/auth/src/error.rs with AuthError enum variants:
- InvalidToken { reason: String } - malformed or invalid signature
- TokenExpired - exp claim in past
- MissingToken - no token in request
- KeyNotFound { kid: String } - JWKS key not found
- JwksFetchError(String) - failed to fetch JWKS
- DiscoveryError(String) - OIDC discovery failed
- TokenExchangeError(String) - code exchange failed
- InvalidState - CSRF state mismatch
- InvalidNonce - nonce mismatch in ID token
- InsufficientPermissions - authorization denied
- UserNotFound - user not in database
- UserDeactivated - user account disabled
- ConfigError(super::config::ConfigError) - with From impl
- Internal(String) - unexpected errors

Add pub type AuthResult<T> = Result<T, AuthError>;
  </action>
  <verify>`cargo check -p glyph-auth` compiles, `cargo doc -p glyph-auth --no-deps` generates docs</verify>
  <done>Auth0Config loads from env, AuthError covers all auth failure modes</done>
</task>

<task type="auto">
  <name>Task 3: Update lib.rs module structure</name>
  <files>libs/auth/src/lib.rs</files>
  <action>
Replace placeholder libs/auth/src/lib.rs with:

```rust
//! Authentication library for Glyph
//!
//! Provides JWT handling, Auth0 integration, and session management.

pub mod config;
pub mod error;

// Re-exports for convenience
pub use config::{Auth0Config, ConfigError};
pub use error::{AuthError, AuthResult};

// Modules to be added in subsequent plans:
// pub mod jwks;    // 03-02
// pub mod jwt;     // 03-02
// pub mod oidc;    // 03-03
// pub mod tokens;  // 03-04
// pub mod audit;   // 03-06
```

Remove the old placeholder Claims struct and AuthError (now in error.rs).
  </action>
  <verify>`cargo check -p glyph-auth` compiles, `cargo test -p glyph-auth` passes (if any tests)</verify>
  <done>Module structure prepared for remaining auth implementation</done>
</task>

</tasks>

<verification>
- [ ] `cargo check -p glyph-auth -p glyph-api` compiles successfully
- [ ] jsonwebtoken, openidconnect, reqwest available in libs/auth
- [ ] axum-extra with cookie-private available in apps/api
- [ ] Auth0Config::from_env() reads all 6 required env vars
- [ ] AuthError has 12+ variants covering all failure cases
- [ ] Public re-exports work: `use glyph_auth::{Auth0Config, AuthError}`
</verification>

<success_criteria>
- Auth0Config loads from environment with validation errors for missing vars
- AuthError enum comprehensive for token, JWKS, OIDC, authorization, config errors
- Dependencies resolve and crates compile
- Module structure matches RESEARCH.md architecture pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-01-SUMMARY.md`
</output>
