---
phase: 06-workflow-engine
plan: 10
type: execute
wave: 5
depends_on: ["06-07"]
files_modified:
  - libs/workflow-engine/src/goals/mod.rs
  - libs/workflow-engine/src/goals/tracker.rs
  - libs/workflow-engine/src/goals/evaluator.rs
  - libs/workflow-engine/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "Goal progress updates with debouncing (5-10 seconds)"
    - "Goal completion triggers configurable actions"
    - "Quality goals support rolling window evaluation"
  artifacts:
    - path: "libs/workflow-engine/src/goals/tracker.rs"
      provides: "Goal tracking with debouncing"
      contains: "GoalTracker"
    - path: "libs/workflow-engine/src/goals/evaluator.rs"
      provides: "Goal progress evaluation"
      contains: "GoalEvaluator"
  key_links:
    - from: "libs/workflow-engine/src/goals/tracker.rs"
      to: "libs/domain/src/goal.rs"
      via: "uses Goal domain model"
      pattern: "Goal"
---

<objective>
Implement goal tracking engine with debounced updates.

Purpose: Track project goals (volume, quality, deadline, composite, manual) with near real-time updates. Per CONTEXT.md: debounce 5-10 seconds, configurable completion actions.

Output: Goals module with GoalTracker, GoalEvaluator, and completion action handlers.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@libs/domain/src/goal.rs
@libs/domain/src/enums.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goal evaluator</name>
  <files>libs/workflow-engine/src/goals/mod.rs, libs/workflow-engine/src/goals/evaluator.rs</files>
  <action>
Create libs/workflow-engine/src/goals/mod.rs:
```rust
pub mod tracker;
pub mod evaluator;

pub use tracker::*;
pub use evaluator::*;
```

Create libs/workflow-engine/src/goals/evaluator.rs with:

1. GoalEvaluator struct:
   - evaluation_mode: EvaluationMode enum (Realtime, RollingWindow { size: usize }, Checkpoint)

2. EvaluationResult struct:
   - current_value: f64
   - target_value: f64
   - percentage: f64
   - is_complete: bool
   - projected_completion: Option<DateTime<Utc>>

3. impl GoalEvaluator:
   - evaluate_volume(goal: &Goal, completed_count: u64) -> EvaluationResult:
     - Simple count comparison
   
   - evaluate_quality(goal: &Goal, scores: &[f64]) -> EvaluationResult:
     - Calculate average or use rolling window based on evaluation_mode
   
   - evaluate_deadline(goal: &Goal, current_progress: f64) -> EvaluationResult:
     - Check if deadline passed
     - Calculate projected completion based on current velocity
   
   - evaluate_composite(goal: &Goal, sub_goals: &[Goal], results: &[EvaluationResult]) -> EvaluationResult:
     - AND: All sub-goals must be complete
     - OR: Any sub-goal complete
   
   - project_completion(current: f64, target: f64, velocity: f64) -> Option<DateTime<Utc>>:
     - Linear projection based on recent velocity

4. AlertCondition enum:
   - ThresholdCrossed { threshold: f64, direction: Direction }
   - ProjectedMiss { deadline: DateTime<Utc>, projected: DateTime<Utc> }

5. check_alerts(goal: &Goal, result: &EvaluationResult) -> Vec<AlertCondition>
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Goal evaluator with all goal types and projection implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Create goal tracker with debouncing</name>
  <files>libs/workflow-engine/src/goals/tracker.rs</files>
  <action>
Create libs/workflow-engine/src/goals/tracker.rs with:

1. const DEBOUNCE_DURATION: Duration = Duration::from_secs(5);  // Per CONTEXT.md

2. PendingUpdate struct:
   - goal_id: Uuid
   - increment: f64
   - queued_at: Instant

3. GoalTracker struct:
   - goals: HashMap<Uuid, Goal>
   - pending_updates: HashMap<Uuid, PendingUpdate>
   - evaluator: GoalEvaluator
   - on_complete_actions: HashMap<Uuid, Vec<CompletionAction>>

4. CompletionAction enum:
   - Notify { recipients: Vec<String> }
   - Pause
   - TriggerWebhook { url: String }
   - Archive

5. impl GoalTracker:
   - new() -> Self
   
   - register_goal(&mut self, goal: Goal, actions: Vec<CompletionAction>)
   
   - record_contribution(&mut self, goal_id: Uuid, increment: f64):
     - Queue update with timestamp
     - Don't apply immediately (debouncing)
   
   - async flush_pending(&mut self) -> Vec<GoalUpdate>:
     - Find pending updates older than DEBOUNCE_DURATION
     - Apply them atomically
     - Re-evaluate affected goals
     - Return list of updates for persistence
   
   - async process_completion(&self, goal_id: Uuid) -> Vec<ActionResult>:
     - Get completion actions for goal
     - Execute each action
     - Return results

6. GoalUpdate struct:
   - goal_id: Uuid
   - old_value: f64
   - new_value: f64
   - evaluated_at: DateTime<Utc>
   - alerts: Vec<AlertCondition>

7. spawn_flush_loop(tracker: Arc<Mutex<GoalTracker>>) -> JoinHandle<()>:
   - Background task that calls flush_pending every DEBOUNCE_DURATION
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Goal tracker with debounced updates and completion actions implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Export goals module</name>
  <files>libs/workflow-engine/src/lib.rs</files>
  <action>
Update libs/workflow-engine/src/lib.rs to add:
```rust
pub mod goals;
pub use goals::*;
```
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Goals module exported from workflow-engine crate.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `grep -r "GoalTracker" libs/workflow-engine/` finds tracker
- `grep -r "DEBOUNCE_DURATION" libs/workflow-engine/` finds debounce config
</verification>

<success_criteria>
- GoalEvaluator handles volume, quality, deadline, composite goals
- GoalTracker debounces updates (5-10 second window)
- Completion actions (notify, pause, webhook, archive) trigger on goal complete
- Projected completion calculated for deadline goals
- Background flush loop processes pending updates
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-10-SUMMARY.md`
</output>
