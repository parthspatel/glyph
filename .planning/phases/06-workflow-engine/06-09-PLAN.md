---
phase: 06-workflow-engine
plan: 09
type: execute
wave: 5
depends_on: ["06-07", "06-08"]
files_modified:
  - libs/workflow-engine/src/executor/sub_workflow.rs
  - libs/workflow-engine/src/executor/mod.rs
  - libs/workflow-engine/src/engine.rs
autonomous: true

must_haves:
  truths:
    - "Sub-workflow steps can execute nested workflows"
    - "Context is isolated between parent and sub-workflow"
    - "Recursion depth is limited to 3"
  artifacts:
    - path: "libs/workflow-engine/src/executor/sub_workflow.rs"
      provides: "Sub-workflow step executor"
      contains: "SubWorkflowStepExecutor"
  key_links:
    - from: "libs/workflow-engine/src/executor/sub_workflow.rs"
      to: "libs/workflow-engine/src/engine.rs"
      via: "calls engine to execute nested workflow"
      pattern: "WorkflowExecutor"
---

<objective>
Implement sub-workflow step support with context isolation.

Purpose: Sub-workflow steps execute nested workflows. Per RESEARCH.md: enforce depth limit of 3 to prevent stack overflow. Context is mapped at entry/exit points.

Output: Sub-workflow step executor with recursion limits and context mapping.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@libs/workflow-engine/src/executor/traits.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sub-workflow step executor</name>
  <files>libs/workflow-engine/src/executor/sub_workflow.rs</files>
  <action>
Create libs/workflow-engine/src/executor/sub_workflow.rs with:

1. const MAX_RECURSION_DEPTH: u8 = 3;  // Per RESEARCH.md recommendation

2. SubWorkflowStepExecutor struct:
   - sub_workflow_id: String  // ID of workflow to execute
   - input_mapping: HashMap<String, String>  // parent_field -> sub_field
   - output_mapping: HashMap<String, String>  // sub_field -> parent_field
   - current_depth: u8

3. SubWorkflowContext struct:
   - parent_context: serde_json::Value
   - sub_workflow_state: Option<WorkflowStateManager>
   - depth: u8

4. impl StepExecutor for SubWorkflowStepExecutor:
   - execute(&self, ctx):
     - Check depth < MAX_RECURSION_DEPTH:
       - If exceeded: Return Failed { error: "Maximum sub-workflow depth exceeded", retryable: false }
     
     - If sub_workflow_state is None (first execution):
       - Map parent context to sub-workflow context using input_mapping
       - Initialize sub-workflow state with entry step
       - Return Waiting { reason: "Sub-workflow started" }
     
     - If sub_workflow_state exists:
       - Check if sub-workflow is complete
       - If not complete: Return Waiting
       - If complete:
         - Map sub-workflow output to parent context using output_mapping
         - Return Complete { result: StepResult::SubWorkflowCompleted { output } }
   
   - step_type() -> StepType::SubWorkflow

5. impl SubWorkflowStepExecutor:
   - new(config: &StepConfig, depth: u8) -> Result<Self, ExecutorError>:
     - Extract sub_workflow_id from settings
     - Parse input_mapping, output_mapping from settings
     - Store current depth
   
   - map_context(mapping: &HashMap<String, String>, source: &Value) -> Value:
     - Create new Value with mapped fields
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Sub-workflow executor with depth limiting and context mapping implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Create WorkflowExecutor struct</name>
  <files>libs/workflow-engine/src/engine.rs</files>
  <action>
Create/update libs/workflow-engine/src/engine.rs to:

1. Add WorkflowExecutor struct:
   - workflow_config: WorkflowConfig
   - state_manager: WorkflowStateManager
   - handler_registry: Arc<HandlerRegistry>
   - recursion_depth: u8

2. Add WorkflowExecutor impl:
   - new(config: WorkflowConfig, registry: Arc<HandlerRegistry>) -> Self:
     - Initialize state_manager at entry step
     - Set recursion_depth to 0
   
   - with_depth(config: WorkflowConfig, registry: Arc<HandlerRegistry>, depth: u8) -> Self:
     - For sub-workflow creation with inherited depth
   
   - async execute_step(&mut self, step_id: &str, ctx: ExecutionContext) -> Result<ExecutionResult, ExecutorError>:
     - Get step config
     - Create appropriate executor based on step_type
     - For SubWorkflow type, pass self.recursion_depth + 1
     - Execute and return result
   
   - async advance(&mut self) -> Result<Option<String>, WorkflowError>:
     - Execute current step
     - If Complete, evaluate transitions to find next step
     - Transition to next step
     - Return next step ID or None if terminal

3. WorkflowError enum:
   - ExecutorError(ExecutorError)
   - TransitionError(TransitionError)
   - StateError(StateTransitionError)
   - ConfigNotFound(String)
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>WorkflowExecutor struct with sub-workflow support added.</done>
</task>

<task type="auto">
  <name>Task 3: Export sub_workflow module and add ExecutorFactory</name>
  <files>libs/workflow-engine/src/executor/mod.rs</files>
  <action>
Update libs/workflow-engine/src/executor/mod.rs to add:
```rust
pub mod sub_workflow;
pub use sub_workflow::*;
```

Add ExecutorFactory function to create executors by step type:
```rust
pub fn create_executor(
    step_config: &StepConfig,
    registry: Arc<HandlerRegistry>,
    depth: u8,
) -> Result<Box<dyn StepExecutor>, ExecutorError> {
    match step_config.step_type {
        StepType::Annotation => Ok(Box::new(AnnotationStepExecutor::new(step_config)?)),
        StepType::Review => Ok(Box::new(ReviewStepExecutor::new(step_config)?)),
        StepType::Adjudication => Ok(Box::new(AdjudicationStepExecutor::new(step_config)?)),
        StepType::AutoProcess => Ok(Box::new(AutoProcessStepExecutor::new(step_config, registry)?)),
        StepType::Conditional => Ok(Box::new(ConditionalStepExecutor::new(step_config)?)),
        StepType::SubWorkflow => Ok(Box::new(SubWorkflowStepExecutor::new(step_config, depth)?)),
    }
}
```
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>ExecutorFactory and sub_workflow module exported.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `grep -r "MAX_RECURSION_DEPTH" libs/workflow-engine/` finds depth limit
- `grep -r "SubWorkflowStepExecutor" libs/workflow-engine/` finds executor
</verification>

<success_criteria>
- SubWorkflowStepExecutor executes nested workflows
- Depth exceeding 3 returns error
- Input/output context mapping works
- Parent context isolated from sub-workflow
- ExecutorFactory creates all 6 step types
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-09-SUMMARY.md`
</output>
