---
phase: 06-workflow-engine
plan: 07
type: execute
wave: 4
depends_on: ["06-04", "06-05", "06-06"]
files_modified:
  - libs/workflow-engine/src/executor/mod.rs
  - libs/workflow-engine/src/executor/traits.rs
  - libs/workflow-engine/src/executor/annotation.rs
  - libs/workflow-engine/src/executor/review.rs
  - libs/workflow-engine/src/executor/adjudication.rs
  - libs/workflow-engine/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "StepExecutor trait defines common execution interface"
    - "Annotation step waits for configured number of annotations"
    - "Review step accepts/rejects with feedback"
    - "Adjudication step resolves disagreements"
  artifacts:
    - path: "libs/workflow-engine/src/executor/traits.rs"
      provides: "StepExecutor trait definition"
      contains: "StepExecutor"
    - path: "libs/workflow-engine/src/executor/annotation.rs"
      provides: "Annotation step executor"
      contains: "AnnotationStepExecutor"
  key_links:
    - from: "libs/workflow-engine/src/executor/annotation.rs"
      to: "libs/workflow-engine/src/state/step_state.rs"
      via: "produces StepResult"
      pattern: "StepResult"
---

<objective>
Implement step executor trait and basic step types (annotation, review, adjudication).

Purpose: Create the executor abstraction that handles step-specific logic. Annotation steps wait for submissions, review steps accept/reject, adjudication steps resolve disagreements.

Output: Executor module with StepExecutor trait and implementations for annotation, review, adjudication.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@libs/workflow-engine/src/state/step_state.rs
@libs/workflow-engine/src/consensus/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StepExecutor trait</name>
  <files>libs/workflow-engine/src/executor/mod.rs, libs/workflow-engine/src/executor/traits.rs</files>
  <action>
Create libs/workflow-engine/src/executor/mod.rs:
```rust
pub mod traits;
pub mod annotation;
pub mod review;
pub mod adjudication;

pub use traits::*;
pub use annotation::*;
pub use review::*;
pub use adjudication::*;
```

Create libs/workflow-engine/src/executor/traits.rs with:

1. ExecutionContext struct:
   - task_id: Uuid
   - step_id: String
   - step_config: &StepConfig
   - workflow_state: &WorkflowStateManager
   - annotations: Vec<AnnotationData>  // Submitted annotations for this step
   - previous_results: HashMap<String, StepResult>

2. AnnotationData struct:
   - annotation_id: Uuid
   - user_id: Uuid
   - data: serde_json::Value
   - submitted_at: DateTime<Utc>

3. ExecutionResult enum:
   - Waiting { reason: String }  // Step not yet complete
   - Complete { result: StepResult }  // Step finished
   - Failed { error: String, retryable: bool }

4. #[async_trait] trait StepExecutor: Send + Sync:
   - async fn execute(&self, ctx: &ExecutionContext) -> Result<ExecutionResult, ExecutorError>
   - fn step_type(&self) -> StepType
   - fn can_execute(&self, ctx: &ExecutionContext) -> bool

5. ExecutorError enum:
   - ConfigurationError(String)
   - ExecutionFailed(String)
   - InvalidState(String)
   - ConsensusError(ConsensusError)
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>StepExecutor trait and supporting types defined.</done>
</task>

<task type="auto">
  <name>Task 2: Implement annotation step executor</name>
  <files>libs/workflow-engine/src/executor/annotation.rs</files>
  <action>
Create libs/workflow-engine/src/executor/annotation.rs with:

1. AnnotationStepExecutor struct:
   - min_annotators: u32
   - visibility: Visibility  // blind or collaborative

2. impl StepExecutor for AnnotationStepExecutor:
   - execute(&self, ctx):
     - Count submitted annotations for this step
     - If count < min_annotators:
       Return Waiting { reason: format!("Waiting for {} more annotations", min_annotators - count) }
     - If count >= min_annotators:
       Return Complete { result: StepResult::Submitted { annotations: annotation_ids } }
   
   - step_type() -> StepType::Annotation
   
   - can_execute(&self, ctx) -> true if step is Active

3. impl AnnotationStepExecutor:
   - new(config: &StepConfig) -> Result<Self, ExecutorError>:
     - Extract min_annotators from settings (default 1)
     - Extract visibility from settings (default blind)
   
   - get_visible_annotations(&self, ctx: &ExecutionContext) -> Vec<AnnotationData>:
     - If blind, return empty (annotators can't see others' work)
     - If collaborative, return all submitted annotations
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Annotation step executor with visibility control implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Implement review and adjudication step executors</name>
  <files>libs/workflow-engine/src/executor/review.rs, libs/workflow-engine/src/executor/adjudication.rs, libs/workflow-engine/src/lib.rs</files>
  <action>
Create libs/workflow-engine/src/executor/review.rs with:

1. ReviewStepExecutor struct:
   - show_previous: bool

2. impl StepExecutor for ReviewStepExecutor:
   - execute(&self, ctx):
     - Check if review decision submitted (from annotations)
     - If no decision: Return Waiting
     - If approved: Return Complete { result: StepResult::Approved }
     - If rejected: Return Complete { result: StepResult::Rejected { reason } }
   
   - step_type() -> StepType::Review

Create libs/workflow-engine/src/executor/adjudication.rs with:

1. AdjudicationStepExecutor struct:
   - required_roles: Vec<String>
   - show_all_annotations: bool

2. impl StepExecutor for AdjudicationStepExecutor:
   - execute(&self, ctx):
     - Get all annotations from previous step (must be visible to adjudicator)
     - Check if adjudication decision submitted
     - If no decision: Return Waiting
     - If decided: Return Complete { result: StepResult::Consensus { agreement, resolved_by: "adjudication" } }
   
   - step_type() -> StepType::Adjudication
   
   - can_execute(&self, ctx):
     - Check current user has required role

Update libs/workflow-engine/src/lib.rs:
```rust
pub mod executor;
pub use executor::*;
```
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Review and adjudication step executors implemented, executor module exported.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `grep -r "StepExecutor" libs/workflow-engine/src/executor/` finds trait and impls
- All three step types (annotation, review, adjudication) have executors
</verification>

<success_criteria>
- StepExecutor trait with execute, step_type, can_execute methods
- AnnotationStepExecutor waits for min_annotators submissions
- ReviewStepExecutor handles approve/reject decisions
- AdjudicationStepExecutor shows all annotations and requires adjudicator role
- Visibility control (blind vs collaborative) working
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-07-SUMMARY.md`
</output>
