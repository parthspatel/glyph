---
phase: 06-workflow-engine
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/workflow-engine/src/config/mod.rs
  - libs/workflow-engine/src/config/types.rs
  - libs/workflow-engine/src/config/step_library.rs
  - libs/workflow-engine/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "YAML workflow config structs exist with serde annotations"
    - "Step library supports references with overrides"
    - "All six step types are configurable"
  artifacts:
    - path: "libs/workflow-engine/src/config/types.rs"
      provides: "YAML config structs"
      contains: "WorkflowConfig"
    - path: "libs/workflow-engine/src/config/step_library.rs"
      provides: "Reusable step definitions"
      contains: "StepLibrary"
  key_links:
    - from: "libs/workflow-engine/src/config/types.rs"
      to: "libs/domain/src/enums.rs"
      via: "step type enum usage"
      pattern: "StepType"
---

<objective>
Define YAML workflow configuration types with full serde support.

Purpose: Create the Rust struct representations of YAML workflow configurations as specified in PRD ยง4.8. These types will be parsed from YAML and validated before being stored.

Output: config module with WorkflowConfig, StepConfig, TransitionConfig, and StepLibrary types.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@libs/domain/src/workflow.rs
@libs/domain/src/enums.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create YAML workflow config types</name>
  <files>libs/workflow-engine/src/config/mod.rs, libs/workflow-engine/src/config/types.rs</files>
  <action>
Create libs/workflow-engine/src/config/mod.rs:
```rust
pub mod types;
pub mod step_library;

pub use types::*;
pub use step_library::*;
```

Create libs/workflow-engine/src/config/types.rs with:

1. WorkflowConfig struct:
   - version: String (e.g., "1.0")
   - name: String
   - workflow_type: WorkflowType (from domain)
   - settings: WorkflowSettingsConfig
   - steps: Vec<StepConfig>
   - transitions: Vec<TransitionConfig>
   - step_library: Option<Vec<StepLibraryRef>>

2. StepConfig struct:
   - id: String
   - name: String
   - step_type: StepType
   - settings: StepSettingsConfig
   - ref_name: Option<String> (for step library reference)
   - overrides: Option<serde_json::Value>

3. StepSettingsConfig struct:
   - timeout_minutes: Option<u32> (default 120, max 480 per CONTEXT.md)
   - visibility: Option<Visibility> enum (blind, collaborative)
   - required_roles: Option<Vec<String>>
   - handler: Option<String> (for auto_process)
   - condition: Option<String> (for conditional)
   - sub_workflow_id: Option<String> (for sub_workflow)
   - min_annotators: Option<u32>
   - agreement_metric: Option<AgreementMetric> enum
   - threshold: Option<f64>

4. TransitionConfig struct:
   - from: String
   - to: String
   - condition: Option<TransitionConditionConfig>

5. TransitionConditionConfig struct:
   - condition_type: String (always, on_complete, on_agreement, on_disagreement, expression)
   - expression: Option<String>

6. WorkflowSettingsConfig struct:
   - min_annotators: Option<u32>
   - consensus_threshold: Option<f64>
   - tie_breaker: Option<TieBreaker> enum
   - field_level_consensus: Option<FieldConsensus> enum

Use #[serde(default)] and #[serde(rename_all = "snake_case")] appropriately.
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>All YAML config types defined with proper serde annotations.</done>
</task>

<task type="auto">
  <name>Task 2: Create step library types</name>
  <files>libs/workflow-engine/src/config/step_library.rs</files>
  <action>
Create step library types for reusable step definitions (per CONTEXT.md named step library decision):

1. StepLibrary struct:
   - templates: HashMap<String, StepTemplate>

2. StepTemplate struct:
   - name: String
   - step_type: StepType
   - settings: StepSettingsConfig

3. StepLibraryRef struct:
   - ref_name: String (reference to template)
   - overrides: Option<serde_json::Value> (per-use overrides)

4. Implement StepLibrary methods:
   - new() -> Self
   - register(name: &str, template: StepTemplate)
   - resolve(ref_name: &str, overrides: Option<Value>) -> Result<StepConfig, ConfigError>
   - with_predefined() -> Self (creates library with single, multi_adjudication, review_required, iterative_refinement templates per PRD ยง4.8.6)

Create ConfigError enum with variants:
   - TemplateNotFound(String)
   - InvalidOverride(String)
   - ParseError(String)
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Step library with predefined templates and override support implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Update workflow-engine lib.rs to export config module</name>
  <files>libs/workflow-engine/src/lib.rs</files>
  <action>
Update libs/workflow-engine/src/lib.rs to add:
```rust
pub mod config;

pub use config::*;
```

Ensure the module is properly exported for use by other crates.
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine` and verify config types are accessible.</verify>
  <done>Config module exported from workflow-engine crate.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `grep -r "WorkflowConfig" libs/workflow-engine/src/config/` finds the struct
- Config types have proper serde derive macros
</verification>

<success_criteria>
- WorkflowConfig, StepConfig, TransitionConfig types defined
- StepLibrary with predefined templates (single, multi_adjudication, etc.)
- All types have serde(Serialize, Deserialize) derives
- Step visibility enum (blind, collaborative) defined
- Config module exported from lib.rs
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-02-SUMMARY.md`
</output>
