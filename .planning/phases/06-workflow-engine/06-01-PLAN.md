---
phase: 06-workflow-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - libs/workflow-engine/Cargo.toml
  - migrations/0015_workflow_events.sql
  - migrations/0016_workflow_snapshots.sql
autonomous: true

must_haves:
  truths:
    - "Workflow engine crate has petgraph, serde_yml, and backoff dependencies"
    - "Event sourcing schema exists for workflow events"
    - "Snapshot table exists for replay performance"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace dependency definitions"
      contains: "petgraph"
    - path: "libs/workflow-engine/Cargo.toml"
      provides: "Workflow engine dependencies"
      contains: "serde_yml"
    - path: "migrations/0015_workflow_events.sql"
      provides: "Event sourcing table schema"
      contains: "workflow_events"
    - path: "migrations/0016_workflow_snapshots.sql"
      provides: "Snapshot table schema"
      contains: "workflow_snapshots"
  key_links:
    - from: "libs/workflow-engine/Cargo.toml"
      to: "Cargo.toml"
      via: "workspace dependency reference"
      pattern: "petgraph.workspace"
---

<objective>
Add workflow engine dependencies and create event sourcing database schema.

Purpose: Establish foundational dependencies (petgraph for DAG operations, serde_yml for YAML parsing, backoff for retry logic) and create the event sourcing tables needed for workflow audit trail and state reconstruction.

Output: Updated Cargo.toml files with new dependencies, two migration files for workflow_events and workflow_snapshots tables.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@Cargo.toml
@libs/workflow-engine/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace dependencies for workflow engine</name>
  <files>Cargo.toml, libs/workflow-engine/Cargo.toml</files>
  <action>
Add to workspace Cargo.toml `[workspace.dependencies]` section:
```toml
petgraph = "0.6"
serde_yml = "0.0.12"
backoff = { version = "0.4", features = ["tokio"] }
```

Add to libs/workflow-engine/Cargo.toml `[dependencies]` section:
```toml
petgraph.workspace = true
serde_yml.workspace = true
backoff.workspace = true
```

The petgraph crate is for DAG operations (cycle detection, toposort, reachability).
The serde_yml crate is the maintained fork of serde-yaml (which is deprecated).
The backoff crate is for exponential retry logic on auto-process steps.
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine` to ensure dependencies resolve correctly.</verify>
  <done>All three dependencies added to workspace and workflow-engine crate, cargo check passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow_events migration for event sourcing</name>
  <files>migrations/0015_workflow_events.sql</files>
  <action>
Create migration file with partitioned table for event sourcing:

- Table: workflow_events
- Columns: event_id (UUID PK), stream_id (UUID), stream_type (VARCHAR), version (BIGINT), event_type (VARCHAR), event_data (JSONB), metadata (JSONB), occurred_at (TIMESTAMPTZ)
- Partition by RANGE on occurred_at (monthly partitions)
- Create initial partitions for 2026-02 and 2026-03
- Unique constraint on (stream_id, version) for optimistic concurrency
- Indexes: stream+version, event_type+occurred_at, GIN on event_data with jsonb_path_ops

Per RESEARCH.md: Use jsonb_path_ops for 40-50% smaller GIN indexes.
  </action>
  <verify>File exists with valid SQL. Check partitioning and indexes are present.</verify>
  <done>Migration file created with partitioned workflow_events table, proper indexes, and GIN index for JSONB queries.</done>
</task>

<task type="auto">
  <name>Task 3: Create workflow_snapshots migration</name>
  <files>migrations/0016_workflow_snapshots.sql</files>
  <action>
Create migration file with:

- Table: workflow_snapshots
- Columns: snapshot_id (UUID PK), stream_id (UUID), stream_type (VARCHAR), version (BIGINT), state (JSONB), created_at (TIMESTAMPTZ)
- Unique constraint on (stream_id, version)
- Indexes: stream+version DESC (for finding latest), created_at (for cleanup)

Per RESEARCH.md: Snapshot every 50 events for performance.
  </action>
  <verify>File exists with valid SQL.</verify>
  <done>Migration file created with workflow_snapshots table and appropriate indexes.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `ls migrations/0015* migrations/0016*` shows both migration files
- `grep -l petgraph Cargo.toml libs/workflow-engine/Cargo.toml` returns both files
</verification>

<success_criteria>
- petgraph, serde_yml, and backoff dependencies added to workspace
- workflow-engine crate references all three dependencies
- Migration 0015 creates partitioned workflow_events table
- Migration 0016 creates workflow_snapshots table
- All cargo checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-01-SUMMARY.md`
</output>
