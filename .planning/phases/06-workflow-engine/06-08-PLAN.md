---
phase: 06-workflow-engine
plan: 08
type: execute
wave: 4
depends_on: ["06-04", "06-05", "06-06"]
files_modified:
  - libs/workflow-engine/src/executor/auto_process.rs
  - libs/workflow-engine/src/executor/conditional.rs
  - libs/workflow-engine/src/executor/handlers.rs
  - libs/workflow-engine/src/executor/mod.rs
autonomous: true

must_haves:
  truths:
    - "Auto-process steps execute handlers with retry logic"
    - "Conditional steps evaluate expressions to choose branch"
    - "Failed auto-process steps retry with exponential backoff"
  artifacts:
    - path: "libs/workflow-engine/src/executor/auto_process.rs"
      provides: "Auto-process step executor"
      contains: "AutoProcessStepExecutor"
    - path: "libs/workflow-engine/src/executor/conditional.rs"
      provides: "Conditional step executor"
      contains: "ConditionalStepExecutor"
  key_links:
    - from: "libs/workflow-engine/src/executor/auto_process.rs"
      to: "backoff"
      via: "exponential retry"
      pattern: "ExponentialBackoff"
---

<objective>
Implement auto-process and conditional step executors.

Purpose: Auto-process steps run handlers (like consensus calculation) with retry logic. Conditional steps evaluate expressions to choose the next branch. Per CONTEXT.md: 3 retries with exponential backoff (1s, 4s, 16s).

Output: Auto-process and conditional step executors with handler registry.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-workflow-engine/06-CONTEXT.md
@.planning/phases/06-workflow-engine/06-RESEARCH.md
@libs/workflow-engine/src/executor/traits.rs
@libs/workflow-engine/src/consensus/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler registry</name>
  <files>libs/workflow-engine/src/executor/handlers.rs</files>
  <action>
Create libs/workflow-engine/src/executor/handlers.rs with:

1. HandlerInput struct:
   - annotations: Vec<AnnotationData>
   - context: serde_json::Value
   - config: serde_json::Value  // Handler-specific config

2. HandlerOutput struct:
   - result: serde_json::Value
   - consensus_agreement: Option<f64>
   - metadata: serde_json::Value

3. #[async_trait] trait Handler: Send + Sync:
   - async fn execute(&self, input: HandlerInput) -> Result<HandlerOutput, HandlerError>
   - fn name(&self) -> &str

4. HandlerError enum:
   - ExecutionFailed(String)
   - InvalidInput(String)
   - Timeout

5. HandlerRegistry struct:
   - handlers: HashMap<String, Arc<dyn Handler>>

6. impl HandlerRegistry:
   - new() -> Self
   - register(&mut self, handler: Arc<dyn Handler>)
   - get(&self, name: &str) -> Option<Arc<dyn Handler>>
   - with_builtins() -> Self:
     - Register "consensus_calculator" handler

7. ConsensusCalculatorHandler struct:
   impl Handler:
     - execute: Calculate consensus using configured metric (kappa, alpha, iou)
     - Return agreement score
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Handler registry with consensus_calculator built-in handler implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-process step executor with retry</name>
  <files>libs/workflow-engine/src/executor/auto_process.rs</files>
  <action>
Create libs/workflow-engine/src/executor/auto_process.rs with:

1. AutoProcessStepExecutor struct:
   - handler_name: String
   - handler_config: serde_json::Value
   - max_retries: u8  // Default 3 per CONTEXT.md
   - registry: Arc<HandlerRegistry>

2. impl StepExecutor for AutoProcessStepExecutor:
   - execute(&self, ctx):
     - Get handler from registry
     - Build HandlerInput from ctx
     - Execute with retry using backoff crate:
       ```rust
       let backoff = ExponentialBackoff {
           initial_interval: Duration::from_secs(1),
           multiplier: 4.0,  // 1s, 4s, 16s per CONTEXT.md
           max_elapsed_time: Some(Duration::from_secs(60)),
           max_interval: Duration::from_secs(16),
           ..Default::default()
       };
       
       backoff::future::retry(backoff, || async {
           handler.execute(input.clone()).await
               .map_err(backoff::Error::transient)
       }).await
       ```
     - On success: Return Complete { result: StepResult::AutoProcessed { output } }
     - On failure after retries: Return Failed { error, retryable: false }
   
   - step_type() -> StepType::AutoProcess

3. impl AutoProcessStepExecutor:
   - new(config: &StepConfig, registry: Arc<HandlerRegistry>) -> Result<Self, ExecutorError>
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Auto-process step executor with exponential backoff retry implemented.</done>
</task>

<task type="auto">
  <name>Task 3: Implement conditional step executor</name>
  <files>libs/workflow-engine/src/executor/conditional.rs, libs/workflow-engine/src/executor/mod.rs</files>
  <action>
Create libs/workflow-engine/src/executor/conditional.rs with:

1. ConditionalStepExecutor struct:
   - condition: String  // Expression to evaluate
   - true_branch: String  // Step ID if true
   - false_branch: String  // Step ID if false

2. impl StepExecutor for ConditionalStepExecutor:
   - execute(&self, ctx):
     - Build ConditionContext from workflow state
     - Evaluate condition using evaluate_expression from transition module
     - Return Complete { result: StepResult::ConditionMet { branch } }
       where branch is true_branch or false_branch based on evaluation
   
   - step_type() -> StepType::Conditional
   
   - can_execute(&self, ctx) -> true  // Conditionals execute immediately

3. impl ConditionalStepExecutor:
   - new(config: &StepConfig) -> Result<Self, ExecutorError>:
     - Extract condition, true_branch, false_branch from settings

Update libs/workflow-engine/src/executor/mod.rs to add:
```rust
pub mod auto_process;
pub mod conditional;
pub mod handlers;

pub use auto_process::*;
pub use conditional::*;
pub use handlers::*;
```
  </action>
  <verify>Run `cargo check -p glyph-workflow-engine`.</verify>
  <done>Conditional step executor with expression evaluation implemented.</done>
</task>

</tasks>

<verification>
- `cargo check -p glyph-workflow-engine` passes
- `grep -r "ExponentialBackoff" libs/workflow-engine/` finds backoff usage
- `grep -r "HandlerRegistry" libs/workflow-engine/` finds handler registry
</verification>

<success_criteria>
- HandlerRegistry stores and retrieves handlers by name
- consensus_calculator handler calculates agreement metrics
- AutoProcessStepExecutor retries with 1s, 4s, 16s delays
- ConditionalStepExecutor evaluates expressions and returns branch
- Failed handlers escalate after max retries
</success_criteria>

<output>
After completion, create `.planning/phases/06-workflow-engine/06-08-SUMMARY.md`
</output>
