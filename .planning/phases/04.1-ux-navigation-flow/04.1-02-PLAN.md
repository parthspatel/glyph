---
plan_id: "4.1-02"
title: "Create Base Layout Structure"
phase: "4.1"
phase_name: "UX Navigation Flow"
wave: 1
approval: "auto"
depends_on: ["4.1-01"]
files_modified:
  - apps/web/src/components/layout/AppLayout.tsx
  - apps/web/src/components/layout/AppSidebar.tsx
  - apps/web/src/components/layout/index.ts
  - apps/web/src/App.tsx
---

<objective>
Create the AppLayout wrapper component with SidebarProvider and update App.tsx to use layout routes with Outlet.

Purpose: Establish the layout shell that all pages render within, enabling consistent sidebar and content area.
Output: Working layout with placeholder sidebar, all routes wrapped in layout.
</objective>

<context>
@.planning/phases/04.1-ux-navigation-flow/04.1-CONTEXT.md
@.planning/phases/04.1-ux-navigation-flow/04.1-RESEARCH.md
@apps/web/src/App.tsx
@apps/web/src/components/ui/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppLayout and AppSidebar scaffold</name>
  <files>
    apps/web/src/components/layout/AppLayout.tsx
    apps/web/src/components/layout/AppSidebar.tsx
    apps/web/src/components/layout/index.ts
  </files>
  <action>
Create `apps/web/src/components/layout/` directory and files:

**AppLayout.tsx:**
```typescript
import { Outlet } from "react-router-dom";
import { SidebarProvider, SidebarInset, SidebarTrigger } from "@/components/ui/sidebar";
import { AppSidebar } from "./AppSidebar";
import { Separator } from "@/components/ui/separator";

const SIDEBAR_STATE_KEY = "glyph-sidebar-state";

export function AppLayout() {
  // Persist sidebar state in localStorage
  const defaultOpen = localStorage.getItem(SIDEBAR_STATE_KEY) !== "false";

  const handleOpenChange = (open: boolean) => {
    localStorage.setItem(SIDEBAR_STATE_KEY, String(open));
  };

  return (
    <SidebarProvider defaultOpen={defaultOpen} onOpenChange={handleOpenChange}>
      <AppSidebar />
      <SidebarInset>
        <header className="flex h-14 shrink-0 items-center gap-2 border-b px-4">
          <SidebarTrigger className="-ml-1" />
          <Separator orientation="vertical" className="mr-2 h-4" />
          {/* Breadcrumbs will be added here in Plan 04 */}
          <div className="flex-1" />
        </header>
        <main className="flex-1 overflow-auto p-4">
          <Outlet />
        </main>
      </SidebarInset>
    </SidebarProvider>
  );
}
```

**AppSidebar.tsx (scaffold):**
```typescript
import { Link, useLocation } from "react-router-dom";
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarGroup,
  SidebarGroupContent,
} from "@/components/ui/sidebar";
import { navItems, filterNavItems } from "@/lib/navigation";
import { useCurrentUser } from "@/hooks/useUser";

export function AppSidebar() {
  const location = useLocation();
  const { data: user } = useCurrentUser();
  const filteredItems = filterNavItems(navItems, user?.global_role);

  return (
    <Sidebar collapsible="icon">
      <SidebarHeader className="border-b px-4 py-3">
        <Link to="/" className="flex items-center gap-2 font-semibold">
          <span className="text-xl">âœ¦</span>
          <span className="group-data-[collapsible=icon]:hidden">Glyph</span>
        </Link>
      </SidebarHeader>
      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupContent>
            <SidebarMenu>
              {filteredItems.map((item) => {
                const isActive = location.pathname === item.href || 
                  (item.href !== "/" && location.pathname.startsWith(item.href));
                return (
                  <SidebarMenuItem key={item.href}>
                    <SidebarMenuButton asChild isActive={isActive} tooltip={item.label}>
                      <Link to={item.href}>
                        <item.icon />
                        <span>{item.label}</span>
                      </Link>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                );
              })}
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>
      <SidebarFooter className="border-t p-2">
        {/* UserMenu will be added in Plan 03 */}
        <div className="text-sm text-muted-foreground group-data-[collapsible=icon]:hidden">
          {user?.display_name || "Loading..."}
        </div>
      </SidebarFooter>
    </Sidebar>
  );
}
```

**index.ts:**
```typescript
export { AppLayout } from "./AppLayout";
export { AppSidebar } from "./AppSidebar";
```
  </action>
  <verify>
```bash
ls apps/web/src/components/layout/
```
Should show AppLayout.tsx, AppSidebar.tsx, index.ts
  </verify>
  <done>Layout components created with sidebar scaffold</done>
</task>

<task type="auto">
  <name>Task 2: Update App.tsx to use layout routes</name>
  <files>apps/web/src/App.tsx</files>
  <action>
Update `apps/web/src/App.tsx` to wrap all routes in AppLayout:

```typescript
import { Routes, Route } from "react-router-dom";

// Layout
import { AppLayout } from "./components/layout";

// Pages
import { HomePage } from "./pages/HomePage";
import { ProjectsPage } from "./pages/ProjectsPage";
import { ProjectCreatePage } from "./pages/ProjectCreatePage";
import { ProjectEditPage } from "./pages/ProjectEditPage";
import { ProjectDetailPage } from "./pages/ProjectDetailPage";
import { TasksPage } from "./pages/TasksPage";
import { AnnotatePage } from "./pages/AnnotatePage";
import { UserProfilePage } from "./pages/UserProfilePage";
import { AdminUsersPage } from "./pages/admin/UsersPage";
import { TeamsPage } from "./pages/TeamsPage";
import { TeamDetailPage } from "./pages/TeamDetailPage";

export function App() {
  return (
    <Routes>
      <Route element={<AppLayout />}>
        <Route path="/" element={<HomePage />} />
        <Route path="/projects" element={<ProjectsPage />} />
        <Route path="/projects/new" element={<ProjectCreatePage />} />
        <Route path="/projects/:projectId" element={<ProjectDetailPage />} />
        <Route path="/projects/:projectId/edit" element={<ProjectEditPage />} />
        <Route path="/projects/:projectId/tasks" element={<TasksPage />} />
        <Route path="/annotate/:taskId" element={<AnnotatePage />} />
        <Route path="/users/:userId" element={<UserProfilePage />} />
        <Route path="/admin/users" element={<AdminUsersPage />} />
        <Route path="/teams" element={<TeamsPage />} />
        <Route path="/teams/:teamId" element={<TeamDetailPage />} />
      </Route>
    </Routes>
  );
}
```

Remove the outer `<div className="app">` wrapper as the layout handles structure now.
  </action>
  <verify>
```bash
cd apps/web && pnpm dev &
sleep 5
curl -s http://localhost:5173 | grep -q "SidebarProvider" || echo "Server running, check browser"
```
Or manually: Start dev server and verify sidebar appears on all pages.
  </verify>
  <done>All routes wrapped in AppLayout, sidebar visible on every page</done>
</task>

</tasks>

<verification>
- [ ] apps/web/src/components/layout/ directory exists with 3 files
- [ ] App.tsx uses layout route pattern with `<Route element={<AppLayout />}>`
- [ ] Dev server starts without errors: `cd apps/web && pnpm dev`
- [ ] Sidebar visible on homepage (collapsible, shows nav items)
</verification>

<success_criteria>
- All pages render within the AppLayout shell
- Sidebar shows navigation items filtered by role
- Sidebar state persists in localStorage
- Cmd/Ctrl+B toggles sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-ux-navigation-flow/04.1-02-SUMMARY.md`
</output>
