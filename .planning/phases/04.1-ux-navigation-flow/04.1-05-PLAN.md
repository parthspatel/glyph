---
plan_id: "4.1-05"
title: "Protected Routes and Role-Based Home Redirects"
phase: "4.1"
phase_name: "UX Navigation Flow"
wave: 3
approval: "auto"
depends_on: ["4.1-03"]
files_modified:
  - apps/web/src/components/layout/ProtectedRoute.tsx
  - apps/web/src/components/layout/index.ts
  - apps/web/src/pages/HomePage.tsx
  - apps/web/src/App.tsx
---

<objective>
Implement ProtectedRoute component for route protection with role-based access control. Update HomePage to redirect based on user role (Annotator->Projects, Team Lead->Teams, Admin->Dashboard).

Purpose: Ensure admin pages are protected and users land on role-appropriate views.
Output: Protected routes pattern working, role-based home redirects functional.
</objective>

<context>
@.planning/phases/04.1-ux-navigation-flow/04.1-CONTEXT.md
@apps/web/src/hooks/useUser.ts
@apps/web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProtectedRoute component</name>
  <files>
    apps/web/src/components/layout/ProtectedRoute.tsx
    apps/web/src/components/layout/index.ts
  </files>
  <action>
Create `apps/web/src/components/layout/ProtectedRoute.tsx`:

```typescript
import { Navigate, Outlet, useLocation } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useUser";
import { Skeleton } from "@/components/ui/skeleton";

interface ProtectedRouteProps {
  requiredRoles?: string[];
  redirectPath?: string;
  children?: React.ReactNode;
}

export function ProtectedRoute({
  requiredRoles,
  redirectPath = "/",
  children,
}: ProtectedRouteProps) {
  const location = useLocation();
  const { data: user, isLoading, error } = useCurrentUser();

  // Show loading state while checking auth
  if (isLoading) {
    return (
      <div className="flex h-full items-center justify-center p-8">
        <div className="space-y-4 w-full max-w-md">
          <Skeleton className="h-8 w-3/4" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-2/3" />
        </div>
      </div>
    );
  }

  // Not authenticated - redirect to login (or home for now)
  // Store intended destination in location state for post-login redirect
  if (error || !user) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  // Check role requirements
  if (requiredRoles && requiredRoles.length > 0) {
    const hasRequiredRole = requiredRoles.includes(user.global_role);
    if (!hasRequiredRole) {
      // User is authenticated but lacks permission
      return <Navigate to={redirectPath} replace />;
    }
  }

  // Authorized - render children or Outlet for nested routes
  return children ? <>{children}</> : <Outlet />;
}
```

Update `apps/web/src/components/layout/index.ts`:

```typescript
export { AppLayout } from "./AppLayout";
export { AppSidebar } from "./AppSidebar";
export { UserMenu } from "./UserMenu";
export { Breadcrumbs } from "./Breadcrumbs";
export { ProtectedRoute } from "./ProtectedRoute";
```
  </action>
  <verify>
```bash
cat apps/web/src/components/layout/ProtectedRoute.tsx | grep -q "requiredRoles" && echo "ProtectedRoute exists"
```
  </verify>
  <done>ProtectedRoute component created with role checking and loading state</done>
</task>

<task type="auto">
  <name>Task 2: Implement role-based home and protected admin routes</name>
  <files>
    apps/web/src/pages/HomePage.tsx
    apps/web/src/App.tsx
  </files>
  <action>
Update `apps/web/src/pages/HomePage.tsx` for role-based landing:

```typescript
import { Navigate } from "react-router-dom";
import { useCurrentUser } from "@/hooks/useUser";
import { Skeleton } from "@/components/ui/skeleton";

export function HomePage() {
  const { data: user, isLoading } = useCurrentUser();

  if (isLoading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-10 w-48" />
        <Skeleton className="h-4 w-64" />
        <div className="grid gap-4 md:grid-cols-3">
          <Skeleton className="h-32" />
          <Skeleton className="h-32" />
          <Skeleton className="h-32" />
        </div>
      </div>
    );
  }

  // Role-based redirects
  switch (user?.global_role) {
    case "admin":
      // Admin stays on dashboard (this page becomes the dashboard)
      return <AdminDashboard />;
    case "team_lead":
      return <Navigate to="/teams" replace />;
    case "annotator":
    case "user":
    default:
      return <Navigate to="/projects" replace />;
  }
}

// Simple admin dashboard placeholder
function AdminDashboard() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Dashboard</h1>
        <p className="text-muted-foreground">
          Welcome back! Here's an overview of your annotation platform.
        </p>
      </div>
      <div className="grid gap-4 md:grid-cols-3">
        <div className="rounded-lg border bg-card p-6">
          <h3 className="font-semibold">Projects</h3>
          <p className="text-2xl font-bold">--</p>
          <p className="text-sm text-muted-foreground">Active projects</p>
        </div>
        <div className="rounded-lg border bg-card p-6">
          <h3 className="font-semibold">Users</h3>
          <p className="text-2xl font-bold">--</p>
          <p className="text-sm text-muted-foreground">Team members</p>
        </div>
        <div className="rounded-lg border bg-card p-6">
          <h3 className="font-semibold">Tasks</h3>
          <p className="text-2xl font-bold">--</p>
          <p className="text-sm text-muted-foreground">Pending reviews</p>
        </div>
      </div>
    </div>
  );
}
```

Update `apps/web/src/App.tsx` to add protected routes:

```typescript
import { Routes, Route } from "react-router-dom";

// Layout
import { AppLayout, ProtectedRoute } from "./components/layout";

// Pages
import { HomePage } from "./pages/HomePage";
import { ProjectsPage } from "./pages/ProjectsPage";
import { ProjectCreatePage } from "./pages/ProjectCreatePage";
import { ProjectEditPage } from "./pages/ProjectEditPage";
import { ProjectDetailPage } from "./pages/ProjectDetailPage";
import { TasksPage } from "./pages/TasksPage";
import { AnnotatePage } from "./pages/AnnotatePage";
import { UserProfilePage } from "./pages/UserProfilePage";
import { AdminUsersPage } from "./pages/admin/UsersPage";
import { TeamsPage } from "./pages/TeamsPage";
import { TeamDetailPage } from "./pages/TeamDetailPage";

export function App() {
  return (
    <Routes>
      <Route element={<AppLayout />}>
        <Route path="/" element={<HomePage />} />
        <Route path="/projects" element={<ProjectsPage />} />
        <Route path="/projects/new" element={<ProjectCreatePage />} />
        <Route path="/projects/:projectId" element={<ProjectDetailPage />} />
        <Route path="/projects/:projectId/edit" element={<ProjectEditPage />} />
        <Route path="/projects/:projectId/tasks" element={<TasksPage />} />
        <Route path="/annotate/:taskId" element={<AnnotatePage />} />
        <Route path="/users/:userId" element={<UserProfilePage />} />
        <Route path="/teams" element={<TeamsPage />} />
        <Route path="/teams/:teamId" element={<TeamDetailPage />} />

        {/* Admin-only routes */}
        <Route element={<ProtectedRoute requiredRoles={["admin"]} />}>
          <Route path="/admin/users" element={<AdminUsersPage />} />
        </Route>
      </Route>
    </Routes>
  );
}
```
  </action>
  <verify>
```bash
cd apps/web && pnpm tsc --noEmit
```
No errors. Test by logging in as non-admin and trying to access /admin/users - should redirect to home.
  </verify>
  <done>Role-based home redirects working, admin routes protected</done>
</task>

</tasks>

<verification>
- [ ] ProtectedRoute shows loading skeleton while checking auth
- [ ] ProtectedRoute redirects to /login if not authenticated
- [ ] ProtectedRoute redirects to home if user lacks required role
- [ ] HomePage redirects: annotator->projects, team_lead->teams, admin->dashboard
- [ ] /admin/users only accessible by admin users
- [ ] Location state preserved for post-login redirect
</verification>

<success_criteria>
- Role-based landing pages work per CONTEXT.md decisions
- Admin routes return 403-equivalent redirect for non-admins
- Loading states prevent auth flash
- Post-login redirect preserves intended destination
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-ux-navigation-flow/04.1-05-SUMMARY.md`
</output>
