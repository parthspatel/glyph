---
plan_id: "4.1-03"
title: "Implement Sidebar with Role-Based Navigation and User Menu"
phase: "4.1"
phase_name: "UX Navigation Flow"
wave: 2
approval: "auto"
depends_on: ["4.1-02"]
files_modified:
  - apps/web/src/components/layout/AppSidebar.tsx
  - apps/web/src/components/layout/UserMenu.tsx
  - apps/web/src/components/layout/index.ts
---

<objective>
Enhance sidebar with complete role-based navigation, active state styling (left border accent + bold), and user menu dropdown at bottom with avatar, profile link, and logout.

Purpose: Deliver the full sidebar UX with role-based visibility, visual feedback, and user account controls.
Output: Production-ready sidebar matching design spec.
</objective>

<context>
@.planning/phases/04.1-ux-navigation-flow/04.1-CONTEXT.md
@apps/web/src/components/layout/AppSidebar.tsx
@apps/web/src/hooks/useUser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UserMenu component</name>
  <files>apps/web/src/components/layout/UserMenu.tsx</files>
  <action>
Create `apps/web/src/components/layout/UserMenu.tsx`:

```typescript
import { Link } from "react-router-dom";
import { ChevronsUpDown, LogOut, User } from "lucide-react";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  useSidebar,
} from "@/components/ui/sidebar";
import { useCurrentUser } from "@/hooks/useUser";

export function UserMenu() {
  const { data: user, isLoading } = useCurrentUser();
  const { isMobile } = useSidebar();

  if (isLoading) {
    return (
      <SidebarMenu>
        <SidebarMenuItem>
          <SidebarMenuButton size="lg" className="animate-pulse">
            <div className="h-8 w-8 rounded-lg bg-muted" />
            <div className="flex-1 space-y-1">
              <div className="h-3 w-20 rounded bg-muted" />
              <div className="h-2 w-16 rounded bg-muted" />
            </div>
          </SidebarMenuButton>
        </SidebarMenuItem>
      </SidebarMenu>
    );
  }

  if (!user) return null;

  const initials = user.display_name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);

  const handleLogout = async () => {
    // Call logout endpoint and redirect
    await fetch("/api/v1/auth/logout", { method: "POST", credentials: "include" });
    window.location.href = "/";
  };

  return (
    <SidebarMenu>
      <SidebarMenuItem>
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <SidebarMenuButton
              size="lg"
              className="data-[state=open]:bg-sidebar-accent data-[state=open]:text-sidebar-accent-foreground"
            >
              <Avatar className="h-8 w-8 rounded-lg">
                <AvatarImage src={user.avatar_url ?? undefined} alt={user.display_name} />
                <AvatarFallback className="rounded-lg">{initials}</AvatarFallback>
              </Avatar>
              <div className="grid flex-1 text-left text-sm leading-tight">
                <span className="truncate font-semibold">{user.display_name}</span>
                <span className="truncate text-xs text-muted-foreground">{user.email}</span>
              </div>
              <ChevronsUpDown className="ml-auto size-4" />
            </SidebarMenuButton>
          </DropdownMenuTrigger>
          <DropdownMenuContent
            className="w-[--radix-dropdown-menu-trigger-width] min-w-56 rounded-lg"
            side={isMobile ? "bottom" : "right"}
            align="end"
            sideOffset={4}
          >
            <DropdownMenuLabel className="p-0 font-normal">
              <div className="flex items-center gap-2 px-1 py-1.5 text-left text-sm">
                <Avatar className="h-8 w-8 rounded-lg">
                  <AvatarImage src={user.avatar_url ?? undefined} alt={user.display_name} />
                  <AvatarFallback className="rounded-lg">{initials}</AvatarFallback>
                </Avatar>
                <div className="grid flex-1 text-left text-sm leading-tight">
                  <span className="truncate font-semibold">{user.display_name}</span>
                  <span className="truncate text-xs text-muted-foreground">{user.email}</span>
                </div>
              </div>
            </DropdownMenuLabel>
            <DropdownMenuSeparator />
            <DropdownMenuItem asChild>
              <Link to={`/users/${user.user_id}`}>
                <User className="mr-2 h-4 w-4" />
                Profile
              </Link>
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem onClick={handleLogout}>
              <LogOut className="mr-2 h-4 w-4" />
              Log out
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </SidebarMenuItem>
    </SidebarMenu>
  );
}
```
  </action>
  <verify>
```bash
cat apps/web/src/components/layout/UserMenu.tsx | grep -q "DropdownMenu" && echo "UserMenu exists"
```
  </verify>
  <done>UserMenu component created with avatar, profile link, logout</done>
</task>

<task type="auto">
  <name>Task 2: Update AppSidebar with active styling and UserMenu</name>
  <files>
    apps/web/src/components/layout/AppSidebar.tsx
    apps/web/src/components/layout/index.ts
  </files>
  <action>
Update `apps/web/src/components/layout/AppSidebar.tsx`:

```typescript
import { Link, useLocation } from "react-router-dom";
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarGroup,
  SidebarGroupContent,
} from "@/components/ui/sidebar";
import { navItems, filterNavItems } from "@/lib/navigation";
import { useCurrentUser } from "@/hooks/useUser";
import { UserMenu } from "./UserMenu";
import { cn } from "@/lib/utils";

export function AppSidebar() {
  const location = useLocation();
  const { data: user } = useCurrentUser();
  const filteredItems = filterNavItems(navItems, user?.global_role);

  const isActive = (href: string) => {
    if (href === "/") {
      return location.pathname === "/";
    }
    return location.pathname === href || location.pathname.startsWith(href + "/");
  };

  return (
    <Sidebar collapsible="icon">
      <SidebarHeader className="border-b px-4 py-3">
        <Link to="/" className="flex items-center gap-2 font-semibold">
          <span className="text-xl text-primary">âœ¦</span>
          <span className="group-data-[collapsible=icon]:hidden">Glyph</span>
        </Link>
      </SidebarHeader>
      <SidebarContent>
        <SidebarGroup>
          <SidebarGroupContent>
            <SidebarMenu>
              {filteredItems.map((item) => {
                const active = isActive(item.href);
                return (
                  <SidebarMenuItem key={item.href}>
                    <SidebarMenuButton
                      asChild
                      isActive={active}
                      tooltip={item.label}
                      className={cn(
                        active && "border-l-2 border-primary bg-accent font-semibold"
                      )}
                    >
                      <Link to={item.href}>
                        <item.icon className={cn(active && "text-primary")} />
                        <span>{item.label}</span>
                      </Link>
                    </SidebarMenuButton>
                  </SidebarMenuItem>
                );
              })}
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      </SidebarContent>
      <SidebarFooter className="border-t">
        <UserMenu />
      </SidebarFooter>
    </Sidebar>
  );
}
```

Update `apps/web/src/components/layout/index.ts`:

```typescript
export { AppLayout } from "./AppLayout";
export { AppSidebar } from "./AppSidebar";
export { UserMenu } from "./UserMenu";
```
  </action>
  <verify>
```bash
cd apps/web && pnpm tsc --noEmit
```
No TypeScript errors.
  </verify>
  <done>Sidebar has active styling (left border accent, bold text) and integrated UserMenu</done>
</task>

</tasks>

<verification>
- [ ] UserMenu shows avatar with initials fallback
- [ ] UserMenu dropdown has Profile link and Logout button
- [ ] Active nav item has left border accent (primary color) and bold text
- [ ] Admin-only items (Users) hidden for non-admin users
- [ ] Collapsed sidebar shows tooltips on hover
</verification>

<success_criteria>
- Sidebar navigation items filtered by user role
- Active state shows left purple border accent + bold text + subtle background
- User menu at bottom shows avatar, name, email, with dropdown for profile/logout
- Tooltips appear on collapsed sidebar with ~300ms delay (shadcn default)
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-ux-navigation-flow/04.1-03-SUMMARY.md`
</output>
