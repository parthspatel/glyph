# Phase 4.1: UX Navigation Flow - Research

**Researched:** 2026-01-31
**Domain:** React Navigation Infrastructure (Sidebar, Breadcrumbs, Route Protection)
**Confidence:** HIGH

## Summary

This phase implements application-wide navigation infrastructure including a collapsible sidebar (VS Code-style), breadcrumb navigation, role-based route protection, and mobile bottom tab bar. The shadcn/ui Sidebar component provides the exact functionality needed - collapsible to icon rail, hover expansion, mobile sheet drawer. Combined with React Router v7 layout routes and the existing authentication hook (`useCurrentUser`), this can be implemented with minimal custom code.

The project already has the foundation: react-router-dom v7.1.0, Tailwind CSS v4, lucide-react icons, and a `useCurrentUser` hook returning user roles. The main additions are shadcn/ui components (sidebar, breadcrumb, tooltip, dropdown-menu, avatar, sheet) and a layout wrapper component.

**Primary recommendation:** Use shadcn/ui Sidebar with `collapsible="icon"` mode, wrap all routes in a Layout component with `<Outlet />`, and implement breadcrumbs using `useLocation` path parsing (since current BrowserRouter setup doesn't support useMatches).

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @shadcn/ui sidebar | latest | Collapsible sidebar with icon mode | Official shadcn component, handles all complexity |
| @shadcn/ui breadcrumb | latest | Breadcrumb navigation | Composable, works with react-router via asChild |
| @shadcn/ui tooltip | latest | Collapsed sidebar tooltips | Radix-based, configurable delayDuration |
| @shadcn/ui dropdown-menu | latest | User profile menu | Standard pattern for account menus |
| @shadcn/ui avatar | latest | User avatar display | Handles fallback states |
| @shadcn/ui sheet | latest | Mobile navigation drawer | Already used by sidebar internally |
| react-router-dom | ^7.1.0 | Routing (already installed) | Project standard |
| lucide-react | ^0.469 | Navigation icons | Already configured in components.json |

**Installation:**
```bash
pnpm dlx shadcn@latest add sidebar breadcrumb tooltip dropdown-menu avatar sheet
```

## Architecture Patterns

### Recommended Project Structure
```
apps/web/src/
├── components/
│   ├── layout/
│   │   ├── AppLayout.tsx          # Main layout wrapper with Sidebar
│   │   ├── AppSidebar.tsx         # Sidebar content and navigation items
│   │   ├── Breadcrumbs.tsx        # Breadcrumb navigation component
│   │   ├── MobileNav.tsx          # Bottom tab bar for mobile
│   │   └── UserMenu.tsx           # Avatar + dropdown at sidebar bottom
│   └── ui/                        # shadcn components (auto-generated)
├── hooks/
│   └── useBreadcrumbs.ts          # Hook to parse location into breadcrumbs
├── lib/
│   ├── utils.ts                   # cn() utility (exists)
│   └── navigation.ts              # Navigation item definitions, role filtering
└── App.tsx                        # Routes wrapped in AppLayout
```

### Pattern 1: Layout Route with Outlet
```typescript
import { Routes, Route, Outlet } from "react-router-dom";
import { AppLayout } from "@/components/layout/AppLayout";

export function App() {
  return (
    <Routes>
      <Route element={<AppLayout />}>
        <Route path="/" element={<HomePage />} />
        <Route path="/projects" element={<ProjectsPage />} />
        {/* ... more routes */}
      </Route>
    </Routes>
  );
}
```

### Pattern 2: Collapsible Sidebar with Icon Mode
```typescript
import { Sidebar, SidebarContent, SidebarMenu, SidebarMenuItem, SidebarMenuButton } from "@/components/ui/sidebar";

export function AppSidebar() {
  return (
    <Sidebar collapsible="icon">
      <SidebarHeader><Logo /></SidebarHeader>
      <SidebarContent>
        <SidebarMenu>
          {navItems.map((item) => (
            <SidebarMenuItem key={item.href}>
              <SidebarMenuButton asChild isActive={isActive(item.href)}>
                <Link to={item.href}>
                  <item.icon />
                  <span>{item.label}</span>
                </Link>
              </SidebarMenuButton>
            </SidebarMenuItem>
          ))}
        </SidebarMenu>
      </SidebarContent>
      <SidebarFooter><UserMenu /></SidebarFooter>
    </Sidebar>
  );
}
```

### Pattern 3: Role-Based Navigation Filtering
```typescript
interface NavItem {
  href: string;
  label: string;
  icon: LucideIcon;
  roles?: string[]; // If undefined, visible to all
}

const navItems: NavItem[] = [
  { href: "/", label: "Dashboard", icon: LayoutDashboard },
  { href: "/projects", label: "Projects", icon: FolderKanban },
  { href: "/teams", label: "Teams", icon: Users },
  { href: "/admin/users", label: "Users", icon: UserCog, roles: ["admin"] },
];

export function useNavItems() {
  const { data: user } = useCurrentUser();
  return navItems.filter((item) => {
    if (!item.roles) return true;
    return item.roles.includes(user?.global_role ?? "");
  });
}
```

### Pattern 4: Protected Route Component
```typescript
import { Navigate, Outlet, useLocation } from "react-router-dom";

interface ProtectedRouteProps {
  isAllowed?: boolean;
  redirectPath?: string;
  children?: React.ReactNode;
}

export function ProtectedRoute({ isAllowed, redirectPath = "/", children }: ProtectedRouteProps) {
  const location = useLocation();
  if (!isAllowed) {
    return <Navigate to={redirectPath} state={{ from: location }} replace />;
  }
  return children ? children : <Outlet />;
}
```

### Pattern 5: Breadcrumbs with useLocation
```typescript
import { useLocation, Link } from "react-router-dom";
import { Breadcrumb, BreadcrumbItem, BreadcrumbLink, BreadcrumbList, BreadcrumbPage, BreadcrumbSeparator } from "@/components/ui/breadcrumb";

const routeLabels: Record<string, string> = {
  "": "Home", "projects": "Projects", "teams": "Teams", "admin": "Admin", "users": "Users",
};

export function Breadcrumbs() {
  const location = useLocation();
  const pathSegments = location.pathname.split("/").filter(Boolean);
  // ... render breadcrumb items
}
```

## Common Pitfalls

1. **Sidebar State Not Persisting** — Use `defaultOpen` with localStorage
2. **Mobile Bottom Tab vs Sidebar Conflict** — Use `useSidebar().isMobile` for conditional rendering
3. **Breadcrumb Dynamic Segments** — Lookup entity name from React Query cache
4. **Tooltip Delay Too Long** — Set `delayDuration={300}` on TooltipProvider
5. **Protected Route Flash** — Show loading state while auth status unknown
6. **Active State Not Updating** — Use `useLocation().pathname` for matching

## Don't Hand-Roll

| Problem | Use Instead |
|---------|-------------|
| Collapsible sidebar | shadcn Sidebar `collapsible="icon"` |
| Sidebar tooltips | shadcn Tooltip (integrated in SidebarMenuButton) |
| Mobile sidebar | shadcn Sidebar (uses Sheet internally) |
| User avatar fallback | shadcn Avatar with AvatarFallback |
| Route protection | ProtectedRoute wrapper |
| Dropdown menus | shadcn DropdownMenu |

## Open Questions

1. **Sidebar state persistence** — Recommend localStorage via `defaultOpen`
2. **Auth redirect flow** — Store intended URL in location state
3. **Dynamic breadcrumb labels** — Use React Query cache lookup first

## Sources

- [shadcn/ui Sidebar](https://ui.shadcn.com/docs/components/sidebar)
- [shadcn/ui Breadcrumb](https://ui.shadcn.com/docs/components/breadcrumb)
- [Radix Tooltip](https://www.radix-ui.com/primitives/docs/components/tooltip)
- [React Router v7 Layout Routes](https://reactrouter.com/)
