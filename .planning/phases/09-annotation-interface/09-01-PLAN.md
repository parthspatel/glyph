---
phase: 09-annotation-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/@glyph/types/src/index.ts
  - libs/glyph-core/src/models/draft.rs
  - libs/glyph-core/src/models/skip_reason.rs
  - libs/glyph-core/src/models/review.rs
  - libs/glyph-core/src/models/mod.rs
  - apps/api/src/routes/drafts.rs
  - apps/api/src/routes/skip_reasons.rs
  - apps/api/src/routes/reviews.rs
  - apps/api/src/routes/mod.rs
autonomous: true

must_haves:
  truths:
    - "Draft can be saved and retrieved for a task"
    - "Skip reasons can be listed per project"
    - "Reviews can be submitted with actions"
  artifacts:
    - path: "packages/@glyph/types/src/index.ts"
      provides: "Draft, SkipReason, Review types"
      contains: "interface Draft"
    - path: "apps/api/src/routes/drafts.rs"
      provides: "Draft CRUD endpoints"
      exports: ["routes"]
  key_links:
    - from: "apps/api/src/routes/mod.rs"
      to: "drafts.rs"
      via: "Router nesting"
      pattern: "nest.*drafts"
---

<objective>
Define types and API endpoints for annotation workflow: drafts, skip reasons, and reviews.

Purpose: Establish the data contracts and API layer that the annotation UI will consume.
Output: TypeScript types, Rust models, and REST endpoints for draft management, skip reasons, and review submission.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-annotation-interface/09-CONTEXT.md
@.planning/phases/09-annotation-interface/09-RESEARCH.md
@packages/@glyph/types/src/index.ts
@apps/api/src/routes/tasks.rs
@apps/api/src/routes/annotations.rs
@apps/api/src/routes/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Draft, SkipReason, and Review types</name>
  <files>
    packages/@glyph/types/src/index.ts
    libs/glyph-core/src/models/draft.rs
    libs/glyph-core/src/models/skip_reason.rs
    libs/glyph-core/src/models/review.rs
    libs/glyph-core/src/models/mod.rs
  </files>
  <action>
Add types for annotation workflow to packages/@glyph/types/src/index.ts:

**Draft** (auto-saved annotation work in progress):
- draft_id: string, task_id: string, user_id: string
- data: Record&lt;string, unknown&gt;
- version: number
- created_at: string, updated_at: string

**SkipReason** (why an annotator skipped a task):
- skip_reason_id: string, code: string, label: string
- scope: "system" | "project"
- project_id?: string, is_active: boolean
- System defaults: "unclear_instructions", "bad_data_quality", "conflict_of_interest", "technical_issue"

**Review** (reviewer's evaluation of an annotation):
- review_id: string, annotation_id: string, task_id: string, reviewer_id: string
- action: "approve" | "reject" | "request_changes"
- corrected_data?: Record&lt;string, unknown&gt;
- summary_note?: string
- ReviewComment: { comment_id, review_id, path, content, created_at }

Create corresponding Rust models in libs/glyph-core/src/models/ following existing patterns. Add typeshare attributes for TypeScript generation.
  </action>
  <verify>Types compile: pnpm --filter @glyph/types build passes</verify>
  <done>Draft, SkipReason, Review types defined in TypeScript and Rust</done>
</task>

<task type="auto">
  <name>Task 2: Create Draft API endpoints</name>
  <files>
    apps/api/src/routes/drafts.rs
    apps/api/src/routes/mod.rs
  </files>
  <action>
Create draft management endpoints in apps/api/src/routes/drafts.rs:

**POST /api/v1/tasks/{task_id}/drafts** - Save/update draft
- Upsert: create if none exists, update if exists
- Only one draft per (task_id, user_id) pair
- Request: { data: Record&lt;string, unknown&gt; }
- Response: Draft object with updated_at

**GET /api/v1/tasks/{task_id}/drafts** - Get user's draft
- Returns current user's draft or 404 if none
- Response: Draft object

**DELETE /api/v1/tasks/{task_id}/drafts** - Delete draft
- Clears draft when annotation is submitted
- Response: 204 No Content

Follow existing route patterns from tasks.rs:
- Use utoipa for OpenAPI docs
- Use ApiError for error responses  
- Use CurrentUser extractor for auth
- Add to mod.rs: nest routes under /tasks/{task_id}/drafts
  </action>
  <verify>API compiles: cargo check -p glyph-api passes</verify>
  <done>Draft endpoints created and registered</done>
</task>

<task type="auto">
  <name>Task 3: Create SkipReason and Review API endpoints</name>
  <files>
    apps/api/src/routes/skip_reasons.rs
    apps/api/src/routes/reviews.rs
    apps/api/src/routes/mod.rs
  </files>
  <action>
Create skip reason and review endpoints:

**apps/api/src/routes/skip_reasons.rs:**
- GET /api/v1/projects/{project_id}/skip-reasons - List active skip reasons (system + project)
- POST /api/v1/projects/{project_id}/skip-reasons - Create project skip reason (admin only)
- DELETE /api/v1/projects/{project_id}/skip-reasons/{id} - Deactivate skip reason

**POST /api/v1/tasks/{task_id}/skip** - Skip a task
- Request: { skip_reason_id: string, note?: string }
- Creates skip record and advances workflow
- Response: 200 with updated task status

**apps/api/src/routes/reviews.rs:**
- POST /api/v1/tasks/{task_id}/reviews - Submit review
  - Request: { annotation_id, action: ReviewAction, corrected_data?, summary_note? }
  - Response: Review object

- POST /api/v1/tasks/{task_id}/reviews/{review_id}/comments - Add inline comment
  - Request: { path: string, content: string }
  - Response: ReviewComment object

- GET /api/v1/tasks/{task_id}/reviews - List reviews for task
  - Response: array of Review objects

Register all routes in mod.rs.
  </action>
  <verify>API compiles and routes registered: cargo check -p glyph-api passes</verify>
  <done>Skip reason and review endpoints created</done>
</task>

</tasks>

<verification>
- pnpm --filter @glyph/types build succeeds
- cargo check -p glyph-api succeeds
- cargo test -p glyph-api passes
- Routes appear in OpenAPI spec
</verification>

<success_criteria>
- Draft, SkipReason, Review types exist in @glyph/types
- Rust models exist in libs/glyph-core
- API endpoints for drafts, skip reasons, reviews are registered
- All builds pass
</success_criteria>

<output>
After completion, create .planning/phases/09-annotation-interface/09-01-SUMMARY.md
</output>
