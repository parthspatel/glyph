---
phase: 09-annotation-interface
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - apps/web/src/hooks/useDraft.ts
  - apps/web/src/api/drafts.ts
  - apps/web/src/pages/AnnotatePage.tsx
  - apps/web/package.json
autonomous: true

must_haves:
  truths:
    - "Changes are auto-saved after 1.5s of inactivity"
    - "Draft is loaded when returning to a task"
    - "Save status reflects current state"
  artifacts:
    - path: "apps/web/src/hooks/useDraft.ts"
      provides: "Draft auto-save hook"
      min_lines: 60
    - path: "apps/web/src/api/drafts.ts"
      provides: "Draft API client"
      exports: ["saveDraft", "getDraft", "deleteDraft"]
  key_links:
    - from: "apps/web/src/hooks/useDraft.ts"
      to: "/api/v1/tasks/{taskId}/drafts"
      via: "fetch call"
      pattern: "saveDraft|getDraft"
---

<objective>
Implement continuous auto-save with debounce for annotation drafts.

Purpose: Prevent data loss by automatically saving annotator work with clear status feedback.
Output: useDraft hook that auto-saves on changes and loads existing drafts.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-annotation-interface/09-CONTEXT.md
@.planning/phases/09-annotation-interface/09-RESEARCH.md
@.planning/phases/09-annotation-interface/09-01-SUMMARY.md
@.planning/phases/09-annotation-interface/09-02-SUMMARY.md
@apps/web/src/pages/AnnotatePage.tsx
@apps/web/src/hooks/useUnsavedChanges.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add use-debounce and create draft API client</name>
  <files>
    apps/web/package.json
    apps/web/src/api/drafts.ts
    apps/web/src/api/index.ts
  </files>
  <action>
Install use-debounce (650B) and create draft API:

cd apps/web and pnpm add use-debounce

**apps/web/src/api/drafts.ts:**
- saveDraft(taskId: string, data: Record&lt;string, unknown&gt;): Promise&lt;Draft&gt;
  - POST /tasks/{taskId}/drafts with { data }
- getDraft(taskId: string): Promise&lt;Draft | null&gt;
  - GET /tasks/{taskId}/drafts
  - Return null on 404, throw on other errors
- deleteDraft(taskId: string): Promise&lt;void&gt;
  - DELETE /tasks/{taskId}/drafts

Export from index.ts.
  </action>
  <verify>pnpm --filter web build compiles</verify>
  <done>use-debounce installed and draft API created</done>
</task>

<task type="auto">
  <name>Task 2: Create useDraft hook and integrate into AnnotatePage</name>
  <files>
    apps/web/src/hooks/useDraft.ts
    apps/web/src/hooks/index.ts
    apps/web/src/pages/AnnotatePage.tsx
  </files>
  <action>
Create auto-save hook with debounce:

**apps/web/src/hooks/useDraft.ts:**
- useDraft({ taskId, onLoad }): { saveStatus, save, clear, isLoading }
- Use useDebouncedCallback from use-debounce with 1500ms delay
- Use React Query for loading draft on mount
- Use useMutation for saving with abort controller to cancel in-flight requests
- saveStatus states: 'idle', 'pending', 'saving', { saved: Date }, { error: string }
- save(data): sets pending, triggers debounced save
- clear(): deletes draft, resets status

**Update AnnotatePage.tsx:**
- Replace local saveStatus state with useDraft hook
- Pass onLoad callback to initialize output state from draft
- Call save(output) in handleOutputChange
- Use useUnsavedChanges for beforeunload warning when saveStatus is 'pending' or 'saving'
- Show loading skeleton while draft is loading
  </action>
  <verify>Draft auto-saves after typing stops; draft loads on page refresh</verify>
  <done>Draft auto-save working with 1.5s debounce</done>
</task>

</tasks>

<verification>
- Make changes in annotation page, wait 1.5s, see "Draft saved at X:XX"
- Refresh page, draft loads automatically
- Close tab with unsaved changes, browser prompts
</verification>

<success_criteria>
- Changes auto-save after 1.5s inactivity
- "Saving..." shows during save
- "Draft saved at X:XX" shows after save
- Draft loads silently on return
- Browser prompts before leaving with unsaved changes
</success_criteria>

<output>
After completion, create .planning/phases/09-annotation-interface/09-03-SUMMARY.md
</output>
