---
phase: 09-annotation-interface
plan: 05
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - apps/web/src/hooks/useAnnotationSubmit.ts
  - apps/web/src/api/annotations.ts
  - apps/web/src/pages/AnnotatePage.tsx
  - apps/web/package.json
  - apps/web/src/main.tsx
autonomous: true

must_haves:
  truths:
    - "Submit validates required fields before submission"
    - "Successful submit shows toast and Next Task button"
    - "Next Task navigates to queue or next assigned task"
  artifacts:
    - path: "apps/web/src/hooks/useAnnotationSubmit.ts"
      provides: "Submit hook with validation"
      min_lines: 50
    - path: "apps/web/src/api/annotations.ts"
      provides: "Annotation submission API"
      exports: ["submitAnnotation"]
  key_links:
    - from: "apps/web/src/pages/AnnotatePage.tsx"
      to: "sonner toast"
      via: "toast.success import"
      pattern: "toast\\.success"
---

<objective>
Implement annotation submission with validation gate and manual advance flow.

Purpose: Complete the primary annotation workflow with validation, submission, and navigation.
Output: Submit button validates, submits annotation, shows toast, displays Next Task button.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-annotation-interface/09-CONTEXT.md
@.planning/phases/09-annotation-interface/09-03-SUMMARY.md
@apps/web/src/pages/AnnotatePage.tsx
@packages/@glyph/layout-runtime/src/validation/validators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sonner and create annotation submission API</name>
  <files>
    apps/web/package.json
    apps/web/src/api/annotations.ts
    apps/web/src/api/index.ts
    apps/web/src/main.tsx
  </files>
  <action>
Install sonner and create submission API:

cd apps/web and pnpm add sonner

**apps/web/src/api/annotations.ts:**
- SubmitAnnotationRequest: { data, time_spent_ms?, client_metadata? }
- submitAnnotation(taskId: string, request: SubmitAnnotationRequest): Promise&lt;Annotation&gt;
  - POST /tasks/{taskId}/annotations
- getNextTask(projectId?: string): Promise&lt;{ task_id: string } | null&gt;
  - GET /queue/next with optional project_id query param
  - Return null on 404

**Update apps/web/src/main.tsx:**
- Import Toaster from sonner
- Add &lt;Toaster /&gt; as sibling to App in render

Export from index.ts.
  </action>
  <verify>pnpm --filter web build compiles with sonner</verify>
  <done>Sonner installed and annotation API created</done>
</task>

<task type="auto">
  <name>Task 2: Create submit hook and update AnnotatePage</name>
  <files>
    apps/web/src/hooks/useAnnotationSubmit.ts
    apps/web/src/hooks/index.ts
    apps/web/src/pages/AnnotatePage.tsx
  </files>
  <action>
Create submission hook with validation:

**apps/web/src/hooks/useAnnotationSubmit.ts:**
- useAnnotationSubmit({ taskId, projectId, outputSchema, onClearDraft })
- Returns: { submit, isSubmitting, showNextButton, goToNext, validationErrors }
- On submit:
  1. If outputSchema provided, validate with validateWithSchema from @glyph/layout-runtime
  2. If validation fails, set validationErrors and throw Error('Validation failed')
  3. If valid, clear validationErrors
  4. Track time_spent_ms from startTimeRef
  5. Call submitAnnotation API
  6. On success: call onClearDraft(), toast.success('Submitted!'), setShowNextButton(true)
  7. On error (not validation): toast.error with message
- goToNext: fetches getNextTask, navigates to next task or /queue

**Update AnnotatePage.tsx:**
- Use useAnnotationSubmit hook
- Pass outputSchema from task.layout.output_schema
- Connect handleSubmit to submit function
- Display validationErrors near form (or use toast for simple display)
- When showNextButton is true:
  - Disable LayoutRenderer editing (pass readOnly or similar)
  - Replace Submit button with "Next Task" button that calls goToNext
  - Show success state in toolbar
  </action>
  <verify>Submit validates, shows toast, Next Task button appears after success</verify>
  <done>Submit flow working with validation and manual advance</done>
</task>

</tasks>

<verification>
- Submit with missing required fields shows validation errors
- Submit with valid data shows "Submitted!" toast
- "Next Task" button appears after submit
- Clicking Next Task navigates to queue or next task
- Draft is cleared after successful submit
</verification>

<success_criteria>
- Validation prevents submitting incomplete annotations
- Successful submit shows toast notification
- Next Task button appears (manual advance)
- Time spent is tracked and submitted
- Draft cleared on successful submit
</success_criteria>

<output>
After completion, create .planning/phases/09-annotation-interface/09-05-SUMMARY.md
</output>
