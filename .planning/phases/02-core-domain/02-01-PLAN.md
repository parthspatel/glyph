---
phase: 02-core-domain
plan: 01
title: Prefixed ID Types
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - libs/domain/Cargo.toml
  - libs/domain/src/lib.rs
  - libs/domain/src/ids.rs
autonomous: true
must_haves:
  truths:
    - "All entity types have type-safe prefixed IDs"
    - "IDs serialize to prefixed string format (e.g., user_01961a8e-...)"
    - "IDs can be parsed from prefixed strings with validation"
  artifacts:
    - path: "libs/domain/src/ids.rs"
      provides: "UserId, ProjectId, TaskId, AnnotationId, WorkflowId, TeamId, AssignmentId, QualityScoreId"
      min_lines: 150
  key_links:
    - from: "libs/domain/src/ids.rs"
      to: "uuid::Uuid"
      via: "newtype wrapper with v7 generation"
      pattern: "Uuid::now_v7"
---

# Plan 01: Prefixed ID Types

## Objective

Create type-safe prefixed ID types for all domain entities using UUID v7 for time-ordered generation.

Purpose: Foundation for all entity references â€” enables compile-time type safety and human-readable IDs.

Output: `libs/domain/src/ids.rs` module with all ID types and proper serialization.

## Context

@.planning/phases/02-core-domain/02-RESEARCH.md
@.planning/phases/02-core-domain/02-CONTEXT.md
@libs/domain/src/lib.rs

## Tasks

<task id="1">
<title>Enable UUID v7 feature in workspace</title>
<files>Cargo.toml</files>
<action>
Update workspace dependencies to enable v7 feature:

```toml
uuid = { version = "1.11", features = ["v4", "v7", "serde"] }
```
</action>
<verify>`cargo check -p glyph-domain` succeeds</verify>
<done>UUID v7 feature available in workspace</done>
</task>

<task id="2">
<title>Create prefixed ID module with macro</title>
<files>libs/domain/src/ids.rs</files>
<action>
Create `libs/domain/src/ids.rs` with:

1. `IdParseError` enum:
   - `MissingPrefix` - no underscore separator
   - `WrongPrefix { expected: &'static str, got: String }`
   - `InvalidUuid(uuid::Error)`

2. `define_prefixed_id!` macro generating:
   - Newtype struct wrapping `Uuid`
   - `const PREFIX: &'static str`
   - `fn new() -> Self` using `Uuid::now_v7()`
   - `fn from_uuid(uuid: Uuid) -> Self`
   - `fn as_uuid(&self) -> &Uuid`
   - `impl Display` -> `"{prefix}_{uuid}"`
   - `impl FromStr` with prefix validation
   - `impl Serialize/Deserialize` as string
   - Derives: `Clone, Debug, PartialEq, Eq, Hash`
   - `#[typeshare]` attribute

3. Define ID types:
   - `UserId` prefix `"user"`
   - `TeamId` prefix `"team"`
   - `ProjectId` prefix `"project"`
   - `TaskId` prefix `"task"`
   - `AnnotationId` prefix `"annotation"`
   - `WorkflowId` prefix `"workflow"`
   - `AssignmentId` prefix `"assignment"`
   - `QualityScoreId` prefix `"score"`

4. Unit tests for parse/display roundtrip, error cases.

Pattern from research:
```rust
impl FromStr for UserId {
    type Err = IdParseError;
    fn from_str(s: &str) -> Result<Self, Self::Err> {
        let (prefix, uuid_str) = s.split_once('_')
            .ok_or(IdParseError::MissingPrefix)?;
        if prefix != Self::PREFIX {
            return Err(IdParseError::WrongPrefix { 
                expected: Self::PREFIX, 
                got: prefix.to_string() 
            });
        }
        let uuid = Uuid::parse_str(uuid_str)?;
        Ok(Self(uuid))
    }
}
```
</action>
<verify>
- `cargo check -p glyph-domain` succeeds
- `cargo test -p glyph-domain ids` passes
</verify>
<done>All ID types defined with serialization and validation</done>
</task>

<task id="3">
<title>Export IDs from domain lib</title>
<files>libs/domain/src/lib.rs</files>
<action>
Add to `libs/domain/src/lib.rs`:
```rust
pub mod ids;
pub use ids::*;
```
</action>
<verify>`cargo check -p glyph-domain` with `use glyph_domain::UserId;` works</verify>
<done>ID types publicly exported from domain crate</done>
</task>

## Verification Criteria

- [ ] `cargo check -p glyph-domain` succeeds
- [ ] `UserId::new().to_string()` produces `user_{uuid-v7}` format
- [ ] `"user_01961a8e-7d3a-7f1c-9b2e-4a5c6d7e8f90".parse::<UserId>()` succeeds
- [ ] `"task_01961a8e-...".parse::<UserId>()` fails with WrongPrefix
- [ ] All 8 ID types defined and exported

## Success Criteria

Prefixed ID types compile, serialize correctly, and are ready for domain entities.

## Output

After completion, create `.planning/phases/02-core-domain/02-01-SUMMARY.md`
