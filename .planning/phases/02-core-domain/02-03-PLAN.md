---
phase: 02-core-domain
plan: 03
title: Update Domain Entities with Prefixed IDs
wave: 2
depends_on: ["02-01"]
files_modified:
  - libs/domain/src/user.rs
  - libs/domain/src/team.rs
  - libs/domain/src/project.rs
  - libs/domain/src/task.rs
  - libs/domain/src/annotation.rs
  - libs/domain/src/workflow.rs
  - libs/domain/src/quality.rs
  - libs/domain/src/enums.rs
  - migrations/0007_add_deleted_status.sql
  - migrations/0010_create_teams.sql
autonomous: true
must_haves:
  truths:
    - "All entity structs use prefixed ID types instead of Uuid"
    - "Status enums include 'deleted' variant for soft delete"
    - "Domain types have schema_version field for versioning"
  artifacts:
    - path: "libs/domain/src/user.rs"
      provides: "User struct with UserId"
      contains: "user_id: UserId"
    - path: "libs/domain/src/team.rs"
      provides: "Team struct with TeamId"
      contains: "team_id: TeamId"
    - path: "libs/domain/src/enums.rs"
      provides: "Status enums with deleted variant"
      contains: "deleted"
    - path: "migrations/0007_add_deleted_status.sql"
      provides: "Add deleted to status enums"
      min_lines: 10
    - path: "migrations/0010_create_teams.sql"
      provides: "Teams table migration"
      contains: "CREATE TABLE teams"
  key_links:
    - from: "libs/domain/src/user.rs"
      to: "libs/domain/src/ids.rs"
      via: "UserId import"
      pattern: "use crate::ids::UserId"
---

# Plan 03: Update Domain Entities with Prefixed IDs

## Objective

Update all domain entities to use prefixed ID types and add deleted status for soft delete support.

Purpose: Type-safe entity references and unified soft delete pattern across all entities.

Output: Updated domain structs with prefixed IDs and new migration for deleted status.

## Context

@.planning/phases/02-core-domain/02-CONTEXT.md (Soft Delete & Archiving)
@.planning/phases/02-core-domain/02-01-SUMMARY.md
@libs/domain/src/user.rs
@libs/domain/src/enums.rs

## Tasks

<task id="1">
<title>Add deleted status to enums</title>
<files>libs/domain/src/enums.rs, migrations/0007_add_deleted_status.sql</files>
<action>
1. Update `libs/domain/src/enums.rs` to add `Deleted` variant to status enums:

```rust
#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum UserStatus {
    Active,
    Inactive,
    Suspended,
    Deleted,  // Add this
}

#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum ProjectStatus {
    Draft,
    Active,
    Paused,
    Completed,
    Archived,
    Deleted,  // Add this
}

#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum TaskStatus {
    Pending,
    Assigned,
    InProgress,
    Review,
    Adjudication,
    Completed,
    Failed,
    Cancelled,
    Deleted,  // Add this
}

#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum AnnotationStatus {
    Draft,
    Submitted,
    Approved,
    Rejected,
    Superseded,
    Deleted,  // Add this
}
```

2. Create migration `migrations/0007_add_deleted_status.sql`:
```sql
-- Add deleted status to all entity status enums
ALTER TYPE user_status ADD VALUE IF NOT EXISTS 'deleted';
ALTER TYPE project_status ADD VALUE IF NOT EXISTS 'deleted';
ALTER TYPE task_status ADD VALUE IF NOT EXISTS 'deleted';
ALTER TYPE annotation_status ADD VALUE IF NOT EXISTS 'deleted';
ALTER TYPE assignment_status ADD VALUE IF NOT EXISTS 'deleted';
```
</action>
<verify>
- `cargo check -p glyph-domain` succeeds
- Migration file exists
</verify>
<done>All status enums include deleted variant</done>
</task>

<task id="2">
<title>Update User entity and create Team entity</title>
<files>libs/domain/src/user.rs, libs/domain/src/team.rs, libs/domain/src/lib.rs, migrations/0010_create_teams.sql</files>
<action>
1. Update `libs/domain/src/user.rs` to use prefixed ID types:
```rust
use crate::ids::{UserId, TeamId};

#[typeshare]
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct User {
    pub user_id: UserId,  // was Uuid
    pub email: String,
    pub display_name: String,
    pub status: UserStatus,
    pub skills: Vec<UserSkill>,
    pub roles: Vec<Role>,
    pub quality_profile: QualityProfile,
    #[serde(with = "chrono::serde::ts_milliseconds")]
    pub created_at: DateTime<Utc>,
    #[serde(with = "chrono::serde::ts_milliseconds")]
    pub updated_at: DateTime<Utc>,
}
```

2. Create `libs/domain/src/team.rs`:
```rust
use crate::ids::{TeamId, UserId};
use chrono::{DateTime, Utc};
use serde::{Deserialize, Serialize};
use typeshare::typeshare;

#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum TeamStatus {
    Active,
    Inactive,
    Deleted,
}

#[typeshare]
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Team {
    pub team_id: TeamId,
    pub name: String,
    pub description: Option<String>,
    pub leader_id: UserId,
    pub status: TeamStatus,
    pub capacity: Option<i32>,
    pub specializations: Vec<String>,
    #[serde(with = "chrono::serde::ts_milliseconds")]
    pub created_at: DateTime<Utc>,
    #[serde(with = "chrono::serde::ts_milliseconds")]
    pub updated_at: DateTime<Utc>,
}

#[typeshare]
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct TeamMembership {
    pub team_id: TeamId,
    pub user_id: UserId,
    pub role: TeamRole,
    pub allocation_percentage: Option<i32>,
    #[serde(with = "chrono::serde::ts_milliseconds")]
    pub joined_at: DateTime<Utc>,
}

#[typeshare]
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum TeamRole {
    Leader,
    Manager,
    Member,
}
```

3. Add to `libs/domain/src/lib.rs`:
```rust
pub mod team;
pub use team::*;
```

4. Create migration `migrations/0010_create_teams.sql`:
```sql
-- Create teams table
CREATE TYPE team_status AS ENUM ('active', 'inactive', 'deleted');
CREATE TYPE team_role AS ENUM ('leader', 'manager', 'member');

CREATE TABLE teams (
    team_id         TEXT PRIMARY KEY,
    name            VARCHAR(255) NOT NULL,
    description     TEXT,
    leader_id       TEXT NOT NULL REFERENCES users(user_id),
    status          team_status NOT NULL DEFAULT 'active',
    capacity        INTEGER,
    specializations JSONB NOT NULL DEFAULT '[]',
    created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE team_memberships (
    team_id              TEXT NOT NULL REFERENCES teams(team_id),
    user_id              TEXT NOT NULL REFERENCES users(user_id),
    role                 team_role NOT NULL DEFAULT 'member',
    allocation_percentage INTEGER,
    joined_at            TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (team_id, user_id)
);

CREATE INDEX idx_teams_leader ON teams(leader_id);
CREATE INDEX idx_team_memberships_user ON team_memberships(user_id);
```
</action>
<verify>
- `cargo check -p glyph-domain` succeeds
- Team module exports Team, TeamMembership, TeamStatus, TeamRole
- Migration file exists
</verify>
<done>User and Team entities use prefixed IDs</done>
</task>

<task id="3">
<title>Update remaining domain entities</title>
<files>libs/domain/src/project.rs, libs/domain/src/task.rs, libs/domain/src/annotation.rs, libs/domain/src/workflow.rs, libs/domain/src/quality.rs, libs/domain/src/goal.rs</files>
<action>
Update all remaining domain files to use prefixed ID types:

**project.rs:**
```rust
use crate::ids::{ProjectId, UserId, WorkflowId};

pub struct Project {
    pub project_id: ProjectId,  // was Uuid
    pub created_by: UserId,
    pub workflow_id: Option<WorkflowId>,
    // ...
}
```

**task.rs:**
```rust
use crate::ids::{TaskId, ProjectId, UserId, AssignmentId};

pub struct Task {
    pub task_id: TaskId,
    pub project_id: ProjectId,
    // ...
}

pub struct Assignment {
    pub assignment_id: AssignmentId,
    pub task_id: TaskId,
    pub user_id: UserId,
    // ...
}
```

**annotation.rs:**
```rust
use crate::ids::{AnnotationId, TaskId, UserId};

pub struct Annotation {
    pub annotation_id: AnnotationId,
    pub task_id: TaskId,
    pub created_by: UserId,
    // ...
}
```

**workflow.rs:**
```rust
use crate::ids::WorkflowId;

pub struct Workflow {
    pub workflow_id: WorkflowId,
    // ...
}
```

**quality.rs:**
```rust
use crate::ids::{QualityScoreId, UserId, TaskId, AnnotationId, ProjectId};

pub struct QualityScore {
    pub score_id: QualityScoreId,
    // entity_id remains String since it can reference different entity types
    // ...
}
```

**goal.rs:**
```rust
use crate::ids::ProjectId;
// Update any ID fields
```

Ensure all foreign key references use the appropriate prefixed ID type.
</action>
<verify>
- `cargo check -p glyph-domain` succeeds
- All ID fields use prefixed types
</verify>
<done>All domain entities use prefixed ID types</done>
</task>

## Verification Criteria

- [ ] `cargo check -p glyph-domain` succeeds
- [ ] No `Uuid` type used directly for entity IDs
- [ ] All status enums have `Deleted` variant
- [ ] Migration 0007 exists

## Success Criteria

Domain entities are type-safe with prefixed IDs and support soft delete via status.

## Output

After completion, create `.planning/phases/02-core-domain/02-03-SUMMARY.md`
