---
phase: 09.1-project-configuration-experience
plan: 03
type: execute
wave: 2
depends_on: ["09.1-01", "09.1-02"]
files_modified:
  - apps/web/src/components/workflow/Sidebar/NodePalette.tsx
  - apps/web/src/components/workflow/Canvas/WorkflowCanvas.tsx
  - apps/web/src/components/workflow/hooks/useCanvasActions.ts
autonomous: true

must_haves:
  truths:
    - "User can drag node from palette onto canvas"
    - "User can connect nodes by dragging between handles"
    - "Shift+click and marquee selection both work"
  artifacts:
    - path: "apps/web/src/components/workflow/Sidebar/NodePalette.tsx"
      provides: "Draggable step type palette"
      exports: ["NodePalette"]
    - path: "apps/web/src/components/workflow/hooks/useCanvasActions.ts"
      provides: "Canvas action handlers"
      exports: ["useCanvasActions"]
  key_links:
    - from: "NodePalette.tsx"
      to: "WorkflowCanvas.tsx"
      via: "onDrop handler"
      pattern: "onDrop"
---

<objective>
Implement node palette sidebar with drag-and-drop, and wire up canvas interactions for connecting nodes.

Purpose: Users need to add nodes from a palette and connect them with transitions. This is the core interaction model for the workflow designer.

Output: Functional drag-drop from sidebar to canvas, node connections via handle dragging.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-project-configuration-experience/09.1-CONTEXT.md
@.planning/phases/09.1-project-configuration-experience/09.1-01-SUMMARY.md
@.planning/phases/09.1-project-configuration-experience/09.1-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NodePalette sidebar component</name>
  <files>
apps/web/src/components/workflow/Sidebar/NodePalette.tsx
apps/web/src/components/workflow/Sidebar/index.ts
  </files>
  <action>
Create NodePalette.tsx as left sidebar (per CONTEXT.md):
- Fixed width sidebar (w-64) with scrollable content
- Grouped sections: "Start/End", "Steps", "Control Flow"
- Each palette item:
  - Icon matching node type
  - Label (e.g., "Annotation", "Review")
  - draggable="true"
  - onDragStart: set dataTransfer with node type
- Use HTML5 drag and drop API
- Style: hover highlight, cursor grab/grabbing

Palette items:
1. Start/End group: Start, End
2. Steps group: Annotation, Review, Adjudication, Auto Process
3. Control Flow group: Condition, Fork, Join, Sub-workflow

Add search/filter input at top to filter palette items.
  </action>
  <verify>Palette renders with all node types, items are draggable</verify>
  <done>NodePalette shows grouped draggable items with icons</done>
</task>

<task type="auto">
  <name>Task 2: Implement canvas drop handling and node creation</name>
  <files>
apps/web/src/components/workflow/Canvas/WorkflowCanvas.tsx
apps/web/src/components/workflow/hooks/useCanvasActions.ts
  </files>
  <action>
Create useCanvasActions.ts hook with:
- createNode(type, position): creates new node with unique ID, adds to store
- deleteNodes(ids): removes nodes and connected edges
- duplicateNodes(ids): copies selected nodes with offset
- autoArrange(): uses dagre layout algorithm to reorganize nodes

Update WorkflowCanvas.tsx:
1. Add onDragOver handler: e.preventDefault() to allow drop
2. Add onDrop handler:
   - Get node type from dataTransfer
   - Calculate drop position using screenToFlowPosition
   - Call createNode(type, position)
3. Wire up onConnect to create edges in store
4. Add connection validation:
   - Prevent self-connections
   - Prevent duplicate connections
   - Start node: source only, End node: target only
5. Add "Auto Layout" button that calls autoArrange()

Install dagre for auto-layout: `pnpm add dagre @types/dagre`
  </action>
  <verify>Drag node from palette to canvas creates new node at drop position</verify>
  <done>Nodes can be added via drag-drop, auto-layout works</done>
</task>

<task type="auto">
  <name>Task 3: Implement selection modes and copy/paste</name>
  <files>
apps/web/src/components/workflow/Canvas/WorkflowCanvas.tsx
apps/web/src/components/workflow/hooks/useCanvasActions.ts
  </files>
  <action>
Enhance WorkflowCanvas for selection:
1. Marquee selection already enabled via selectionOnDrag
2. Add Shift+click multi-select handling
3. Track selected nodes/edges in canvasStore

Implement copy/paste in useCanvasActions:
- copyNodes(): serialize selected nodes to clipboard (JSON)
- pasteNodes(): deserialize from clipboard, create with new IDs, offset position
- duplicateNodes(): copy + paste in one action

Wire keyboard shortcuts (using react-hotkeys-hook):
- Ctrl+C: copyNodes
- Ctrl+V: pasteNodes  
- Ctrl+D: duplicateNodes
- Delete/Backspace: deleteNodes (already wired)
- Ctrl+A: select all nodes

Update canvasStore with:
- clipboard state
- selection state helpers
  </action>
  <verify>Copy/paste works, multi-select via shift+click and marquee works</verify>
  <done>Full selection and clipboard functionality working</done>
</task>

</tasks>

<verification>
1. Drag "Annotation" from palette to canvas, node appears
2. Connect two nodes by dragging between handles
3. Ctrl+C, Ctrl+V duplicates selected nodes
4. Marquee selection selects multiple nodes
</verification>

<success_criteria>
- Palette shows all node types organized by category
- Drag-drop from palette creates nodes
- Nodes connect via handle dragging
- Copy/paste/duplicate work with keyboard shortcuts
- Auto-layout button reorganizes canvas
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-project-configuration-experience/09.1-03-SUMMARY.md`
</output>
