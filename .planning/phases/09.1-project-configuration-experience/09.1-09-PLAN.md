---
phase: 09.1-project-configuration-experience
plan: 09
type: execute
wave: 5
depends_on: ["09.1-03", "09.1-06", "09.1-08"]
files_modified:
  - apps/web/src/components/workflow/Validation/ValidationEngine.ts
  - apps/web/src/components/workflow/Validation/ProblemsPanel.tsx
  - apps/web/src/components/workflow/hooks/useWorkflowValidation.ts
autonomous: true

must_haves:
  truths:
    - "Invalid nodes show red badge"
    - "Problems panel lists all issues with links"
    - "All paths from Start reach End"
  artifacts:
    - path: "apps/web/src/components/workflow/Validation/ValidationEngine.ts"
      provides: "Workflow validation logic"
      exports: ["validateWorkflow", "ValidationResult"]
    - path: "apps/web/src/components/workflow/Validation/ProblemsPanel.tsx"
      provides: "Problems list panel"
      exports: ["ProblemsPanel"]
  key_links:
    - from: "ValidationEngine.ts"
      to: "canvasStore.ts"
      via: "validates nodes/edges"
      pattern: "nodes|edges"
---

<objective>
Create validation engine and problems panel for workflow configuration.

Purpose: Per CONTEXT.md, problem nodes show red badges and a problems panel lists all issues with links to nodes. Validation ensures all steps connect properly and have required configuration.

Output: Validation engine that runs on changes, problems panel with clickable issue list.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-project-configuration-experience/09.1-CONTEXT.md
@.planning/phases/09.1-project-configuration-experience/09.1-03-SUMMARY.md
@.planning/phases/09.1-project-configuration-experience/09.1-06-SUMMARY.md
@libs/workflow-engine/src/parser/validator.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationEngine with comprehensive rules</name>
  <files>
apps/web/src/components/workflow/Validation/ValidationEngine.ts
apps/web/src/components/workflow/Validation/types.ts
  </files>
  <action>
Create types.ts:
```typescript
interface ValidationIssue {
  id: string;
  nodeId?: string;
  edgeId?: string;
  severity: 'error' | 'warning';
  category: 'structure' | 'config' | 'data_flow';
  message: string;
  suggestion?: string;
}

interface ValidationResult {
  valid: boolean;
  issues: ValidationIssue[];
  nodeErrors: Map<string, ValidationIssue[]>;
  edgeErrors: Map<string, ValidationIssue[]>;
}
```

Create ValidationEngine.ts with rules:

Structure validation:
- Must have exactly one Start node
- Must have at least one End node
- All nodes must be reachable from Start (BFS/DFS)
- All nodes must have path to End (reverse BFS)
- No orphan nodes
- No cycles (unless explicitly allowed)

Config validation per step type:
- Annotation: layout_id required
- Review: layout_id required
- Adjudication: layout_id required, threshold between 0-1
- Condition: expression required and valid
- Fork: must have 2+ outgoing edges
- Join: must have 2+ incoming edges

Data flow validation:
- Input references must exist
- Output types must match expected schema
- No undefined step references

Return ValidationResult with categorized issues.
  </action>
  <verify>Validation catches missing layout, disconnected nodes, invalid config</verify>
  <done>Validation engine with structure, config, data flow rules</done>
</task>

<task type="auto">
  <name>Task 2: Create useWorkflowValidation hook with debounced validation</name>
  <files>
apps/web/src/components/workflow/hooks/useWorkflowValidation.ts
apps/web/src/components/workflow/stores/canvasStore.ts
  </files>
  <action>
Create useWorkflowValidation.ts hook:
- Subscribe to canvasStore (nodes, edges) and configStore changes
- Debounce validation (500ms) to avoid constant re-validation
- Run ValidationEngine.validate()
- Store results in validation state
- Expose: issues, nodeErrors, isValid, validateNow()

Update canvasStore.ts:
- Add validationState: { nodeErrors: Map, edgeErrors: Map }
- Add action: setValidationState

Update node components to show validation state:
- Import validation state from store
- If node has errors, show red badge in top-right
- Badge shows error count
- Tooltip on hover shows first error message
  </action>
  <verify>Add node without layout - red badge appears after debounce</verify>
  <done>Validation runs on changes, node badges update</done>
</task>

<task type="auto">
  <name>Task 3: Create ProblemsPanel with clickable issues</name>
  <files>
apps/web/src/components/workflow/Validation/ProblemsPanel.tsx
apps/web/src/components/workflow/Validation/index.ts
apps/web/src/components/workflow/WorkflowDesigner.tsx
  </files>
  <action>
Create ProblemsPanel.tsx (per CONTEXT.md "Problems panel at bottom"):
- Collapsible panel at bottom of canvas
- Header shows: "Problems (N)" with error/warning counts
- Grouped by category: Structure, Configuration, Data Flow
- Each issue shows:
  - Severity icon (red X for error, yellow ! for warning)
  - Message
  - Node/step name (clickable)
  - "Fix" suggestion if available
- Click on issue:
  - Scrolls to and selects the node
  - Opens config panel if config issue
- Filter buttons: All | Errors | Warnings

Panel styling:
- Max height: 200px
- Scrollable issue list
- Collapse/expand toggle
- Auto-expand when new errors appear

Create index.ts barrel export.

Update WorkflowDesigner.tsx:
- Add ProblemsPanel below canvas
- Pass validation issues from useWorkflowValidation
  </action>
  <verify>Click issue - canvas scrolls to node, node selected</verify>
  <done>Problems panel shows issues with navigation</done>
</task>

</tasks>

<verification>
1. Create workflow with disconnected node - see "Unreachable node" error
2. Add annotation without layout - see "Layout required" error
3. Click error in problems panel - canvas navigates to node
4. Fix error - it disappears from panel
</verification>

<success_criteria>
- Validation runs automatically (debounced)
- Red badges on invalid nodes
- Problems panel lists all issues
- Click issue navigates to node
- Categories: Structure, Configuration, Data Flow
- Filter by severity
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-project-configuration-experience/09.1-09-SUMMARY.md`
</output>
