# Phase 9.1 Research: Project Configuration Experience

**Generated:** 2026-02-04
**Confidence:** HIGH

## Standard Stack

### Visual Workflow Canvas

- **React Flow 12.10.0** (@xyflow/react) — Industry standard for node-based UIs
  - Used by n8n, other production workflow builders
  - Built-in performance optimization, accessibility, SSR support
  - Comprehensive documentation
  - Already used in similar projects in codebase ecosystem

### Dual Editing (Visual + YAML)

- **monaco-yaml** — Combines Monaco Editor with yaml-language-server
  - Full IDE experience: schema validation, autocomplete, formatting
  - Monaco already in codebase from Phase 8
- **Bidirectional conversion** — YAML ↔ Visual requires careful state management
  - Preserve user formatting when possible
  - Use js-yaml for parsing/serialization

### State Management

- **Zustand** (already in codebase) — Separate stores for:
  - Canvas state (nodes, edges, viewport)
  - Configuration state (step configs, data mappings)
- **Benefits:**
  - Independent undo/redo stacks per user decision
  - Prevents unnecessary re-renders
  - React Flow uses Zustand internally (natural fit)

## Architecture Patterns

### Canvas Component Structure

```
WorkflowDesigner/
├── Canvas/
│   ├── WorkflowCanvas.tsx      # React Flow wrapper
│   ├── nodes/                   # Custom node components
│   │   ├── StartNode.tsx
│   │   ├── EndNode.tsx
│   │   ├── AnnotationNode.tsx
│   │   ├── ReviewNode.tsx
│   │   ├── AdjudicationNode.tsx
│   │   ├── AutoProcessNode.tsx
│   │   ├── ConditionNode.tsx
│   │   ├── ForkNode.tsx
│   │   ├── JoinNode.tsx
│   │   └── SubWorkflowNode.tsx
│   └── edges/
│       └── TransitionEdge.tsx
├── Sidebar/
│   ├── NodePalette.tsx          # Draggable step types
│   └── Minimap.tsx
├── ConfigPanel/
│   ├── StepConfigPanel.tsx      # 3/4 width slide-out
│   ├── LayoutAssignment.tsx
│   ├── ConsensusConfig.tsx
│   ├── AssignmentConfig.tsx
│   └── CompletionCriteria.tsx
├── ProblemsPanel/
│   └── ValidationProblems.tsx
└── stores/
    ├── canvasStore.ts           # Nodes, edges, viewport
    └── configStore.ts           # Step configurations
```

### Performance Critical Patterns

From React Flow documentation:

1. **Memoize all custom components** — Nodes, edges, controls
2. **Selective Zustand subscriptions** — Don't subscribe to entire store
3. **Avoid direct nodes/edges access** — Use selectors
4. **Virtualization** — React Flow handles this, but keep node content simple

### Template Security (Nunjucks)

- Enable `autoescape` configuration
- Restrict available context/filters
- Validate expressions before saving
- Execute with timeouts to prevent infinite loops

## Technology Recommendations

| Component | Library | Rationale |
|-----------|---------|-----------|
| Visual Canvas | @xyflow/react 12.x | Industry standard, used by n8n |
| YAML Editor | Monaco + monaco-yaml | Already in codebase, schema support |
| State | Zustand | Already in codebase, React Flow uses it |
| Forms | React Hook Form + Zod | Already in codebase |
| UI | shadcn/ui | Already in codebase |
| YAML Parse | js-yaml | Standard, lightweight |
| Schema Validation | Ajv | Already in codebase |

## Open Questions for Planning

1. **Workflow Testing with Claude + Playwright:** 
   - Integration pattern unclear
   - May need backend orchestration
   - Recommend: stub testing UI, defer automation to future iteration

2. **Collaborative Editing:**
   - Y.js mentioned but scope unclear for Phase 9.1
   - Recommend: single-user editing for v1, add collaboration later

3. **Sub-Workflow Expansion:**
   - Recommend: collapsible container with breadcrumb navigation

## Implementation Order Recommendation

1. Canvas foundation (React Flow + custom nodes)
2. Zustand state management
3. Step configuration panel
4. YAML editor with sync
5. Data source configuration
6. Data flow mapping
7. Validation and problems panel
8. Workflow testing (basic)
9. Activation checklist

---

*Ready for planning with HIGH confidence.*
