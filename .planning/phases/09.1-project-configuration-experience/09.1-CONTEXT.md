# Phase 9.1: Project Configuration Experience - Context

**Gathered:** 2026-02-04
**Status:** Ready for planning

<domain>
## Phase Boundary

Complete, polished experience for configuring projects with data sources, layouts, and workflows before activation. Users can design workflows visually, configure data flow between steps, test workflows with transient data, and validate configuration before going active. This is the project setup experience during the Draft phase.

**Scope includes:**
- Workflow designer (visual builder + YAML alternative)
- Data source configuration
- Layout-to-step binding
- Data flow mapping between steps
- Workflow testing mode (transient, not saved)
- Project activation checklist and validation

**Scope excludes:**
- Actual workflow execution (Phase 6 complete)
- Annotation interface (Phase 9 complete)
- Quality management configuration (Phase 10)

</domain>

<decisions>
## Implementation Decisions

### Workflow Designer Canvas

- **Visual canvas like n8n** — Primary interface is drag-and-drop visual builder
- **Tab toggle: Visual | YAML** — Switch between visual and YAML representations; edits sync when switching tabs
- **Sidebar palette** — Left sidebar with draggable step types (Annotation, Review, Adjudication, Auto-process, Condition, Sub-workflow, Fork, Join)
- **Slide-out panel (3/4 width)** — Selecting a node opens a generous right panel for step configuration
- **Click-and-drag connectors** — Drag from output port to input port to create transitions

### Canvas Navigation & Editing

- **Snap to grid** — Nodes snap to invisible grid for alignment
- **Auto-arrange on demand** — "Auto Layout" button reorganizes canvas cleanly
- **Scroll to zoom, drag to pan** — Standard canvas navigation
- **Minimap** — Corner minimap for orientation in large workflows
- **Reset/fit-to-view button** — One-click to reset zoom and center canvas
- **Standard shortcuts** — Ctrl+C/V for copy/paste, Ctrl+D for duplicate
- **Shift+click AND marquee selection** — Both multi-select methods supported
- **Separate undo stacks** — Canvas actions and panel config changes have separate undo histories

### State Diagram Structure

- **Start node (filled black circle)** — Classic UML style, labeled "Start"
- **End node (bullseye)** — Classic UML style, labeled with outcome (e.g., "Completed", "Rejected")
- **Multiple End nodes allowed** — Support different terminal states for branching workflows
- **All steps must connect** — Every step reachable from Start, every path leads to End (at least transitively)

### Special Node Types

- **Condition node** — Dedicated node type for branching logic (not inline on transitions)
- **Fork node** — Explicit node to split into parallel branches
- **Join node** — Explicit node to merge parallel branches; configurable: "Wait for all", "Wait for N of M", "First to complete wins"
- **Sub-workflow node** — Collapsed by default; double-click to expand inline on canvas
- **Parallel group visual** — Swimlane container around parallel steps for clarity

### Step Configuration Panel

- **Layout assignment** — Dropdown with preview thumbnails; "Create Layout" link to layout editor
- **Inline layout preview** — Small live preview of assigned layout in panel
- **Consensus config** — Metric, threshold, on_agreement, on_disagreement (per PRD §4.8.2)
- **Assignment config** — Mode, skills, roles, load balancing (per PRD §4.3.3)
- **Completion criteria** — Count, unique annotators, timeout (per PRD §4.3.1)

### Validation & Errors

- **Red badges on nodes** — Problem nodes show red indicator
- **Problems panel** — Dedicated panel at bottom listing all issues with links to nodes
- **Both visual + list** — At-a-glance badges plus comprehensive list

### Templates & Reuse

- **Template gallery on create** — Starter templates when creating new workflow
- **Save as template** — Users can save workflows as reusable templates

### Data Source Configuration

- **Wizard for first-time setup** — Step-by-step guided flow
- **Form for edits** — Direct form access for quick changes
- **Import from file** — Upload JSON/CSV, infer schema with manual adjustments
- **JSON Schema editor** — Monaco editor for both input and output schemas (same experience for both)
- **Single row focus** — Preview one data row at a time with prev/next navigation
- **JSON view with syntax highlighting** — Raw data structure display

### Data Flow Mapping

- **Nunjucks template syntax** — `{{ steps.annotate.output.entities }}` style expressions
- **Full ETL capability** — Nunjucks supports filters, conditionals, loops for complex transformations
- **Monaco autocomplete** — Path suggestions for available steps, fields, context
- **Live preview while typing** — Real-time preview of transformed output
- **Diff view** — Side-by-side input → transformed output comparison
- **Strict type checking** — Output schema must match input schema exactly; errors block save

### Schema Versioning

- **Versioned schemas** — Schema changes create new version
- **Existing tasks keep old version** — No breaking in-flight work
- **New tasks use new version** — Clean separation

### Workflow Testing Mode

- **Entry points:** "Test Workflow" button, dedicated Test tab, right-click "Test from here"
- **Data selection:** Pick from source, paste custom JSON, or generate synthetic
- **Hybrid execution:** Switch between automatic (Claude + Playwright) and manual at any time
- **Pause/resume:** Pause automatic to take over manually, or hand off to automation
- **Split view** — Canvas on left (current step highlighted), results panel on right
- **Overlay on canvas** — Data flows visualized on connections, results on nodes
- **Blocking modal on error** — Pause execution, show details, offer retry/skip/abort
- **Inline error icon** — Error indicator stays on node after modal dismissed
- **Auto-assign roles** — System picks appropriate role based on step configuration
- **Quick fill for multi-annotator** — Provide one annotation, system generates variations for others
- **Before/after panels** — Show input/output JSON per transformation
- **Diff view** — Highlight changes between step input/output
- **Transformation trace** — Show Nunjucks expression evaluation step-by-step
- **Embedded preview** — Layout renders inline in test panel for quick interaction
- **Full-screen preview** — "Preview as Annotator" opens actual annotation interface in modal
- **Ephemeral results** — Test data disappears when session ends
- **Export report** — Option to generate PDF/JSON report of test run
- **"--- TEST MODE ---" banner** — Small banner at top during testing

### Activation Checklist

- **Modal on "Activate Project"** — Checklist appears in animated modal
- **Organized by category + priority** — Sections (Workflow, Data Source, Layouts, Permissions) with blockers first
- **Icons for severity** — Red ✕ blockers, yellow ⚠ warnings, green ✓ complete
- **Direct link navigation** — Click item to jump to relevant config
- **Auto-close on success** — Modal closes when all blockers resolved
- **Brief confirmation dialog** — "Are you sure?" before activating
- **Redirect to dashboard** — Navigate to project dashboard after activation
- **Success modal with next steps** — Celebratory modal showing what to do next (invite annotators, etc.)

### Claude's Discretion

- Exact animation style for activation modal
- Specific minimap positioning and styling
- Problems panel exact layout
- Template gallery visual design
- Test report format details
- Loading states and skeletons

</decisions>

<specifics>
## Specific Ideas

- "Visual canvas like n8n" — Reference n8n's node-based workflow builder aesthetic
- "Slide-out panel may need to be 3/4" — Generous space for complex step configuration
- "State diagram conventions" — Start (filled circle) and End (bullseye) as explicit placeholders
- "Nunjucks allows full ETL transformers" — Not just simple mappings; users can build custom JSON-to-JSON transforms
- "Animate the activation modal" — Polished, satisfying experience for going live
- "Claude + Playwright for automatic testing" — AI-assisted test execution

</specifics>

<prd_alignment>
## PRD Alignment Verification

| Decision | PRD Reference | Alignment |
|----------|---------------|-----------|
| Step types | §4.3, §13.2.3 StepType enum | ✅ Exact match |
| Nested workflows | §4.2.4 | ✅ input_mapping, output_mapping supported |
| Parallel execution | §4.8.4 parallel_group, join_mode | ✅ Extends with visual Fork/Join |
| Condition step | §4.8.2 type: conditional | ✅ Matches |
| Entry/exit points | §4.8.1 entry_step, exit_steps | ✅ Visualized as Start/End nodes |
| Multiple exits | §4.8.1 exit_steps array | ✅ Matches |
| Layout per step | §4.8.2 layout_id | ✅ Matches |
| Consensus config | §4.2.2, §4.8.2 | ✅ Matches |
| Assignment config | §4.3.3 | ✅ Matches |
| Completion criteria | §4.3.1 | ✅ Matches |
| Workflow templates | §4.8.6 | ✅ Matches |
| YAML structure | §4.8.1 | ✅ Preserved in YAML view |
| Project lifecycle | §3.1 Draft → Active | ✅ Matches |
| Input/output mapping | §4.7.2 | ✅ Template expressions supported |

</prd_alignment>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 09.1-project-configuration-experience*
*Context gathered: 2026-02-04*
