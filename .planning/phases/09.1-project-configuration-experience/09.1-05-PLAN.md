---
phase: 09.1-project-configuration-experience
plan: 05
type: execute
wave: 3
depends_on: ["09.1-01", "09.1-03"]
files_modified:
  - apps/web/src/components/workflow/YamlEditor/WorkflowYamlEditor.tsx
  - apps/web/src/components/workflow/hooks/useYamlSync.ts
  - apps/web/src/components/workflow/converters/canvasToYaml.ts
  - apps/web/src/components/workflow/converters/yamlToCanvas.ts
autonomous: true

must_haves:
  truths:
    - "User can toggle between Visual and YAML tabs"
    - "Changes in YAML reflect on canvas when switching tabs"
    - "Changes on canvas reflect in YAML when switching tabs"
  artifacts:
    - path: "apps/web/src/components/workflow/YamlEditor/WorkflowYamlEditor.tsx"
      provides: "Monaco-based YAML editor"
      exports: ["WorkflowYamlEditor"]
    - path: "apps/web/src/components/workflow/converters/canvasToYaml.ts"
      provides: "Canvas to YAML conversion"
      exports: ["canvasToYaml"]
    - path: "apps/web/src/components/workflow/converters/yamlToCanvas.ts"
      provides: "YAML to canvas conversion"
      exports: ["yamlToCanvas"]
  key_links:
    - from: "useYamlSync.ts"
      to: "canvasStore.ts"
      via: "bidirectional sync"
      pattern: "useCanvasStore|canvasToYaml|yamlToCanvas"
---

<objective>
Create YAML editor with bidirectional sync to the visual canvas.

Purpose: Per CONTEXT.md, users can toggle between Visual and YAML views. Changes sync when switching tabs. Advanced users prefer YAML for complex workflows.

Output: Monaco YAML editor with full sync to canvas state.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-project-configuration-experience/09.1-CONTEXT.md
@.planning/phases/09.1-project-configuration-experience/09.1-01-SUMMARY.md
@.planning/phases/09.1-project-configuration-experience/09.1-03-SUMMARY.md
@libs/workflow-engine/src/config/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create canvas-to-YAML and YAML-to-canvas converters</name>
  <files>
apps/web/src/components/workflow/converters/canvasToYaml.ts
apps/web/src/components/workflow/converters/yamlToCanvas.ts
apps/web/src/components/workflow/converters/index.ts
  </files>
  <action>
Create canvasToYaml.ts:
- Input: nodes, edges, stepConfigs from stores
- Output: YAML string matching WorkflowConfig schema
- Map node types to step_type enum values
- Generate step IDs from node IDs
- Build transitions array from edges
- Include position metadata as comments or x/y fields for round-trip
- Use js-yaml dump() with custom schema for nice formatting

Create yamlToCanvas.ts:
- Input: YAML string
- Output: { nodes, edges, stepConfigs } for stores
- Parse with js-yaml
- Validate against WorkflowConfig structure
- Generate node positions:
  - Use stored x/y if present
  - Otherwise use dagre auto-layout
- Map steps to nodes with appropriate types
- Map transitions to edges
- Return validation errors if YAML is invalid

Handle edge cases:
- Missing start/end nodes (add them)
- Cycles (allow - validation catches later)
- Unknown step types (use generic node)
  </action>
  <verify>Convert canvas to YAML, then back - nodes and edges match</verify>
  <done>Bidirectional conversion working with position preservation</done>
</task>

<task type="auto">
  <name>Task 2: Create WorkflowYamlEditor with Monaco</name>
  <files>
apps/web/src/components/workflow/YamlEditor/WorkflowYamlEditor.tsx
apps/web/src/components/workflow/YamlEditor/index.ts
  </files>
  <action>
Create WorkflowYamlEditor.tsx using @monaco-editor/react:
- Full height editor with YAML syntax highlighting
- Configure Monaco options:
  - theme: match app theme (vs-dark for dark mode)
  - minimap: enabled
  - lineNumbers: on
  - wordWrap: on
  - tabSize: 2
- Add YAML schema validation using monaco-yaml if available, otherwise basic syntax
- Show validation errors inline (red squiggles)
- Add toolbar above editor:
  - Format button (auto-format YAML)
  - Copy button
  - Download button (export .yaml file)

On mount, load current workflow as YAML using canvasToYaml.
On change, store YAML locally (don't sync on every keystroke).
  </action>
  <verify>Editor shows YAML with syntax highlighting, validation errors shown</verify>
  <done>Monaco YAML editor with formatting and validation</done>
</task>

<task type="auto">
  <name>Task 3: Implement tab toggle and sync on tab switch</name>
  <files>
apps/web/src/components/workflow/hooks/useYamlSync.ts
apps/web/src/components/workflow/WorkflowDesigner.tsx
  </files>
  <action>
Create useYamlSync.ts hook:
- Manages current tab state: "visual" | "yaml"
- On switch to YAML: convert canvas to YAML, update editor
- On switch to Visual: parse YAML, validate, update canvas stores
- Handle sync errors:
  - If YAML invalid, show error toast, stay on YAML tab
  - If sync fails, offer to discard changes or stay
- Track dirty state independently for each view

Create WorkflowDesigner.tsx as main container:
- Tab bar at top: "Visual" | "YAML" (use Tabs from shadcn)
- Visual tab: NodePalette (left) + WorkflowCanvas (center) + StepConfigPanel (right)
- YAML tab: WorkflowYamlEditor (full width)
- Use useYamlSync for tab management

Layout for Visual tab:
```tsx
<div className="flex h-full">
  <NodePalette className="w-64 border-r" />
  <div className="flex-1 relative">
    <WorkflowCanvas />
  </div>
  <StepConfigPanel />
</div>
```
  </action>
  <verify>Switch tabs - visual changes appear in YAML and vice versa</verify>
  <done>Tab toggle syncs state bidirectionally</done>
</task>

</tasks>

<verification>
1. Add nodes on canvas, switch to YAML - see nodes in YAML
2. Edit YAML to add a step, switch to Visual - see new node
3. Invalid YAML shows error, doesn't break canvas
</verification>

<success_criteria>
- Visual/YAML tab toggle works
- Canvas state serializes to valid YAML
- YAML parses to valid canvas state
- Positions preserved on round-trip
- Validation errors shown inline in YAML editor
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-project-configuration-experience/09.1-05-SUMMARY.md`
</output>
