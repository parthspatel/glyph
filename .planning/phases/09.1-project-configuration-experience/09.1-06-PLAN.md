---
phase: 09.1-project-configuration-experience
plan: 06
type: execute
wave: 3
depends_on: ["09.1-04"]
files_modified:
  - apps/web/src/components/workflow/ConfigPanel/forms/LayoutAssignment.tsx
  - apps/web/src/components/workflow/ConfigPanel/forms/ConsensusConfig.tsx
  - apps/web/src/components/workflow/ConfigPanel/forms/AssignmentConfig.tsx
  - apps/web/src/components/workflow/ConfigPanel/forms/CompletionCriteria.tsx
  - apps/web/src/components/workflow/ConfigPanel/forms/ConditionEditor.tsx
autonomous: true

must_haves:
  truths:
    - "User can assign layout to step from dropdown"
    - "User can configure consensus threshold"
    - "User can set completion criteria"
  artifacts:
    - path: "apps/web/src/components/workflow/ConfigPanel/forms/LayoutAssignment.tsx"
      provides: "Layout assignment with preview"
      exports: ["LayoutAssignment"]
    - path: "apps/web/src/components/workflow/ConfigPanel/forms/ConsensusConfig.tsx"
      provides: "Consensus configuration form"
      exports: ["ConsensusConfig"]
  key_links:
    - from: "LayoutAssignment.tsx"
      to: "/api/v1/layouts"
      via: "useQuery"
      pattern: "useQuery.*layouts"
---

<objective>
Create the step configuration forms for layout assignment, consensus, assignment rules, and completion criteria.

Purpose: Each workflow step needs detailed configuration. Per CONTEXT.md, the panel includes layout assignment with preview thumbnails, consensus config, assignment config, and completion criteria.

Output: Complete configuration forms for all step types.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-project-configuration-experience/09.1-CONTEXT.md
@.planning/phases/09.1-project-configuration-experience/09.1-04-SUMMARY.md
@libs/workflow-engine/src/config/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LayoutAssignment form with preview</name>
  <files>
apps/web/src/components/workflow/ConfigPanel/forms/LayoutAssignment.tsx
apps/web/src/components/workflow/ConfigPanel/forms/LayoutPreviewThumbnail.tsx
  </files>
  <action>
Create LayoutAssignment.tsx:
- Fetch available layouts using useQuery to /api/v1/layouts
- Dropdown select with layout options
- Each option shows: layout name, version, thumbnail preview
- "Create Layout" link that opens layout editor (new tab or modal)
- On select, update stepConfig.layout_id via useStepConfig

Create LayoutPreviewThumbnail.tsx:
- Small (150x100) iframe or static preview of layout
- Shows simplified version of layout template
- Fallback to placeholder if preview unavailable

Form layout:
```tsx
<div className="space-y-4">
  <Label>Assigned Layout</Label>
  <Select value={config.layout_id} onValueChange={handleLayoutChange}>
    {layouts.map(layout => (
      <SelectItem key={layout.id} value={layout.id}>
        <div className="flex items-center gap-2">
          <LayoutPreviewThumbnail layout={layout} />
          <span>{layout.name} v{layout.version}</span>
        </div>
      </SelectItem>
    ))}
  </Select>
  {config.layout_id && (
    <div className="mt-4 border rounded p-4">
      <h4>Preview</h4>
      <LayoutPreviewThumbnail layout={selectedLayout} size="large" />
    </div>
  )}
  <Button variant="link" asChild>
    <Link to="/admin/layouts/new">+ Create New Layout</Link>
  </Button>
</div>
```
  </action>
  <verify>Dropdown shows layouts, selecting updates config, preview shows</verify>
  <done>Layout assignment with thumbnails and preview working</done>
</task>

<task type="auto">
  <name>Task 2: Create ConsensusConfig and AssignmentConfig forms</name>
  <files>
apps/web/src/components/workflow/ConfigPanel/forms/ConsensusConfig.tsx
apps/web/src/components/workflow/ConfigPanel/forms/AssignmentConfig.tsx
  </files>
  <action>
Create ConsensusConfig.tsx (per PRD ยง4.8.2):
- Agreement Metric dropdown: "Exact Match", "Cohen's Kappa", "Krippendorff's Alpha", "IoU"
- Threshold slider: 0.0 to 1.0 with step 0.05
- On Agreement dropdown: "auto_complete", "send_to_review", "next_step"
- On Disagreement dropdown: "send_to_adjudication", "send_to_review", "add_annotator"
- Show threshold interpretation (e.g., "Strong agreement (>0.8)")

Create AssignmentConfig.tsx (per PRD ยง4.3.3):
- Mode select: "auto", "manual", "round_robin", "least_loaded"
- Required Skills multi-select (fetch from /api/v1/skills)
- Required Roles multi-select
- Load Balancing toggle with options
- Max assignments per user input (number)

Both forms use react-hook-form with Zod validation.
Wire up via useStepConfig hook.
  </action>
  <verify>Consensus and assignment configs save correctly to store</verify>
  <done>Consensus and assignment forms functional with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create CompletionCriteria and ConditionEditor forms</name>
  <files>
apps/web/src/components/workflow/ConfigPanel/forms/CompletionCriteria.tsx
apps/web/src/components/workflow/ConfigPanel/forms/ConditionEditor.tsx
apps/web/src/components/workflow/ConfigPanel/forms/index.ts
  </files>
  <action>
Create CompletionCriteria.tsx (per PRD ยง4.3.1):
- Annotation Count input: minimum annotations needed
- Unique Annotators input: minimum unique annotators
- Timeout input: hours/minutes before auto-escalation
- Auto-complete toggle: complete when criteria met

Create ConditionEditor.tsx for Condition nodes:
- Expression type select: "on_complete", "on_agreement", "on_disagreement", "expression"
- For "expression" type: Monaco editor for CEL/simple expressions
- Expression builder helper:
  - Variable dropdown: steps.{step_id}.output, annotations.count, consensus.score
  - Operator dropdown: ==, !=, >, <, contains
  - Value input
  - "AND" / "OR" buttons to combine
- Syntax validation with error display

Create index.ts barrel export:
```typescript
export { LayoutAssignment } from './LayoutAssignment';
export { ConsensusConfig } from './ConsensusConfig';
export { AssignmentConfig } from './AssignmentConfig';
export { CompletionCriteria } from './CompletionCriteria';
export { ConditionEditor } from './ConditionEditor';
```

Update StepConfigContent.tsx to use these forms based on step type.
  </action>
  <verify>All forms render and save config correctly</verify>
  <done>Complete set of step config forms functional</done>
</task>

</tasks>

<verification>
1. Select annotation node - see layout, consensus, assignment, completion forms
2. Select condition node - see condition editor
3. Changes persist when closing and reopening panel
</verification>

<success_criteria>
- Layout dropdown shows available layouts with thumbnails
- Consensus config has metric, threshold, actions
- Assignment config has mode, skills, roles
- Completion criteria has count, timeout options
- Condition editor has expression builder
- All forms validate and save to config store
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-project-configuration-experience/09.1-06-SUMMARY.md`
</output>
