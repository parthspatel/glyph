---
phase: 09.1-project-configuration-experience
plan: 08
type: execute
wave: 4
depends_on: ["09.1-05", "09.1-07"]
files_modified:
  - apps/web/src/components/workflow/DataFlow/DataFlowMapping.tsx
  - apps/web/src/components/workflow/DataFlow/NunjucksEditor.tsx
  - apps/web/src/components/workflow/DataFlow/TransformPreview.tsx
  - apps/web/src/components/workflow/hooks/useDataFlowContext.ts
autonomous: true

must_haves:
  truths:
    - "User can write Nunjucks expressions with autocomplete"
    - "Live preview shows transformed output"
    - "Type errors block save"
  artifacts:
    - path: "apps/web/src/components/workflow/DataFlow/NunjucksEditor.tsx"
      provides: "Monaco editor with Nunjucks autocomplete"
      exports: ["NunjucksEditor"]
    - path: "apps/web/src/components/workflow/DataFlow/TransformPreview.tsx"
      provides: "Live transform preview with diff"
      exports: ["TransformPreview"]
  key_links:
    - from: "NunjucksEditor.tsx"
      to: "useDataFlowContext.ts"
      via: "context for autocomplete"
      pattern: "useDataFlowContext"
---

<objective>
Create data flow mapping UI with Nunjucks template editor, autocomplete, and live preview.

Purpose: Per CONTEXT.md, data flows between steps use Nunjucks expressions like `{{ steps.annotate.output.entities }}`. The editor needs Monaco with autocomplete for available paths and live preview of transformations.

Output: Full data flow mapping UI with expression editor, autocomplete, preview, and validation.
</objective>

<execution_context>
@/Users/parthpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/parthpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09.1-project-configuration-experience/09.1-CONTEXT.md
@.planning/phases/09.1-project-configuration-experience/09.1-05-SUMMARY.md
@.planning/phases/09.1-project-configuration-experience/09.1-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDataFlowContext and NunjucksEditor</name>
  <files>
apps/web/src/components/workflow/hooks/useDataFlowContext.ts
apps/web/src/components/workflow/DataFlow/NunjucksEditor.tsx
  </files>
  <action>
Create useDataFlowContext.ts hook:
- Build context object from workflow state:
  - input: data source input schema fields
  - steps.{stepId}.output: output schema for each prior step
  - annotations: array of annotation objects
  - task: current task metadata
  - user: current user info
- Generate autocomplete suggestions:
  - Parse schemas to extract field paths
  - Build hierarchical suggestion tree
- Return: context object, suggestions array, validation function

Create NunjucksEditor.tsx:
- Monaco editor with custom language mode for Nunjucks
- Register completion provider:
  - Trigger on "{{ ", "{{ steps.", "{{ input."
  - Show contextual suggestions from useDataFlowContext
  - Include Nunjucks filters: | lower, | upper, | json, | default
- Syntax highlighting for {{ }} and {% %}
- Inline validation:
  - Parse expression
  - Check referenced paths exist
  - Show errors as markers

Monaco configuration:
```typescript
monaco.languages.registerCompletionItemProvider('nunjucks', {
  triggerCharacters: ['.', '{'],
  provideCompletionItems: (model, position) => {
    const suggestions = buildSuggestions(context, position);
    return { suggestions };
  }
});
```
  </action>
  <verify>Autocomplete shows available paths, syntax highlighting works</verify>
  <done>Nunjucks editor with context-aware autocomplete</done>
</task>

<task type="auto">
  <name>Task 2: Create TransformPreview with diff view</name>
  <files>
apps/web/src/components/workflow/DataFlow/TransformPreview.tsx
apps/web/src/components/workflow/DataFlow/DiffView.tsx
  </files>
  <action>
Create TransformPreview.tsx:
- Split view: Input (left) | Output (right)
- Input shows sample data from data source
- Output shows transformed result
- Live update as Nunjucks expression changes (debounced)
- Error state shows what went wrong

Implement Nunjucks rendering:
- Install nunjucks: `pnpm add nunjucks`
- Create sandboxed Nunjucks environment
- Render expression with sample context
- Catch and display errors

Create DiffView.tsx (per CONTEXT.md "Diff view"):
- Toggle between "Side by side" and "Diff" modes
- Diff mode highlights changes between input and output
- Use Monaco's diff editor or simple JSON diff
- Color code: added (green), removed (red), changed (yellow)

Add "Transformation trace" feature:
- Show step-by-step evaluation of Nunjucks expression
- Expand to see intermediate values
  </action>
  <verify>Live preview updates as expression changes, diff shows changes</verify>
  <done>Transform preview with diff view functional</done>
</task>

<task type="auto">
  <name>Task 3: Create DataFlowMapping panel and integrate</name>
  <files>
apps/web/src/components/workflow/DataFlow/DataFlowMapping.tsx
apps/web/src/components/workflow/DataFlow/index.ts
apps/web/src/components/workflow/ConfigPanel/StepConfigContent.tsx
  </files>
  <action>
Create DataFlowMapping.tsx:
- Header: "Data Flow Configuration"
- Input mapping section:
  - Source: dropdown (input, steps.{stepId}.output)
  - Expression editor (NunjucksEditor)
  - Quick insert buttons for common paths
- Output mapping section:
  - Target schema fields
  - Expression per field
- Validation section:
  - "Validate" button runs type checking
  - Shows errors: "Output field 'entities' expects array, got string"
  - Block save if validation fails

Create index.ts barrel export.

Update StepConfigContent.tsx to include DataFlowMapping:
- Add as section/tab within step config panel
- Show for annotation, review, adjudication steps
- "Data Flow" accordion section

Type checking implementation:
- Compare output schema with expression result type
- Use JSON Schema to infer types
- Show mismatch errors
  </action>
  <verify>Configure data flow for step, validation catches type errors</verify>
  <done>Data flow mapping integrated into step config</done>
</task>

</tasks>

<verification>
1. Select annotation step - see Data Flow section
2. Type `{{ input.` - autocomplete shows input fields
3. Type `{{ steps.review.output.` - shows review output fields
4. Preview updates with transformed data
5. Type mismatch shows validation error
</verification>

<success_criteria>
- Nunjucks editor with autocomplete for context paths
- Live preview of transformation
- Diff view shows input vs output
- Type validation catches schema mismatches
- Errors block save
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-project-configuration-experience/09.1-08-SUMMARY.md`
</output>
