# Phase 5.1: UX Navigation Flow for Phase 5 - Research

**Researched:** 2026-01-31
**Domain:** React Navigation Infrastructure for Project Management Screens
**Confidence:** HIGH

## Summary

Phase 5.1 extends the existing navigation system (implemented in Phase 4.1) to support all Phase 5 screens: Projects list, Project creation, Project detail/settings, and Project Types management. The existing infrastructure is already in place — shadcn/ui Sidebar with hover-to-expand, breadcrumb navigation with React Query cache integration, and role-based route protection. This phase primarily involves configuration changes rather than new component development.

The key addition is **project-scoped navigation**: when viewing a project, the sidebar or a secondary navigation area should show project-specific actions (Edit, Tasks, Data Sources, Settings) while breadcrumbs show the project hierarchy (Projects > Project Name > Section). Project Types management is a separate admin-level feature that needs its own route and navigation link.

The project already has all Phase 5 pages implemented (ProjectsPage, ProjectCreatePage, ProjectDetailPage, ProjectEditPage) with routes configured. Navigation items exist for /projects, but project-scoped actions and Project Types management need to be added.

**Primary recommendation:** Add /projects nav item (already exists), create project-scoped action menu in ProjectDetailPage sidebar, add /admin/project-types route with admin-only nav item, and enhance breadcrumbs with project name lookup from React Query cache.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @shadcn/ui sidebar | latest | Collapsible sidebar (already installed) | Project standard from Phase 4.1 |
| @shadcn/ui breadcrumb | latest | Breadcrumb navigation (already installed) | Project standard from Phase 4.1 |
| react-router-dom | ^7.1.0 | Routing (already installed) | Project standard |
| lucide-react | ^0.469 | Navigation icons (already installed) | Project standard |
| @tanstack/react-query | latest | Cache for breadcrumb entity names | Project standard |

**Installation:** None required — all dependencies already installed in Phase 4.1

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| @shadcn/ui dropdown-menu | latest | Project actions menu (installed) | For project-scoped quick actions |
| @shadcn/ui collapsible | latest | Sidebar sections (installed) | For grouping project-specific nav items |

## Architecture Patterns

### Recommended Project Structure
```
apps/web/src/
├── components/
│   ├── layout/
│   │   ├── AppLayout.tsx              # Existing - wraps all routes
│   │   ├── AppSidebar.tsx             # Existing - add /projects nav item
│   │   ├── Breadcrumbs.tsx            # Existing - works with projects
│   │   └── ProjectContextNav.tsx      # NEW - project-scoped actions
│   └── ui/                            # shadcn components (installed)
├── lib/
│   └── navigation.ts                  # Existing - add project nav config
├── pages/
│   ├── ProjectsPage.tsx               # Existing - list view
│   ├── ProjectCreatePage.tsx          # Existing - creation wizard
│   ├── ProjectDetailPage.tsx          # Existing - overview/settings
│   ├── ProjectEditPage.tsx            # Existing - edit form
│   └── admin/
│       └── ProjectTypesPage.tsx       # NEW - project types CRUD
└── App.tsx                            # Existing - add project types route
```

### Pattern 1: Project-Scoped Navigation (Context-Aware Sidebar)

The existing navigation shows global items (Dashboard, Projects, Teams). When viewing a project detail page, add project-specific actions in the sidebar or as a secondary navigation area.

**Implementation Option A: Sidebar Section (Recommended)**
```typescript
// In AppSidebar.tsx - add conditional section
import { useLocation, useParams } from "react-router-dom";
import { SidebarGroup, SidebarGroupLabel, SidebarGroupContent, SidebarMenu, SidebarMenuItem, SidebarMenuButton } from "@/components/ui/sidebar";
import { Settings, FileText, Database, ClipboardList } from "lucide-react";

export function AppSidebar() {
  const location = useLocation();
  const params = useParams();
  
  // Check if we're in project context
  const isProjectContext = location.pathname.startsWith('/projects/') && params.projectId;

  return (
    <Sidebar collapsible="icon">
      {/* ... existing nav items ... */}
      
      {/* Project-scoped section - only shows when viewing a project */}
      {isProjectContext && (
        <SidebarGroup>
          <SidebarGroupLabel>Project Actions</SidebarGroupLabel>
          <SidebarGroupContent>
            <SidebarMenu>
              <SidebarMenuItem>
                <SidebarMenuButton asChild>
                  <Link to={`/projects/${params.projectId}`}>
                    <FileText />
                    <span>Overview</span>
                  </Link>
                </SidebarMenuButton>
              </SidebarMenuItem>
              <SidebarMenuItem>
                <SidebarMenuButton asChild>
                  <Link to={`/projects/${params.projectId}/edit`}>
                    <Settings />
                    <span>Settings</span>
                  </Link>
                </SidebarMenuButton>
              </SidebarMenuItem>
              <SidebarMenuItem>
                <SidebarMenuButton asChild>
                  <Link to={`/projects/${params.projectId}/tasks`}>
                    <ClipboardList />
                    <span>Tasks</span>
                  </Link>
                </SidebarMenuButton>
              </SidebarMenuItem>
            </SidebarMenu>
          </SidebarGroupContent>
        </SidebarGroup>
      )}
    </Sidebar>
  );
}
```

**Implementation Option B: Project Detail Sidebar (Simpler)**
Keep the existing global sidebar unchanged. Add project-specific actions to the ProjectDetailPage's existing sidebar section (already has Edit, View Tasks, Clone buttons).

### Pattern 2: Enhanced Breadcrumbs with Project Name

The existing breadcrumb system (from Phase 4.1) already looks up entity names from React Query cache. Ensure project names are cached properly.

```typescript
// In useBreadcrumbs.ts - already handles this pattern
// Projects > Clinical NER Project > Settings

// The hook looks for query key patterns:
// ['project', 'proj_123'] or ['projects', 'proj_123']
// Returns project.name if found, otherwise shows "PROJ..."

// Example breadcrumb output:
// Home > Projects > Clinical NER Project > Edit
```

**Verification:**
```typescript
// In useProject hook (already implemented)
export function useProject(id: string | undefined) {
  return useQuery({
    queryKey: ['project', id],  // ✓ Matches useBreadcrumbs pattern
    queryFn: () => projectsApi.get(id!),
    enabled: !!id,
  });
}
```

### Pattern 3: Project Types Management Route

Project types are an admin-level feature. Add route and navigation item with role protection.

```typescript
// In App.tsx - add to admin routes section
<Route element={<ProtectedRoute requiredRoles={["admin"]} />}>
  <Route path="/admin/users" element={<AdminUsersPage />} />
  <Route path="/admin/project-types" element={<ProjectTypesPage />} />
  <Route path="/admin/project-types/new" element={<ProjectTypeCreatePage />} />
  <Route path="/admin/project-types/:typeId" element={<ProjectTypeDetailPage />} />
</Route>
```

```typescript
// In lib/navigation.ts - add admin nav item
export const navItems: NavItem[] = [
  { href: "/", label: "Dashboard", icon: LayoutDashboard },
  { href: "/projects", label: "Projects", icon: FolderKanban },
  { href: "/teams", label: "Teams", icon: Users },
  { href: "/tasks", label: "My Tasks", icon: ClipboardList },
  { href: "/admin/users", label: "Users", icon: UserCog, roles: ["admin"] },
  { href: "/admin/project-types", label: "Project Types", icon: Layers, roles: ["admin"] }, // NEW
  { href: "/settings", label: "Settings", icon: Settings },
];
```

### Pattern 4: Active State for Project Routes

The existing `isActive()` function in AppSidebar already handles prefix matching for /projects routes.

```typescript
// Already implemented in AppSidebar.tsx
const isActive = (href: string) => {
  if (href === "/") {
    return location.pathname === "/";
  }
  // This will match /projects, /projects/new, /projects/:id, etc.
  return location.pathname === href || location.pathname.startsWith(href + "/");
};
```

**Result:**
- Clicking "Projects" nav item highlights it when on any project page
- Breadcrumbs show detailed path: Projects > Project Name > Section

### Pattern 5: Navigation from Root to All Phase 5 Screens

**User Journey Map:**

```
Root (/) 
  → Dashboard (role-based redirect)
    ↓
  Projects navigation item (sidebar)
    ↓
  /projects (ProjectsPage - list view)
    ↓
    ├─→ "New Project" button → /projects/new (ProjectCreatePage)
    ├─→ Click project row → /projects/:id (ProjectDetailPage)
    └─→ (from detail) "Edit" button → /projects/:id/edit (ProjectEditPage)
    └─→ (from detail) "View Tasks" button → /projects/:id/tasks (TasksPage)

Admin Users (global_role: admin)
  → Sidebar shows "Project Types" item
    ↓
  /admin/project-types (ProjectTypesPage - list view)
    ↓
    ├─→ "New Type" button → /admin/project-types/new (ProjectTypeCreatePage)
    └─→ Click type row → /admin/project-types/:id (ProjectTypeDetailPage)
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Project-scoped sidebar | Custom context provider | Conditional SidebarGroup in existing sidebar | Already have useSidebar and useLocation |
| Breadcrumb entity names | Additional API calls | React Query cache lookup (existing) | Prevents waterfall requests |
| Active route detection | Manual state tracking | useLocation + prefix matching (existing) | Built into Phase 4.1 navigation |
| Admin route protection | Manual permission checks | ProtectedRoute wrapper (existing) | Already implemented with role checking |
| Project navigation state | Separate context | URL params (useParams) | Single source of truth |

**Key insight:** Phase 4.1 navigation infrastructure handles all complexity. This phase is mostly configuration (adding routes, nav items) rather than new component development.

## Common Pitfalls

### Pitfall 1: Duplicate Navigation Items
**What goes wrong:** Adding /projects to navItems when it already exists, causing duplicate sidebar items.
**Why it happens:** Phase 5 screens already have routes configured from Phase 5 implementation.
**How to avoid:** Check existing navItems array before adding new items. /projects nav item should already exist.
**Warning signs:** Two "Projects" items in sidebar, one not highlighted correctly.

### Pitfall 2: Breadcrumbs Show IDs Instead of Project Names
**What goes wrong:** Breadcrumbs display "Projects > proj_xxx" instead of "Projects > Clinical NER Project".
**Why it happens:** React Query cache doesn't contain project data, or query key pattern doesn't match useBreadcrumbs lookup.
**How to avoid:** Ensure useProject hook uses query key `['project', id]` (not `['projects', id]` or other pattern).
**Warning signs:** Breadcrumbs show "PROJ..." or raw ID prefixes.

### Pitfall 3: Project Context Nav Flickers on Route Change
**What goes wrong:** Project-scoped sidebar section disappears and reappears when navigating between project pages.
**Why it happens:** useParams returns undefined briefly during navigation, causing isProjectContext to toggle.
**How to avoid:** Use React.useMemo to stabilize the check, or show skeleton while params are undefined.
**Warning signs:** Sidebar section flashes or jumps during navigation.

### Pitfall 4: Admin Project Types Route Not Protected
**What goes wrong:** Non-admin users can access /admin/project-types by typing URL directly.
**Why it happens:** Route added without ProtectedRoute wrapper.
**How to avoid:** Always wrap /admin/* routes in `<Route element={<ProtectedRoute requiredRoles={["admin"]} />}>`.
**Warning signs:** Non-admin users see 403 error instead of being redirected to home.

### Pitfall 5: Missing Active State for Nested Project Routes
**What goes wrong:** "Projects" nav item not highlighted when on /projects/:id/edit.
**Why it happens:** Active state logic only checks exact match, not prefix.
**How to avoid:** Use `.startsWith(href + "/")` for prefix matching (already implemented in Phase 4.1).
**Warning signs:** Nav item not highlighted when viewing project details or editing.

## Code Examples

Verified patterns from existing codebase and documentation.

### Navigation Configuration with Projects Item

```typescript
// Source: apps/web/src/lib/navigation.ts (existing)
import { FolderKanban, type LucideIcon } from "lucide-react";

export interface NavItem {
  href: string;
  label: string;
  icon: LucideIcon;
  roles?: string[]; // If undefined, visible to all authenticated users
}

export const navItems: NavItem[] = [
  { href: "/", label: "Dashboard", icon: LayoutDashboard },
  { href: "/projects", label: "Projects", icon: FolderKanban }, // ✓ Already exists
  { href: "/teams", label: "Teams", icon: Users },
  { href: "/tasks", label: "My Tasks", icon: ClipboardList },
  { href: "/admin/users", label: "Users", icon: UserCog, roles: ["admin"] },
  { href: "/settings", label: "Settings", icon: Settings },
];
```

### Project Routes Configuration

```typescript
// Source: apps/web/src/App.tsx (existing)
import { ProjectsPage } from "./pages/ProjectsPage";
import { ProjectCreatePage } from "./pages/ProjectCreatePage";
import { ProjectDetailPage } from "./pages/ProjectDetailPage";
import { ProjectEditPage } from "./pages/ProjectEditPage";

export function App() {
  return (
    <Routes>
      <Route element={<AppLayout />}>
        <Route path="/projects" element={<ProjectsPage />} />
        <Route path="/projects/new" element={<ProjectCreatePage />} />
        <Route path="/projects/:projectId" element={<ProjectDetailPage />} />
        <Route path="/projects/:projectId/edit" element={<ProjectEditPage />} />
        {/* ... other routes ... */}
      </Route>
    </Routes>
  );
}
```

### Conditional Project-Scoped Sidebar Section

```typescript
// Source: Pattern from shadcn/ui sidebar docs + React Router
import { useLocation, useParams, Link } from "react-router-dom";
import { SidebarGroup, SidebarGroupLabel, SidebarGroupContent, SidebarMenu, SidebarMenuItem, SidebarMenuButton } from "@/components/ui/sidebar";
import { Settings, FileText, Database } from "lucide-react";

function ProjectScopedNav() {
  const location = useLocation();
  const params = useParams<{ projectId: string }>();
  
  const isProjectContext = location.pathname.startsWith('/projects/') && params.projectId;
  
  if (!isProjectContext) return null;

  return (
    <SidebarGroup>
      <SidebarGroupLabel>Project</SidebarGroupLabel>
      <SidebarGroupContent>
        <SidebarMenu>
          <SidebarMenuItem>
            <SidebarMenuButton asChild isActive={location.pathname === `/projects/${params.projectId}`}>
              <Link to={`/projects/${params.projectId}`}>
                <FileText />
                <span>Overview</span>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
          <SidebarMenuItem>
            <SidebarMenuButton asChild isActive={location.pathname === `/projects/${params.projectId}/edit`}>
              <Link to={`/projects/${params.projectId}/edit`}>
                <Settings />
                <span>Settings</span>
              </Link>
            </SidebarMenuButton>
          </SidebarMenuItem>
        </SidebarMenu>
      </SidebarGroupContent>
    </SidebarGroup>
  );
}
```

### Breadcrumb Entity Name Lookup from Cache

```typescript
// Source: apps/web/src/hooks/useBreadcrumbs.ts (existing)
import { useQueryClient } from "@tanstack/react-query";

function getEntityName(
  queryClient: ReturnType<typeof useQueryClient>,
  type: string,
  id: string
): string | null {
  // Try common query key patterns
  const patterns = [
    [type, id],           // ['project', 'proj_123']
    [type + 's', id],     // ['projects', 'proj_123']
  ];

  for (const key of patterns) {
    const data = queryClient.getQueryData<{ name?: string; display_name?: string }>(key);
    if (data) {
      return data.name || data.display_name || null;
    }
  }
  return null;
}

// Usage in breadcrumb generation
const paramKey = Object.entries(params).find(([_, value]) => value === segment)?.[0];
if (paramKey) {
  const type = paramKey.replace("Id", ""); // projectId -> project
  const cachedName = getEntityName(queryClient, type, segment);
  label = cachedName || segment.split("_")[0].toUpperCase() + "...";
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate sidebar for project context | Conditional sections in main sidebar | 2024+ | Simpler state management, single navigation component |
| Manual breadcrumb configuration | useLocation + cache lookup | React Router v6+ | Dynamic breadcrumbs without manual route config |
| Custom active state logic | React Router useLocation + prefix matching | 2023+ | Built-in, works with nested routes |
| Context API for project state | URL params (useParams) | Always best practice | Single source of truth, shareable URLs |

**Deprecated/outdated:**
- Separate ProjectContext provider for current project: Use URL params instead (simpler, SSR-friendly)
- Manual route matching for active states: useLocation provides pathname directly
- Breadcrumb route configuration objects: Parse location.pathname dynamically

## Open Questions

### 1. **Should project-scoped nav be in main sidebar or separate component?**
- What we know: Phase 4.1 implemented single collapsible sidebar with role filtering
- What's unclear: Best UX for showing project actions when viewing a project
- Recommendation: Use conditional SidebarGroup in main sidebar (Option A) - keeps all navigation in one place, leverages existing hover-to-expand behavior

### 2. **Should Project Types be accessible from Projects list or only via admin panel?**
- What we know: Project Types are templates used when creating projects (admin-managed)
- What's unclear: Whether non-admins need read-only access to browse types
- Recommendation: Admin-only /admin/project-types route initially. If users need to browse types, add read-only /project-types route later.

### 3. **How should breadcrumbs handle project type names in creation flow?**
- What we know: ProjectCreatePage shows project type selector, but type isn't selected until user chooses
- What's unclear: What breadcrumb should show during creation (no project ID yet)
- Recommendation: "Projects > New" is sufficient. Once created, redirect to "Projects > [Project Name]"

## Sources

### Primary (HIGH confidence)
- [React Router /remix-run/react-router] - Outlet component, nested routes, useLocation hook
- [shadcn/ui Sidebar Documentation](https://ui.shadcn.com/docs/components/sidebar) - SidebarGroup, collapsible sections, context-aware menus
- Existing codebase (apps/web/src/lib/navigation.ts, apps/web/src/components/layout/AppSidebar.tsx, apps/web/src/hooks/useBreadcrumbs.ts) - Phase 4.1 implementation

### Secondary (MEDIUM confidence)
- [Building a Collapsible Admin Sidebar with React Router + useLocation](https://dev.to/cristiansifuentes/building-a-collapsible-admin-sidebar-with-react-router-uselocation-pro-patterns-7im) - useLocation for active route highlighting
- [React Navigation Breadcrumbs](https://www.freecodecamp.org/news/react-navigation-build-a-breadcrumb-component/) - Best practices for breadcrumb implementation
- [Navigation Menu - shadcn/ui](https://ui.shadcn.com/docs/components/navigation-menu) - Nested navigation patterns

### Tertiary (LOW confidence)
- Generic React admin panel templates - General patterns but not specific to this stack

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All dependencies already installed from Phase 4.1
- Architecture: HIGH - Patterns verified in existing codebase and official docs
- Pitfalls: MEDIUM - Based on common React Router issues and codebase analysis

**Research date:** 2026-01-31
**Valid until:** ~30 days (stable patterns, React Router v7 established)
