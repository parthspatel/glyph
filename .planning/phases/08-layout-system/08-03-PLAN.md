---
phase: 08-layout-system
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/@glyph/layout-runtime/src/validation/ajv.ts
  - packages/@glyph/layout-runtime/src/validation/validators.ts
  - packages/@glyph/layout-runtime/src/validation/schemas/layout.schema.json
  - packages/@glyph/layout-runtime/src/validation/schemas/output.schema.json
autonomous: true

must_haves:
  truths:
    - "Ajv validators are compiled once at startup (not per-validation)"
    - "Layout schema validates template structure before rendering"
    - "Output schema validates annotation data before submission"
    - "Compile-once pattern provides 10x performance improvement"
  artifacts:
    - path: "packages/@glyph/layout-runtime/src/validation/ajv.ts"
      provides: "Pre-compiled Ajv instance"
      exports: ["ajv", "compileSchema"]
    - path: "packages/@glyph/layout-runtime/src/validation/validators.ts"
      provides: "Pre-compiled validators"
      exports: ["validateLayout", "validateOutput", "validateTaskInput"]
---

<objective>
Implement Ajv-based schema validation with compile-once pattern.

Purpose: Per RESEARCH findings, Ajv is 10x faster when schemas are compiled once vs per-validation. This provides both build-time (layout YAML/JSON) and runtime (props, output) validation.

Output: Pre-compiled validators for layout schema, task input schema, and annotation output schema.
</objective>

<context>
@.planning/phases/08-layout-system/08-CONTEXT.md
@.planning/phases/08-layout-system/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Ajv instance</name>
  <files>packages/@glyph/layout-runtime/src/validation/ajv.ts</files>
  <action>
Install ajv and formats: `pnpm add ajv ajv-formats`

Create configured Ajv instance:

```typescript
import Ajv from 'ajv';
import addFormats from 'ajv-formats';

// Singleton Ajv instance with optimal settings
const ajv = new Ajv({
  allErrors: true,          // Collect all errors, not just first
  coerceTypes: false,       // Strict typing
  useDefaults: true,        // Apply schema defaults
  removeAdditional: false,  // Don't silently remove extra props
  strict: true,             // Strict mode
  validateFormats: true,    // Validate format keywords
});

// Add standard formats (email, uri, date-time, etc.)
addFormats(ajv);

// Cache of compiled validators
const validatorCache = new Map<string, ReturnType<typeof ajv.compile>>();

/**
 * Compile schema once and cache.
 * CRITICAL: Never call ajv.validate() directly in hot paths.
 */
export function compileSchema<T>(schemaId: string, schema: object): (data: unknown) => data is T {
  if (!validatorCache.has(schemaId)) {
    const validate = ajv.compile(schema);
    validatorCache.set(schemaId, validate);
  }
  const validator = validatorCache.get(schemaId)!;
  return (data: unknown): data is T => validator(data) as boolean;
}

/**
 * Get validation errors from last validation.
 */
export function getValidationErrors(schemaId: string): Array<{ path: string; message: string }> {
  const validator = validatorCache.get(schemaId);
  if (!validator?.errors) return [];
  return validator.errors.map(e => ({
    path: e.instancePath || '/',
    message: e.message || 'Unknown error',
  }));
}

export { ajv };
```
  </action>
  <verify>compileSchema caches validators correctly</verify>
  <done>Ajv singleton with compile-once pattern created</done>
</task>

<task type="auto">
  <name>Task 2: Create layout schema</name>
  <files>packages/@glyph/layout-runtime/src/validation/schemas/layout.schema.json</files>
  <action>
Define JSON Schema for layout structure:

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://glyph.io/schemas/layout.json",
  "title": "Glyph Layout Schema",
  "type": "object",
  "required": ["version", "template"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of the layout"
    },
    "template": {
      "type": "string",
      "enum": ["nunjucks", "mdx", "tsx"],
      "description": "Template format"
    },
    "content": {
      "type": "string",
      "description": "Template content"
    },
    "inputSchema": {
      "$ref": "#/$defs/jsonSchema",
      "description": "JSON Schema for task input validation"
    },
    "outputSchema": {
      "$ref": "#/$defs/jsonSchema",
      "description": "JSON Schema for annotation output validation"
    },
    "settings": {
      "$ref": "#/$defs/layoutSettings"
    },
    "shortcuts": {
      "type": "object",
      "additionalProperties": { "type": "string" },
      "description": "Custom shortcut bindings"
    },
    "components": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Allowed component names (security)"
    }
  },
  "$defs": {
    "layoutSettings": {
      "type": "object",
      "properties": {
        "auto_save": { "type": "boolean", "default": true },
        "auto_save_interval": { "type": "integer", "minimum": 1000, "default": 5000 },
        "show_progress": { "type": "boolean", "default": true },
        "keyboard_shortcuts": { "type": "boolean", "default": true },
        "confirm_submit": { "type": "boolean", "default": true },
        "allow_skip": { "type": "boolean", "default": true },
        "custom_css": { "type": "string" }
      }
    },
    "jsonSchema": {
      "type": "object",
      "description": "A JSON Schema document"
    }
  }
}
```
  </action>
  <verify>Schema validates layout objects correctly</verify>
  <done>Layout schema created with all required fields</done>
</task>

<task type="auto">
  <name>Task 3: Create pre-compiled validators</name>
  <files>packages/@glyph/layout-runtime/src/validation/validators.ts</files>
  <action>
Create pre-compiled validators for common schemas:

```typescript
import { compileSchema, getValidationErrors } from './ajv';
import layoutSchema from './schemas/layout.schema.json';

// Types
export interface Layout {
  version: string;
  template: 'nunjucks' | 'mdx' | 'tsx';
  content: string;
  inputSchema?: object;
  outputSchema?: object;
  settings?: LayoutSettings;
  shortcuts?: Record<string, string>;
  components?: string[];
}

export interface LayoutSettings {
  auto_save?: boolean;
  auto_save_interval?: number;
  show_progress?: boolean;
  keyboard_shortcuts?: boolean;
  confirm_submit?: boolean;
  allow_skip?: boolean;
  custom_css?: string;
}

// Pre-compiled validators (compiled once at module load)
export const validateLayout = compileSchema<Layout>('layout', layoutSchema);

/**
 * Validate layout and return detailed errors.
 */
export function validateLayoutWithErrors(data: unknown): { valid: boolean; errors: Array<{ path: string; message: string }> } {
  const valid = validateLayout(data);
  return { valid, errors: valid ? [] : getValidationErrors('layout') };
}

/**
 * Compile and cache a project-specific output schema.
 * Called once per project, not per validation.
 */
export function createOutputValidator(projectId: string, outputSchema: object) {
  const schemaId = `output:${projectId}`;
  return compileSchema(schemaId, outputSchema);
}

/**
 * Compile and cache a project-specific input schema.
 * Called once per project, not per validation.
 */
export function createInputValidator(projectId: string, inputSchema: object) {
  const schemaId = `input:${projectId}`;
  return compileSchema(schemaId, inputSchema);
}
```
  </action>
  <verify>validateLayout is compiled once, subsequent calls use cache</verify>
  <done>Pre-compiled validators created with cache</done>
</task>

<task type="auto">
  <name>Task 4: Export validation module</name>
  <files>
    packages/@glyph/layout-runtime/src/validation/index.ts
    packages/@glyph/layout-runtime/src/index.ts
  </files>
  <action>
**validation/index.ts:**
```typescript
export { ajv, compileSchema, getValidationErrors } from './ajv';
export { 
  validateLayout, 
  validateLayoutWithErrors,
  createOutputValidator,
  createInputValidator,
  type Layout,
  type LayoutSettings,
} from './validators';
```

**Update src/index.ts:**
```typescript
export * from './shortcuts';
export * from './undo';
export * from './validation';
```
  </action>
  <verify>Validation exports work correctly</verify>
  <done>Validation module exported from package</done>
</task>

</tasks>

<verification>
- ajv.compile() called only once per schema (check with debug logging)
- validateLayout returns correct errors for invalid layouts
- createOutputValidator caches compiled validator
- Performance test: 1000 validations < 100ms (vs ~1000ms without caching)
</verification>

<success_criteria>
- Validators compiled once at startup
- Layout schema validates template structure
- Output schema validates annotation data
- 10x performance improvement verified
</success_criteria>
