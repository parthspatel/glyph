---
phase: 05-project-management
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/hooks/useUnsavedChanges.ts
  - apps/web/src/hooks/useProjects.ts
  - apps/web/src/hooks/useProjectTypes.ts
  - apps/web/src/api/projects.ts
  - apps/web/src/api/projectTypes.ts
autonomous: true

must_haves:
  truths:
    - "react-hook-form and zod installed"
    - "@monaco-editor/react installed"
    - "@radix-ui/react-accordion installed"
    - "Project API hooks exist"
    - "Unsaved changes hook works"
  artifacts:
    - path: "apps/web/package.json"
      provides: "Frontend dependencies"
      contains: "react-hook-form"
    - path: "apps/web/src/hooks/useProjects.ts"
      provides: "Project data hooks"
      contains: "useProjects"
---

<objective>
Add frontend dependencies and create shared hooks for project management.

Purpose: Install required npm packages for forms, schema editing, and collapsible sections. Create TanStack Query hooks for project and project type data. Create unsaved changes warning hook.

Output: Updated package.json, API client functions, and reusable hooks.
</objective>

<context>
@apps/web/package.json (current dependencies)
@apps/web/src/hooks/ (existing hook patterns)
@apps/web/src/api/ (existing API patterns)
@.planning/phases/05-project-management/05-RESEARCH.md (library recommendations)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install frontend dependencies</name>
  <files>apps/web/package.json</files>
  <action>
Run in apps/web directory:

```bash
pnpm add react-hook-form@^7.54 zod@^3.23 @hookform/resolvers@^3.9
pnpm add @monaco-editor/react@^4.6
pnpm add @radix-ui/react-accordion@^1.2 @radix-ui/react-collapsible@^1.1
```

These should already exist (verify):
- @tanstack/react-query (for data fetching)
- @tanstack/react-table (for tables)
- lucide-react (for icons)
- react-router-dom (for routing/useBlocker)

If any are missing, add them.
  </action>
  <verify>
Run `pnpm install` - no errors.
Run `pnpm build` - compiles successfully.
Check package.json has all dependencies.
  </verify>
</task>

<task type="auto">
  <name>Task 2: Create API client and hooks</name>
  <files>apps/web/src/api/projects.ts, apps/web/src/api/projectTypes.ts, apps/web/src/hooks/useProjects.ts, apps/web/src/hooks/useProjectTypes.ts, apps/web/src/hooks/useUnsavedChanges.ts</files>
  <action>
1. Create apps/web/src/api/projects.ts:

```typescript
import { api } from './client';
import type { Project, CreateProject, UpdateProject, ProjectFilter } from '@/types';

export const projectsApi = {
  list: (filter?: ProjectFilter) => 
    api.get<Project[]>('/projects', { params: filter }),
  
  get: (id: string) => 
    api.get<Project>(`/projects/${id}`),
  
  create: (data: CreateProject) => 
    api.post<Project>('/projects', data),
  
  update: (id: string, data: UpdateProject) => 
    api.put<Project>(`/projects/${id}`, data),
  
  delete: (id: string) => 
    api.delete(`/projects/${id}`),
  
  updateStatus: (id: string, status: string) =>
    api.post<Project>(`/projects/${id}/status`, { status }),
  
  activate: (id: string) =>
    api.post<Project>(`/projects/${id}/activate`),
  
  clone: (id: string, options: { include_data_sources: boolean }) =>
    api.post<Project>(`/projects/${id}/clone`, options),
};
```

2. Create apps/web/src/api/projectTypes.ts:

```typescript
import { api } from './client';
import type { ProjectType, CreateProjectType, UpdateProjectType, ValidationResult } from '@/types';

export const projectTypesApi = {
  list: (filter?: { is_system?: boolean; search?: string }) =>
    api.get<ProjectType[]>('/project-types', { params: filter }),
  
  get: (id: string) =>
    api.get<ProjectType>(`/project-types/${id}`),
  
  create: (data: CreateProjectType) =>
    api.post<ProjectType>('/project-types', data),
  
  update: (id: string, data: UpdateProjectType) =>
    api.put<ProjectType>(`/project-types/${id}`, data),
  
  delete: (id: string) =>
    api.delete(`/project-types/${id}`),
  
  validateSchema: (id: string, schema: object, sampleData: object) =>
    api.post<ValidationResult>(`/project-types/${id}/validate-schema`, { schema, sample_data: sampleData }),
  
  inferSchema: (samples: object[]) =>
    api.post<{ schema: object; ambiguities: object[] }>('/project-types/infer-schema', { samples }),
};
```

3. Create apps/web/src/hooks/useProjects.ts:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { projectsApi } from '@/api/projects';

export function useProjects(filter?: ProjectFilter) {
  return useQuery({
    queryKey: ['projects', filter],
    queryFn: () => projectsApi.list(filter),
  });
}

export function useProject(id: string) {
  return useQuery({
    queryKey: ['projects', id],
    queryFn: () => projectsApi.get(id),
    enabled: !!id,
  });
}

export function useCreateProject() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: projectsApi.create,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
    },
  });
}

export function useUpdateProject() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: UpdateProject }) =>
      projectsApi.update(id, data),
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
      queryClient.invalidateQueries({ queryKey: ['projects', id] });
    },
  });
}

export function useDeleteProject() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: projectsApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
    },
  });
}

export function useUpdateProjectStatus() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, status }: { id: string; status: string }) =>
      projectsApi.updateStatus(id, status),
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: ['projects', id] });
    },
  });
}

export function useActivateProject() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: projectsApi.activate,
    onSuccess: (_, id) => {
      queryClient.invalidateQueries({ queryKey: ['projects', id] });
    },
  });
}

export function useCloneProject() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, options }: { id: string; options: { include_data_sources: boolean } }) =>
      projectsApi.clone(id, options),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['projects'] });
    },
  });
}
```

4. Create apps/web/src/hooks/useProjectTypes.ts (similar pattern)

5. Create apps/web/src/hooks/useUnsavedChanges.ts:

```typescript
import { useEffect, useRef } from 'react';
import { useBlocker } from 'react-router-dom';

export function useUnsavedChanges(isDirty: boolean, enabled = true) {
  const isDirtyRef = useRef(isDirty);
  isDirtyRef.current = isDirty;

  // Handle browser close/refresh
  useEffect(() => {
    if (!enabled) return;

    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isDirtyRef.current) {
        e.preventDefault();
        e.returnValue = '';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [enabled]);

  // Handle client-side navigation
  const blocker = useBlocker(
    ({ currentLocation, nextLocation }) =>
      enabled &&
      isDirty &&
      currentLocation.pathname !== nextLocation.pathname
  );

  useEffect(() => {
    if (blocker.state === 'blocked') {
      const confirmLeave = window.confirm(
        'You have unsaved changes. Are you sure you want to leave?'
      );
      if (confirmLeave) {
        blocker.proceed();
      } else {
        blocker.reset();
      }
    }
  }, [blocker]);

  return { isDirty };
}
```
  </action>
  <verify>
Run `pnpm typecheck` - no TypeScript errors.
Run `pnpm build` - compiles.
Import hooks in a test file and verify no errors.
  </verify>
</task>

</tasks>

<verification>
1. All npm packages installed without errors
2. TypeScript types work with new packages
3. API functions match backend endpoints
4. TanStack Query hooks follow existing patterns
5. useUnsavedChanges works with react-router-dom v7
</verification>

<success_criteria>
- react-hook-form, zod, @hookform/resolvers installed
- @monaco-editor/react installed
- @radix-ui/react-accordion installed
- useProjects, useProject, useCreateProject hooks work
- useProjectTypes hooks work
- useUnsavedChanges blocks navigation when dirty
</success_criteria>
