---
phase: 05-project-management
plan: 07
type: execute
wave: 4
depends_on: [05-04, 05-06]
files_modified:
  - apps/web/src/pages/ProjectsPage.tsx
  - apps/web/src/components/project/ProjectTable.tsx
  - apps/web/src/components/project/ProjectFilters.tsx
  - apps/web/src/components/project/BulkActions.tsx
autonomous: true

must_haves:
  truths:
    - "Projects list page renders at /projects"
    - "TanStack Table with sortable columns"
    - "Filter by status, type, team, search"
    - "Bulk actions work with permission checks"
    - "Column visibility toggle works"
  artifacts:
    - path: "apps/web/src/pages/ProjectsPage.tsx"
      provides: "Projects list page"
      contains: "ProjectsPage"
    - path: "apps/web/src/components/project/ProjectTable.tsx"
      provides: "Projects table component"
      contains: "ProjectTable"
---

<objective>
Create the projects list page with TanStack Table, filtering, and bulk actions.

Purpose: Display all projects in a table view with advanced filtering, sorting, and bulk operations. Support "My Projects", "Team Projects", and "All Projects" views. Show key metrics per project.

Output: ProjectsPage at /projects with table, filters, and bulk actions.
</objective>

<context>
@apps/web/src/pages/admin/UsersPage.tsx (TanStack Table pattern)
@apps/web/src/components/ (component patterns)
@.planning/phases/05-project-management/05-CONTEXT.md (list view decisions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectTable component</name>
  <files>apps/web/src/components/project/ProjectTable.tsx</files>
  <action>
Create apps/web/src/components/project/ProjectTable.tsx:

Use TanStack Table following UsersPage.tsx pattern:

1. Define columns:
```typescript
const columns: ColumnDef<Project>[] = [
  {
    id: 'select',
    header: ({ table }) => (
      <Checkbox
        checked={table.getIsAllPageRowsSelected()}
        onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
      />
    ),
    cell: ({ row }) => (
      <Checkbox
        checked={row.getIsSelected()}
        onCheckedChange={(value) => row.toggleSelected(!!value)}
      />
    ),
    enableSorting: false,
    enableHiding: false,
  },
  {
    accessorKey: 'name',
    header: 'Name',
    cell: ({ row }) => (
      <Link to={`/projects/${row.original.id}`} className="font-medium hover:underline">
        {row.getValue('name')}
      </Link>
    ),
  },
  {
    accessorKey: 'status',
    header: 'Status',
    cell: ({ row }) => <StatusBadge status={row.getValue('status')} />,
  },
  {
    accessorKey: 'project_type',
    header: 'Type',
    cell: ({ row }) => row.original.project_type?.name ?? '—',
  },
  {
    accessorKey: 'task_count',
    header: 'Tasks',
    cell: ({ row }) => row.getValue('task_count') ?? 0,
  },
  {
    accessorKey: 'completion_pct',
    header: 'Progress',
    cell: ({ row }) => {
      const pct = row.getValue('completion_pct') as number ?? 0;
      return (
        <div className="flex items-center gap-2">
          <div className="w-20 h-2 bg-gray-200 rounded">
            <div className="h-full bg-green-500 rounded" style={{ width: `${pct}%` }} />
          </div>
          <span className="text-sm">{pct}%</span>
        </div>
      );
    },
  },
  {
    accessorKey: 'created_at',
    header: 'Created',
    cell: ({ row }) => formatDate(row.getValue('created_at')),
  },
  {
    accessorKey: 'created_by',
    header: 'Owner',
    cell: ({ row }) => row.original.created_by_user?.display_name ?? '—',
    enableHiding: true,
  },
  {
    id: 'actions',
    cell: ({ row }) => <ProjectRowActions project={row.original} />,
  },
];
```

2. Implement column visibility toggle:
```typescript
const [columnVisibility, setColumnVisibility] = useState<VisibilityState>({
  created_by: false, // Hidden by default
});

// In render, add column visibility dropdown
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline" size="sm">
      <ColumnsIcon className="h-4 w-4 mr-2" />
      Columns
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    {table.getAllColumns()
      .filter(col => col.getCanHide())
      .map(col => (
        <DropdownMenuCheckboxItem
          key={col.id}
          checked={col.getIsVisible()}
          onCheckedChange={col.getToggleVisibilityHandler()}
        >
          {col.id}
        </DropdownMenuCheckboxItem>
      ))}
  </DropdownMenuContent>
</DropdownMenu>
```

3. Implement pagination (server-side via query params)

4. Implement sorting (server-side)

5. Add row selection for bulk actions

6. Create ProjectRowActions dropdown:
   - View
   - Edit
   - Clone
   - Archive
   - Delete (if permitted)
  </action>
  <verify>
Component renders without errors in Storybook or test page.
Columns sort correctly.
Column visibility toggle works.
  </verify>
</task>

<task type="auto">
  <name>Task 2: Create ProjectFilters component</name>
  <files>apps/web/src/components/project/ProjectFilters.tsx</files>
  <action>
Create apps/web/src/components/project/ProjectFilters.tsx:

1. View toggle (My Projects / Team Projects / All Projects):
```typescript
interface ProjectFiltersProps {
  filter: ProjectFilter;
  onFilterChange: (filter: ProjectFilter) => void;
}

export function ProjectFilters({ filter, onFilterChange }: ProjectFiltersProps) {
  return (
    <div className="flex items-center gap-4 mb-4">
      {/* View toggle */}
      <div className="flex rounded-md border">
        <button
          className={cn("px-3 py-1", filter.view === 'my' && 'bg-gray-100')}
          onClick={() => onFilterChange({ ...filter, view: 'my' })}
        >
          My Projects
        </button>
        <button
          className={cn("px-3 py-1", filter.view === 'team' && 'bg-gray-100')}
          onClick={() => onFilterChange({ ...filter, view: 'team' })}
        >
          Team
        </button>
        <button
          className={cn("px-3 py-1", filter.view === 'all' && 'bg-gray-100')}
          onClick={() => onFilterChange({ ...filter, view: 'all' })}
        >
          All
        </button>
      </div>
      
      {/* Search */}
      <div className="relative flex-1 max-w-sm">
        <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
        <input
          type="text"
          placeholder="Search projects..."
          value={filter.search ?? ''}
          onChange={(e) => onFilterChange({ ...filter, search: e.target.value })}
          className="pl-10 pr-4 py-2 border rounded-md w-full"
        />
      </div>
      
      {/* Status filter */}
      <Select
        value={filter.status ?? 'all'}
        onValueChange={(v) => onFilterChange({ ...filter, status: v === 'all' ? undefined : v })}
      >
        <SelectTrigger className="w-32">
          <SelectValue placeholder="Status" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">All Status</SelectItem>
          <SelectItem value="draft">Draft</SelectItem>
          <SelectItem value="active">Active</SelectItem>
          <SelectItem value="paused">Paused</SelectItem>
          <SelectItem value="completed">Completed</SelectItem>
          <SelectItem value="archived">Archived</SelectItem>
        </SelectContent>
      </Select>
      
      {/* Type filter */}
      <ProjectTypeSelect
        value={filter.project_type_id}
        onChange={(v) => onFilterChange({ ...filter, project_type_id: v })}
      />
      
      {/* Saved filters dropdown - placeholder for now */}
    </div>
  );
}
```

2. Use URL search params to persist filters:
```typescript
const [searchParams, setSearchParams] = useSearchParams();
const filter = useMemo(() => ({
  view: searchParams.get('view') ?? 'all',
  status: searchParams.get('status'),
  search: searchParams.get('search'),
  // etc.
}), [searchParams]);
```
  </action>
  <verify>
Filters update URL params.
Search works with debounce.
Status and type filters work.
  </verify>
</task>

<task type="auto">
  <name>Task 3: Create ProjectsPage with bulk actions</name>
  <files>apps/web/src/pages/ProjectsPage.tsx, apps/web/src/components/project/BulkActions.tsx</files>
  <action>
1. Create apps/web/src/components/project/BulkActions.tsx:

```typescript
interface BulkActionsProps {
  selectedIds: string[];
  onClearSelection: () => void;
}

export function BulkActions({ selectedIds, onClearSelection }: BulkActionsProps) {
  const deleteProjects = useDeleteProjects();
  const updateStatus = useBulkUpdateStatus();
  
  if (selectedIds.length === 0) return null;
  
  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white shadow-lg rounded-lg border p-4 flex items-center gap-4">
      <span className="text-sm font-medium">{selectedIds.length} selected</span>
      
      <Select onValueChange={(status) => updateStatus.mutate({ ids: selectedIds, status })}>
        <SelectTrigger className="w-40">
          <SelectValue placeholder="Change status" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="archived">Archive</SelectItem>
          <SelectItem value="paused">Pause</SelectItem>
        </SelectContent>
      </Select>
      
      <Button
        variant="destructive"
        size="sm"
        onClick={() => {
          if (confirm(`Delete ${selectedIds.length} projects?`)) {
            deleteProjects.mutate(selectedIds);
            onClearSelection();
          }
        }}
      >
        Delete
      </Button>
      
      <Button variant="ghost" size="sm" onClick={onClearSelection}>
        Cancel
      </Button>
    </div>
  );
}
```

2. Create apps/web/src/pages/ProjectsPage.tsx:

```typescript
export function ProjectsPage() {
  const [filter, setFilter] = useState<ProjectFilter>({ view: 'all' });
  const { data: projects, isLoading } = useProjects(filter);
  const [rowSelection, setRowSelection] = useState<RowSelectionState>({});
  
  const selectedIds = Object.keys(rowSelection).filter(k => rowSelection[k]);
  
  return (
    <div className="container py-6">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold">Projects</h1>
        <Button asChild>
          <Link to="/projects/new">
            <PlusIcon className="h-4 w-4 mr-2" />
            New Project
          </Link>
        </Button>
      </div>
      
      <ProjectFilters filter={filter} onFilterChange={setFilter} />
      
      {isLoading ? (
        <TableSkeleton />
      ) : (
        <ProjectTable
          projects={projects ?? []}
          rowSelection={rowSelection}
          onRowSelectionChange={setRowSelection}
        />
      )}
      
      <BulkActions
        selectedIds={selectedIds}
        onClearSelection={() => setRowSelection({})}
      />
    </div>
  );
}
```

3. Add route in app router:
```typescript
{ path: '/projects', element: <ProjectsPage /> }
```
  </action>
  <verify>
Navigate to /projects - page renders.
Create a project, verify it appears in list.
Bulk select and archive works.
Filters update URL and results.
  </verify>
</task>

</tasks>

<verification>
1. /projects page renders with table
2. All columns display correctly
3. Sorting works on each sortable column
4. Filters update results
5. Bulk actions appear when rows selected
6. Row actions dropdown works
7. Column visibility toggle works
</verification>

<success_criteria>
- Table renders projects with TanStack Table
- Columns: name, status, type, tasks, progress, created, owner, actions
- View toggle: My/Team/All
- Search with full-text
- Status and type filters
- Bulk archive and delete
- Column visibility configurable
- Responsive and performant
</success_criteria>
