---
phase: 05-project-management
plan: 15
type: execute
wave: 2
depends_on: ["05-14"]
files_modified:
  - apps/api/src/routes/data_sources.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Data sources can be listed via GET /api/v1/projects/{id}/data-sources"
    - "Data sources can be fetched via GET /api/v1/projects/{id}/data-sources/{ds_id}"
    - "Data sources can be created via POST /api/v1/projects/{id}/data-sources"
    - "Data sources can be updated via PUT /api/v1/projects/{id}/data-sources/{ds_id}"
    - "Data sources can be deleted via DELETE /api/v1/projects/{id}/data-sources/{ds_id}"
  artifacts:
    - path: "apps/api/src/routes/data_sources.rs"
      provides: "DataSource CRUD API endpoints"
      contains: "PgDataSourceRepository::new"
  key_links:
    - from: "apps/api/src/routes/data_sources.rs"
      to: "libs/db/src/repo/pg_data_source.rs"
      via: "Extension<PgPool> -> PgDataSourceRepository"
      pattern: "PgDataSourceRepository::new\\(pool\\)"
---

<objective>
Wire DataSource API routes to PgDataSourceRepository.

Purpose: Routes are stubs returning placeholders. Repository created in 05-14 provides the data layer.
Output: Working DataSource CRUD endpoints.
</objective>

<context>
Reference files:
- libs/db/src/repo/pg_data_source.rs (repository from 05-14)
- apps/api/src/routes/data_sources.rs (routes to wire)
- apps/api/src/routes/projects.rs (pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire list and get data source routes</name>
  <files>apps/api/src/routes/data_sources.rs</files>
  <action>
1. Add imports for repository and domain types
2. Add From impl for DataSourceResponse
3. Wire list_data_sources:
   - Add Extension(pool) parameter
   - Verify project exists
   - Call repo.list() with filter
4. Wire get_data_source:
   - Add Extension(pool) parameter
   - Call repo.find_by_id()
5. Add helper functions for parsing source types and validation modes
  </action>
  <verify>Run `cargo check -p glyph-api` - no errors</verify>
  <done>list and get data source endpoints return real data</done>
</task>

<task type="auto">
  <name>Task 2: Wire create, update, delete data source routes</name>
  <files>apps/api/src/routes/data_sources.rs</files>
  <action>
1. Wire create_data_source:
   - Verify project exists
   - Parse source type and config
   - Build CreateDataSource
   - Call repo.create()
   - Return 201

2. Wire update_data_source:
   - Build UpdateDataSource
   - Call repo.update()

3. Wire delete_data_source:
   - Call repo.delete()
   - Return 204

4. Add config parsing helper for all source types (FileUpload, S3, GCS, AzureBlob, Api)

5. Wire test_connection (stub for now - needs StorageService):
   - Return success for file_upload
   - Return "not implemented" for cloud sources
  </action>
  <verify>
    Run `cargo check -p glyph-api` - no errors
    Run `cargo test -p glyph-api` - all tests pass
  </verify>
  <done>
    All DataSource CRUD endpoints work:
    - POST creates and returns 201
    - GET /{id} returns data source or 404
    - PUT /{id} updates and returns updated
    - DELETE /{id} returns 204
    - test_connection returns appropriate response
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p glyph-api` compiles
2. Create project, then:
   - POST data source -> 201
   - GET data sources -> includes created
   - GET data source by ID -> returns it
   - PUT data source -> updated
   - DELETE data source -> 204
</verification>

<success_criteria>
- All DataSource routes wired to PgDataSourceRepository
- Data persists to PostgreSQL
- Error handling maps repository errors to HTTP codes
- Config parsing handles all source types
</success_criteria>

<output>
After completion, create `.planning/phases/05-project-management/05-15-SUMMARY.md`
</output>
