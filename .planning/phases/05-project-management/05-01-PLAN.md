---
phase: 05-project-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - libs/db/Cargo.toml
  - migrations/0011_project_types.sql
  - migrations/0012_data_sources.sql
autonomous: true

must_haves:
  truths:
    - "jsonschema crate available in workspace"
    - "object_store crate available in workspace"
    - "project_types table exists with schema columns"
    - "data_sources table exists with cloud config"
    - "projects table has project_type_id foreign key"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace dependencies for schema validation and cloud storage"
      contains: "jsonschema"
    - path: "migrations/0011_project_types.sql"
      provides: "Project types table"
      contains: "CREATE TABLE project_types"
    - path: "migrations/0012_data_sources.sql"
      provides: "Data sources table"
      contains: "CREATE TABLE data_sources"
---

<objective>
Add required Rust dependencies and database schema for project types and data sources.

Purpose: Establish foundation for project management - JSON Schema validation crates and database tables for project types, skill requirements, and data source configurations.

Output: Updated Cargo.toml with jsonschema/object_store, two new migration files for project_types and data_sources tables.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-project-management/05-CONTEXT.md
@.planning/phases/05-project-management/05-RESEARCH.md
@Cargo.toml
@migrations/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Rust workspace dependencies</name>
  <files>Cargo.toml, libs/db/Cargo.toml</files>
  <action>
Add to [workspace.dependencies] in root Cargo.toml:
- jsonschema = "0.26" (for JSON Schema validation)
- object_store = { version = "0.11", features = ["aws", "gcp", "azure"] }

Add to libs/db/Cargo.toml dependencies:
- jsonschema.workspace = true
  </action>
  <verify>
Run `cargo check -p glyph-db` - should compile without errors.
Verify jsonschema and object_store appear in Cargo.lock.
  </verify>
</task>

<task type="auto">
  <name>Task 2: Create project_types migration</name>
  <files>migrations/0011_project_types.sql</files>
  <action>
Create migration that:

1. Creates project_types table:
   - project_type_id UUID PRIMARY KEY
   - name VARCHAR(255) NOT NULL UNIQUE
   - description TEXT
   - input_schema JSONB NOT NULL DEFAULT '{}'
   - output_schema JSONB NOT NULL DEFAULT '{}'
   - estimated_duration_seconds INTEGER
   - difficulty_level VARCHAR(50)
   - is_system BOOLEAN NOT NULL DEFAULT false
   - created_by UUID REFERENCES users(user_id)
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

2. Creates project_type_skill_requirements junction table:
   - project_type_id UUID REFERENCES project_types ON DELETE CASCADE
   - skill_id VARCHAR(100) NOT NULL
   - min_proficiency VARCHAR(50) NOT NULL DEFAULT 'intermediate'
   - is_required BOOLEAN NOT NULL DEFAULT true
   - weight REAL DEFAULT 1.0
   - PRIMARY KEY (project_type_id, skill_id)

3. Adds project_type_id column to projects table:
   - ALTER TABLE projects ADD COLUMN project_type_id UUID REFERENCES project_types(project_type_id)

4. Creates appropriate indexes
5. Adds updated_at trigger
  </action>
  <verify>
Run `sqlx migrate run` - migration applies successfully.
  </verify>
</task>

<task type="auto">
  <name>Task 3: Create data_sources migration</name>
  <files>migrations/0012_data_sources.sql</files>
  <action>
Create migration that:

1. Creates data_source_type enum:
   'file_upload', 's3', 'gcs', 'azure_blob', 'api'

2. Creates validation_mode enum:
   'strict', 'lenient'

3. Creates data_sources table:
   - data_source_id UUID PRIMARY KEY
   - project_id UUID NOT NULL REFERENCES projects ON DELETE CASCADE
   - name VARCHAR(255) NOT NULL
   - source_type data_source_type NOT NULL
   - config JSONB NOT NULL DEFAULT '{}'
   - validation_mode validation_mode NOT NULL DEFAULT 'strict'
   - last_sync_at TIMESTAMPTZ
   - item_count INTEGER DEFAULT 0
   - error_count INTEGER DEFAULT 0
   - is_active BOOLEAN NOT NULL DEFAULT true
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - UNIQUE(project_id, name)

4. Creates data_source_credentials table:
   - credential_id UUID PRIMARY KEY
   - data_source_id UUID NOT NULL REFERENCES data_sources ON DELETE CASCADE
   - credential_type VARCHAR(50) NOT NULL
   - encrypted_value BYTEA NOT NULL
   - created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
   - updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()

5. Creates indexes and triggers
  </action>
  <verify>
Run `sqlx migrate run` - migration applies.
Check tables exist with `\d data_sources` and `\d data_source_credentials`.
  </verify>
</task>

</tasks>

<verification>
1. All migrations run: `sqlx migrate run`
2. Cargo workspace compiles: `cargo check`
3. Tables visible in database schema
4. Foreign keys working correctly
</verification>

<success_criteria>
- jsonschema and object_store in Cargo.lock
- project_types table with input_schema, output_schema
- project_type_skill_requirements junction table
- data_sources and data_source_credentials tables
- projects.project_type_id column exists
</success_criteria>
