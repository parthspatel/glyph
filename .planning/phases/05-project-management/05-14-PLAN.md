---
phase: 05-project-management
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/db/src/repo/pg_data_source.rs
  - libs/db/src/repo/mod.rs
  - libs/db/src/repo/errors.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "DataSource repository exists with CRUD operations"
    - "Repository handles DataSourceType enum mapping"
    - "Repository handles ValidationMode enum mapping"
  artifacts:
    - path: "libs/db/src/repo/pg_data_source.rs"
      provides: "PgDataSourceRepository with CRUD"
      exports: ["PgDataSourceRepository", "DataSourceRepository"]
      min_lines: 200
    - path: "libs/db/src/repo/errors.rs"
      provides: "DataSource error types"
      contains: "CreateDataSourceError"
  key_links:
    - from: "libs/db/src/repo/pg_data_source.rs"
      to: "migrations/0012_data_sources.sql"
      via: "SQL queries matching table schema"
      pattern: "FROM data_sources"
---

<objective>
Create PgDataSourceRepository implementing DataSource CRUD operations.

Purpose: Domain entity and migration exist but no repository implementation. This gap provides the data access layer.
Output: Working repository matching existing patterns from PgProjectRepository and PgProjectTypeRepository.
</objective>

<context>
Reference files:
- libs/domain/src/data_source.rs (domain types)
- migrations/0012_data_sources.sql (table schema)
- libs/db/src/repo/pg_project.rs (pattern reference)
- libs/db/src/repo/pg_project_type.rs (pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DataSource error types to errors.rs</name>
  <files>libs/db/src/repo/errors.rs</files>
  <action>
Add DataSource repository error types following existing patterns:
- CreateDataSourceError (NameExists, ProjectNotFound, Database)
- FindDataSourceError (Database)
- UpdateDataSourceError (NotFound, NameExists, Database)
- DeleteDataSourceError (NotFound, Database)
  </action>
  <verify>Run `cargo check -p glyph-db` - no errors</verify>
  <done>DataSource error types defined in errors.rs</done>
</task>

<task type="auto">
  <name>Task 2: Create PgDataSourceRepository implementation</name>
  <files>libs/db/src/repo/pg_data_source.rs, libs/db/src/repo/mod.rs</files>
  <action>
1. Create libs/db/src/repo/pg_data_source.rs with:
   - DataSourceRepository trait
   - DataSourceRow struct for SQLx
   - PgDataSourceRepository struct with pool
   - Implementation of all CRUD methods:
     - create() with unique name constraint per project
     - find_by_id() with optional result
     - list() with project scope and filters
     - update() with partial updates
     - delete() with existence check
     - update_sync_stats() for sync tracking
   - Helper functions for enum parsing/formatting

2. Update libs/db/src/repo/mod.rs:
   - Add `pub mod pg_data_source;`
   - Add `pub use pg_data_source::*;`
  </action>
  <verify>
    Run `cargo check -p glyph-db` - no errors
    Run `cargo test -p glyph-db` - all tests pass
  </verify>
  <done>
    PgDataSourceRepository implemented with:
    - create() with unique name constraint per project
    - find_by_id() with optional result
    - list() with project scope and filters
    - update() with partial updates
    - delete() with existence check
    - update_sync_stats() for sync tracking
  </done>
</task>

</tasks>

<verification>
1. `cargo build -p glyph-db` compiles
2. Repository methods follow existing patterns from pg_project.rs
3. Enum mappings work for DataSourceType and ValidationMode
</verification>

<success_criteria>
- PgDataSourceRepository exists with trait + implementation
- Error types defined in errors.rs
- Module exported from mod.rs
- Compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-project-management/05-14-SUMMARY.md`
</output>
